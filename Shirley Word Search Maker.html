<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Shirley'sè‡ªå®šç¾©å–®å­—æœå°‹Word SearchéŠæˆ²ç”Ÿæˆå™¨">
    <title>Shirley'sè‡ªå®šç¾©å–®å­—æœå°‹éŠæˆ²</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #64B5F6;
            --primary-dark: #42a5f5;
            --primary-light: #90caf9;
            --secondary-color: #2c3e50;
            --light-bg: #f5f7fa;
            --card-bg: #f8f9fa;
            --success-color: #2e7d32;
            --error-color: #c62828;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px;
            min-height: 100vh;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: clamp(15px, 3vw, 25px);
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #eaeaea;
        }
        
        h1 {
            color: var(--secondary-color);
            margin-bottom: 8px;
            font-size: clamp(1.5rem, 4vw, 1.8rem);
        }
        
        .instructions {
            color: #7f8c8d;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .game-settings {
            background: var(--card-bg);
            padding: clamp(12px, 2vw, 18px);
            border-radius: 8px;
            margin: 15px auto;
            max-width: 800px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .game-settings h3 {
            margin-bottom: 12px;
            color: var(--secondary-color);
            text-align: center;
            font-size: clamp(1rem, 3vw, 1.2rem);
        }
        
        .settings-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }
        
        .difficulty-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .difficulty-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }
        
        .difficulty-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .word-input-container {
            flex: 1;
            min-width: min(300px, 100%);
        }
        
        .word-input-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }
        
        .word-input-container textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
            resize: vertical;
            min-height: 80px;
        }
        
        .word-input-info {
            font-size: clamp(0.75rem, 2vw, 0.85rem);
            color: #666;
            margin-top: 5px;
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        
        .grid-container {
            flex: 1;
            min-width: min(300px, 100%);
            max-width: 550px;
            overflow: auto;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.1);
        }
        
        .word-grid {
            display: grid;
            gap: 2px;
            background-color: #bdc3c7;
            border: 2px solid #7f8c8d;
            margin: 0 auto;
            max-width: 100%;
        }
        
        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            font-family: "Times New Roman", serif;
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .cell.selected {
            background-color: #A5D6A7;
        }
        
        .cell.found {
            background-color: #4FC3F7;
            color: #01579B;
            font-weight: bold;
        }
        
        .word-list-container {
            flex: 1;
            min-width: min(280px, 100%);
            max-width: 380px;
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .word-list-title {
            margin-bottom: 12px;
            color: var(--secondary-color);
            font-size: clamp(1rem, 3vw, 1.3rem);
            text-align: center;
        }
        
        .word-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            padding: 8px;
        }
        
        .word-item {
            padding: 8px 10px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            font-size: clamp(0.8rem, 2vw, 0.95rem);
        }
        
        .word-item.found {
            background: linear-gradient(135deg, #b3e5fc 0%, #81d4fa 100%);
            color: #01579B;
        }
        
        .controls {
            text-align: center;
            margin-top: 16px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
            white-space: nowrap;
            transition: background 0.2s, transform 0.2s;
            flex: 1;
            min-width: 120px;
        }
        
        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: var(--primary-light);
            cursor: not-allowed;
            transform: none;
        }
        
        .stats {
            text-align: center;
            margin-top: 12px;
            color: #1565C0;
            font-weight: bold;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }
        
        .alert-error {
            background: #ffebee;
            color: var(--error-color);
            border: 1px solid #ef9a9a;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: var(--success-color);
            border: 1px solid #a5d6a7;
        }
        
        /* å­¸ç”Ÿè³‡è¨Šå½ˆçª—æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .student-info-modal {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .student-info-modal h3 {
            margin-bottom: 15px;
            color: var(--secondary-color);
            text-align: center;
            font-size: 1.3rem;
        }
        
        .info-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .info-input {
            width: 100%;
        }
        
        .info-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
        }
        
        .info-input input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .modal-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-controls button {
            flex: 1;
        }
        
        /* PDF å ±å‘Šæ¨£å¼ */
        .pdf-page {
            width: 800px;
            background: white;
            padding: 20px;
            font-family: Arial, sans-serif;
            margin-bottom: 20px;
        }
        
        .pdf-page .word-grid {
            gap: 2px;
            border: 2px solid #7f8c8d;
        }
        
        .pdf-page .cell {
            font-size: 14px;
        }
        
        .pdf-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .pdf-student-info, .pdf-game-info {
            flex: 1;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        
        .pdf-student-info {
            margin-right: 10px;
        }
        
        .pdf-game-info {
            margin-left: 10px;
        }
        
        .pdf-completion {
            margin: 15px 0;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .pdf-word-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .pdf-word-item {
            padding: 6px 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .pdf-word-found {
            background: #b3e5fc;
            color: #01579B;
        }
        
        .pdf-word-notfound {
            background: #f5f5f5;
            color: #666;
        }
        
        .pdf-section-title {
            font-weight: bold;
            margin: 15px 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .grid-container, .word-list-container {
                max-width: 100%;
            }
            
            .settings-form {
                flex-direction: column;
            }
            
            .difficulty-selector {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .modal-overlay {
                padding: 10px;
            }
            
            .student-info-modal {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 12px;
            }
            
            .word-list {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            }
            
            .pdf-header {
                flex-direction: column;
            }
            
            .pdf-student-info, .pdf-game-info {
                margin: 0 0 10px 0;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #printSheet, #printSheet * {
                visibility: visible;
            }
            #printSheet {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .print-controls {
                display: none;
            }
            .print-preview {
                box-shadow: none;
                padding: 0;
            }
            .cards-container {
                gap: 10px;
            }
            .print-card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Shirley's Word Search Maker å°‹å­—éŠæˆ²ç”Ÿæˆå™¨</h1>
            <p class="instructions">è¼¸å…¥å–®å­—ï¼Œé¸æ“‡é›£åº¦ï¼Œç”Ÿæˆå°ˆå±¬å–®å­—æœå°‹éŠæˆ²ã€‚å³åˆ»é–‹å•Ÿåœ¨ç·šå°‹å¯¶ä¹‹æ—…ï¼Œä¸¦å¯ä¸‹è¼‰å°‹å¯¶å ±å‘Šï¼</p>
        </header>
        
        <div class="game-settings">
            <h3>éŠæˆ²è¨­å®š</h3>
            <div class="settings-form">
                <div class="difficulty-selector">
                    <div class="difficulty-btn active" data-level="easy">åˆç´š (9Ã—9)</div>
                    <div class="difficulty-btn" data-level="medium">ä¸­ç´š (11Ã—11)</div>
                    <div class="difficulty-btn" data-level="hard">é«˜ç´š (15Ã—15)</div>
                </div>
                
                <div class="word-input-container">
                    <label for="word-input">è¼¸å…¥å–®å­— (æ¯è¡Œä¸€å€‹ï¼Œç”¨é€—è™Ÿæˆ–ç©ºæ ¼åˆ†éš”)</label>
                    <textarea id="word-input" placeholder="ä¾‹å¦‚ï¼š
apple
banana
cherry
..."></textarea>
                    <div class="word-input-info">
                        <span id="word-count">0</span> å€‹å–®å­— | æœ€é•·å–®å­—: <span id="max-length">0</span> å­—æ¯
                    </div>
                </div>
                
                <button id="generate-btn">ç”Ÿæˆå–®å­—æœå°‹</button>
            </div>
        </div>
        
        <div id="alert-area"></div>
        
        <div class="game-area">
            <div class="grid-container">
                <div class="word-grid" id="word-grid"></div>
            </div>
            
            <div class="word-list-container">
                <h3 class="word-list-title">ç›®æ¨™å–®å­— (<span id="total-count">0</span>å€‹)</h3>
                <div class="word-list" id="word-list"></div>
                <div class="stats">
                    å·²æ‰¾åˆ°: <span id="found-count">0</span> / <span id="total-count2">0</span>
                </div>
                <div class="controls">
                    <button id="reset-btn">é‡ç½®éŠæˆ²</button>
                    <button id="download-pdf-btn">ä¸‹è¼‰PDFå ±å‘Š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿè³‡è¨Šå½ˆçª— -->
    <div id="student-info-modal" class="modal-overlay" style="display: none;">
        <div class="student-info-modal">
            <h3>è«‹è¼¸å…¥å­¸ç”Ÿè³‡è¨Š</h3>
            <div class="info-form">
                <div class="info-input">
                    <label for="class-input">ç­ç´š (Class)</label>
                    <input type="text" id="class-input" placeholder="">
                </div>
                <div class="info-input">
                    <label for="seat-input">åº§è™Ÿ (Seat No.)</label>
                    <input type="text" id="seat-input" placeholder="">
                </div>
                <div class="info-input">
                    <label for="name-input">å§“å (Name)</label>
                    <input type="text" id="name-input" placeholder="" required>
                </div>
            </div>
            <div class="modal-controls">
                <button id="cancel-btn">å–æ¶ˆ</button>
                <button id="confirm-btn">ç¢ºèªä¸¦ä¸‹è¼‰PDF</button>
            </div>
        </div>
    </div>

    <!-- PDF å ±å‘Šæ¨¡æ¿ - ç¬¬ä¸€é  -->
    <div id="pdf-report-page1" class="pdf-page" style="display: none;">
        <h2 style="text-align:center; color:#2c3e50;"><span id="pdf-student-name">å­¸ç”Ÿå§“å</span>'s Self-designed Word Search å ±å‘Š</h2>
        
        <!-- å€‹äººè³‡è¨Šå’ŒéŠæˆ²æ™‚é–“è³‡è¨Šä¸¦æ’é¡¯ç¤º -->
        <div class="pdf-header">
            <div class="pdf-student-info">
                <div style="font-weight:bold; margin-bottom:8px;">å­¸ç”Ÿè³‡è¨Š</div>
                <div>ç­ç´š: <span id="pdf-class"></span></div>
                <div>åº§è™Ÿ: <span id="pdf-seat"></span></div>
                <div>å§“å: <span id="pdf-name"></span></div>
            </div>
            <div class="pdf-game-info">
                <div style="font-weight:bold; margin-bottom:8px;">éŠæˆ²æ™‚é–“</div>
                <div>é–‹å§‹æ™‚é–“: <span id="pdf-start-time"></span></div>
                <div>å ±å‘Šæ™‚é–“: <span id="pdf-end-time"></span></div>
                <div>éŠæˆ²ç”¨æ™‚: <span id="pdf-duration"></span></div>
            </div>
        </div>
        
        <div style="margin:20px 0;">
            <div style="font-weight:bold; margin-bottom:8px;">å–®å­—ç¶²æ ¼ (å·²æ‰¾åˆ°éƒ¨åˆ†é«˜äº®):</div>
            <div class="word-grid" id="pdf-grid"></div>
        </div>
        
        <!-- å®Œæˆæƒ…æ³ -->
        <div class="pdf-completion">
            å®Œæˆæƒ…æ³: <span id="pdf-completion"></span>
        </div>
        
        <div style="margin-top:20px; font-size:0.9rem; color:#666;">
            å‚™è¨»ï¼šè—è‰²æ ¼å­è¡¨ç¤ºå·²æ‰¾åˆ°çš„å–®å­—å­—æ¯ã€‚
        </div>
    </div>

    <!-- PDF å ±å‘Šæ¨¡æ¿ - ç¬¬äºŒé  (å–®å­—åˆ—è¡¨) -->
    <div id="pdf-report-page2" class="pdf-page" style="display: none;">
        <h2 style="text-align:center; color:#2c3e50;">Word Search å–®å­—åˆ—è¡¨</h2>
        
        <div class="pdf-section-title">æ‰€æœ‰å–®å­—ç‹€æ…‹</div>
        <div class="pdf-word-list" id="pdf-all-words"></div>
        
        <div style="margin-top:20px; font-size:0.9rem; color:#666;">
            å‚™è¨»ï¼šè—è‰²èƒŒæ™¯è¡¨ç¤ºå·²æ‰¾åˆ°çš„å–®å­—ï¼Œç°è‰²èƒŒæ™¯è¡¨ç¤ºæœªæ‰¾åˆ°çš„å–®å­—ã€‚
        </div>
        
        <div style="margin-top:30px; padding:10px; background:#f9f9f9; border-radius:5px;">
            <div style="font-weight:bold; margin-bottom:5px;">å­¸ç¿’å»ºè­°ï¼š</div>
            <div>1. è¤‡ç¿’å·²æ‰¾åˆ°çš„å–®å­—ï¼Œç¢ºä¿ç†è§£å…¶å«ç¾©å’Œç”¨æ³•</div>
            <div>2. é‡å°æœªæ‰¾åˆ°çš„å–®å­—ï¼Œå¯ä»¥æŸ¥é–±å­—å…¸æˆ–è«‹æ•™è€å¸«</div>
            <div>3. å˜—è©¦ç”¨é€™äº›å–®å­—é€ å¥ï¼ŒåŠ æ·±è¨˜æ†¶</div>
        </div>
    </div>

    <script>
        // éŠæˆ²é…ç½®
        const DIFFICULTY_LEVELS = {
            easy: { size: 9, maxWordLength: 9, maxWords: 10 },
            medium: { size: 11, maxWordLength: 11, maxWords: 15 },
            hard: { size: 15, maxWordLength: 15, maxWords: 20 }
        };

        const DIRECTIONS = [
            [0, 1],   // right
            [1, 0],   // down
            [1, 1],   // down-right
            [1, -1],  // down-left
            [0, -1],  // left
            [-1, 0],  // up
            [-1, -1], // up-left
            [-1, 1]   // up-right
        ];

        // éŠæˆ²ç‹€æ…‹
        let gameState = {
            difficulty: 'easy',
            gridSize: DIFFICULTY_LEVELS.easy.size,
            wordList: [],
            grid: [],
            foundWords: new Set(),
            isSelecting: false,
            startCell: null,
            currentSelection: [],
            startTime: new Date(),
            studentInfo: {
                class: '',
                seat: '',
                name: ''
            },
            wordPositions: {}
        };

        // ======================
        // å·¥å…·å‡½æ•¸
        // ======================
        function getPageXY(event) {
            if (event.type.startsWith('touch')) {
                const touch = event.changedTouches[0];
                return { x: touch.clientX, y: touch.clientY };
            } else {
                return { x: event.clientX, y: event.clientY };
            }
        }

        function getCellFromPoint(x, y, rect, gridSize) {
            const col = Math.floor((x - rect.left) / (rect.width / gridSize));
            const row = Math.floor((y - rect.top) / (rect.height / gridSize));
            if (row >= 0 && row < gridSize && col >= 0 && col < gridSize) {
                return { row, col };
            }
            return null;
        }

        function getRandomLetter() {
            const s = 'aaaaaaaaaabbcccddeeeeeeeeeeeeffgghhiiiiiiijkllllmmnnnnnnooooooooppqrrrrrrssssssttttttttuuuuvvwxyyz';
            return s[Math.floor(Math.random() * s.length)];
        }

        function canPlaceWord(word, row, col, dir, gridSize) {
            const [dr, dc] = dir;
            for (let i = 0; i < word.length; i++) {
                const r = row + dr * i;
                const c = col + dc * i;
                if (r < 0 || r >= gridSize || c < 0 || c >= gridSize) return false;
                if (gameState.grid[r][c] !== '' && gameState.grid[r][c] !== word[i]) return false;
            }
            return true;
        }

        function placeWord(word, row, col, dir) {
            const [dr, dc] = dir;
            for (let i = 0; i < word.length; i++) {
                gameState.grid[row + dr * i][col + dc * i] = word[i];
            }
        }

        // âœ… ä¿®æ­£å¾Œï¼šæ­£ç¢ºæ”¯æ´å°è§’ç·šé¸å–
        function getBestPath(start, current, gridSize) {
            const dy = current.row - start.row;
            const dx = current.col - start.col;

            if (dy === 0 && dx === 0) {
                return [start];
            }

            let bestDir = DIRECTIONS[0];
            let bestDot = -Infinity;

            for (const dir of DIRECTIONS) {
                const dot = dy * dir[0] + dx * dir[1];
                if (dot > bestDot) {
                    bestDot = dot;
                    bestDir = dir;
                }
            }

            const path = [];
            let r = start.row;
            let c = start.col;
            const maxLen = Math.max(Math.abs(dy), Math.abs(dx)) + 1;

            for (let i = 0; i < maxLen; i++) {
                if (r < 0 || r >= gridSize || c < 0 || c >= gridSize) break;
                path.push({ row: r, col: c });
                r += bestDir[0];
                c += bestDir[1];
            }

            return path;
        }

        // ======================
        // é›£åº¦é¸æ“‡å’Œå–®å­—è¼¸å…¥è™•ç†
        // ======================
        function setupDifficultySelector() {
            const difficultyBtns = document.querySelectorAll('.difficulty-btn');
            difficultyBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    difficultyBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.difficulty = btn.dataset.level;
                    gameState.gridSize = DIFFICULTY_LEVELS[gameState.difficulty].size;
                    updateWordInputInfo();
                });
            });
        }

        function setupWordInput() {
            const wordInput = document.getElementById('word-input');
            wordInput.addEventListener('input', updateWordInputInfo);
        }

        function updateWordInputInfo() {
            const wordInput = document.getElementById('word-input');
            const words = parseWords(wordInput.value);
            
            const wordCount = words.length;
            const maxLength = words.length > 0 ? Math.max(...words.map(w => w.length)) : 0;
            
            document.getElementById('word-count').textContent = wordCount;
            document.getElementById('max-length').textContent = maxLength;
            
            // æª¢æŸ¥æ˜¯å¦è¶…éé™åˆ¶
            const level = DIFFICULTY_LEVELS[gameState.difficulty];
            const wordCountValid = wordCount <= level.maxWords;
            const wordLengthValid = maxLength <= level.maxWordLength;
            
            // æ›´æ–°ç”ŸæˆæŒ‰éˆ•ç‹€æ…‹
            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = !(wordCount > 0 && wordCountValid && wordLengthValid);
            
            // é¡¯ç¤ºè­¦å‘Š
            const alertArea = document.getElementById('alert-area');
            alertArea.innerHTML = '';
            
            if (wordCount === 0) {
                // æ²’æœ‰å–®å­—æ™‚ä¸é¡¯ç¤ºè­¦å‘Š
                return;
            }
            
            if (!wordCountValid) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-error';
                alert.textContent = `å–®å­—æ•¸é‡è¶…éé™åˆ¶ï¼ç›®å‰é›£åº¦æœ€å¤šå…è¨± ${level.maxWords} å€‹å–®å­—ï¼Œæ‚¨è¼¸å…¥äº† ${wordCount} å€‹ã€‚`;
                alertArea.appendChild(alert);
            }
            
            if (!wordLengthValid) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-error';
                alert.textContent = `å–®å­—é•·åº¦è¶…éé™åˆ¶ï¼ç›®å‰é›£åº¦æœ€é•·å–®å­—ç‚º ${level.maxWordLength} å€‹å­—æ¯ï¼Œæ‚¨çš„æœ€é•·å–®å­—æœ‰ ${maxLength} å€‹å­—æ¯ã€‚`;
                alertArea.appendChild(alert);
            }
            
            if (wordCountValid && wordLengthValid) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.textContent = `å–®å­—è¼¸å…¥æœ‰æ•ˆï¼å¯ä»¥ç”Ÿæˆ ${gameState.difficulty} é›£åº¦çš„å–®å­—æœå°‹éŠæˆ²ã€‚`;
                alertArea.appendChild(alert);
            }
        }

        function parseWords(input) {
            if (!input.trim()) return [];
            
            // æ”¯æ´å¤šç¨®åˆ†éš”ç¬¦ï¼šæ›è¡Œã€é€—è™Ÿã€ç©ºæ ¼
            const words = input
                .split(/[\n,]+/)
                .map(word => word.trim().toLowerCase())
                .filter(word => word.length > 0)
                .filter((word, index, self) => self.indexOf(word) === index); // å»é™¤é‡è¤‡
            
            return words;
        }

        // ======================
        // éŠæˆ²é‚è¼¯
        // ======================
        function initGame() {
            setupDifficultySelector();
            setupWordInput();
            setupEventListeners();
            updateWordInputInfo();
        }

        function generateWordSearch() {
            const wordInput = document.getElementById('word-input');
            const words = parseWords(wordInput.value);
            
            if (words.length === 0) {
                alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹å–®å­—ï¼');
                return;
            }
            
            const level = DIFFICULTY_LEVELS[gameState.difficulty];
            if (words.length > level.maxWords) {
                alert(`å–®å­—æ•¸é‡è¶…éé™åˆ¶ï¼ç›®å‰é›£åº¦æœ€å¤šå…è¨± ${level.maxWords} å€‹å–®å­—ã€‚`);
                return;
            }
            
            const maxWordLength = Math.max(...words.map(w => w.length));
            if (maxWordLength > level.maxWordLength) {
                alert(`å–®å­—é•·åº¦è¶…éé™åˆ¶ï¼ç›®å‰é›£åº¦æœ€é•·å–®å­—ç‚º ${level.maxWordLength} å€‹å­—æ¯ã€‚`);
                return;
            }
            
            gameState.wordList = words;
            gameState.foundWords.clear();
            gameState.startTime = new Date();
            createWordGrid();
            renderWordList();
            updateStats();
            
            // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
            const alertArea = document.getElementById('alert-area');
            alertArea.innerHTML = '';
            const alert = document.createElement('div');
            alert.className = 'alert alert-success';
            alert.textContent = `æˆåŠŸç”Ÿæˆ ${gameState.difficulty} é›£åº¦çš„å–®å­—æœå°‹éŠæˆ²ï¼`;
            alertArea.appendChild(alert);
        }

        function createWordGrid() {
            const gridEl = document.getElementById('word-grid');
            gridEl.innerHTML = '';
            
            // è¨­ç½®ç¶²æ ¼å¤§å°
            gridEl.style.gridTemplateColumns = `repeat(${gameState.gridSize}, 1fr)`;
            
            // åˆå§‹åŒ–ç¶²æ ¼
            gameState.grid = Array(gameState.gridSize).fill().map(() => Array(gameState.gridSize).fill(''));
            gameState.wordPositions = {};

            // å˜—è©¦æ”¾ç½®å–®å­—
            const sorted = [...gameState.wordList].sort((a, b) => b.length - a.length);
            sorted.forEach(word => {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 500) {
                    attempts++;
                    const dir = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                    const r = Math.floor(Math.random() * gameState.gridSize);
                    const c = Math.floor(Math.random() * gameState.gridSize);
                    if (canPlaceWord(word, r, c, dir, gameState.gridSize)) {
                        placeWord(word, r, c, dir);
                        placed = true;
                        gameState.wordPositions[word] = [];
                        const [dr, dc] = dir;
                        for (let i = 0; i < word.length; i++) {
                            gameState.wordPositions[word].push({ row: r + dr * i, col: c + dc * i });
                        }
                    }
                }
            });

            // å¡«å……ç©ºç™½æ ¼å­
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    if (gameState.grid[i][j] === '') {
                        gameState.grid[i][j] = getRandomLetter();
                    }
                }
            }

            // å‰µå»ºç¶²æ ¼å…ƒç´ 
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.textContent = gameState.grid[i][j];
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    gridEl.appendChild(cell);
                }
            }

            markFoundWords();
        }

        function markFoundWords() {
            document.querySelectorAll('.cell.found').forEach(el => el.classList.remove('found'));
            for (const word of gameState.foundWords) {
                const positions = gameState.wordPositions[word];
                if (positions) {
                    positions.forEach(pos => {
                        const el = document.querySelector(`.cell[data-row="${pos.row}"][data-col="${pos.col}"]`);
                        if (el) el.classList.add('found');
                    });
                }
            }
            renderWordList();
            updateStats();
        }

        function renderWordList() {
            const el = document.getElementById('word-list');
            el.innerHTML = '';
            gameState.wordList.forEach(word => {
                const item = document.createElement('div');
                item.className = 'word-item';
                if (gameState.foundWords.has(word)) {
                    item.classList.add('found');
                }
                item.textContent = word;
                el.appendChild(item);
            });
        }

        function updateStats() {
            document.getElementById('total-count').textContent = gameState.wordList.length;
            document.getElementById('total-count2').textContent = gameState.wordList.length;
            document.getElementById('found-count').textContent = gameState.foundWords.size;
        }

        function setupEventListeners() {
            const grid = document.getElementById('word-grid');
            let gridRect = null;

            function handleStart(event) {
                event.preventDefault();
                if (gameState.isSelecting || gameState.wordList.length === 0) return;
                const pos = getPageXY(event);
                gridRect = grid.getBoundingClientRect();
                const cell = getCellFromPoint(pos.x, pos.y, gridRect, gameState.gridSize);
                if (!cell) return;

                const el = document.querySelector(`.cell[data-row="${cell.row}"][data-col="${cell.col}"]`);
                if (!el || el.classList.contains('found')) return;

                gameState.isSelecting = true;
                gameState.startCell = cell;
                clearSelection();
                selectCell(cell.row, cell.col);
            }

            function handleMove(event) {
                if (!gameState.isSelecting || !gridRect || gameState.wordList.length === 0) return;
                event.preventDefault();
                const pos = getPageXY(event);
                const currentCell = getCellFromPoint(pos.x, pos.y, gridRect, gameState.gridSize);
                if (!currentCell) return;

                const el = document.querySelector(`.cell[data-row="${currentCell.row}"][data-col="${currentCell.col}"]`);
                if (!el || el.classList.contains('found')) return;

                const path = getBestPath(gameState.startCell, currentCell, gameState.gridSize);
                if (path.length > 0) {
                    clearSelection();
                    path.forEach(p => {
                        const cellEl = document.querySelector(`.cell[data-row="${p.row}"][data-col="${p.col}"]`);
                        if (cellEl && !cellEl.classList.contains('found')) {
                            cellEl.classList.add('selected');
                        }
                    });
                    gameState.currentSelection = path;
                }
            }

            function handleEnd() {
                if (gameState.isSelecting) {
                    // è‡³å°‘é¸ 2 æ ¼æ‰æª¢æŸ¥ï¼ˆé¿å…å–®é»èª¤è§¸ï¼‰
                    if (gameState.currentSelection.length >= 2) {
                        checkCurrentSelection();
                    } else {
                        clearSelection();
                    }
                }
                gameState.isSelecting = false;
                gridRect = null;
            }

            grid.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
            grid.addEventListener('touchstart', handleStart, { passive: false });
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);
        }

        function selectCell(row, col) {
            const el = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (el && !el.classList.contains('found')) {
                el.classList.add('selected');
                gameState.currentSelection = [{ row, col }];
            }
        }

        function clearSelection() {
            document.querySelectorAll('.cell.selected').forEach(el => el.classList.remove('selected'));
            gameState.currentSelection = [];
        }

        function checkCurrentSelection() {
            if (gameState.currentSelection.length === 0) {
                clearSelection();
                return;
            }

            const letters = gameState.currentSelection.map(p => gameState.grid[p.row][p.col]).join('');
            const reversed = letters.split('').reverse().join('');

            let foundWord = null;
            for (const word of gameState.wordList) {
                if ((word === letters || word === reversed) && !gameState.foundWords.has(word)) {
                    foundWord = word;
                    break;
                }
            }

            if (foundWord) {
                gameState.foundWords.add(foundWord);
                gameState.currentSelection.forEach(p => {
                    const el = document.querySelector(`.cell[data-row="${p.row}"][data-col="${p.col}"]`);
                    if (el) {
                        el.classList.remove('selected');
                        el.classList.add('found');
                    }
                });
                markFoundWords();
                if (gameState.foundWords.size === gameState.wordList.length) {
                    setTimeout(() => alert('ğŸ‰ æ­å–œï¼ä½ æ‰¾åˆ°äº†æ‰€æœ‰å–®å­—ï¼'), 100);
                }
            } else {
                clearSelection();
            }
        }

        function resetGame() {
            gameState.foundWords.clear();
            gameState.startTime = new Date();
            createWordGrid();
            renderWordList();
            updateStats();
        }

        // ======================
        // å­¸ç”Ÿè³‡è¨Šå½ˆçª—è™•ç†
        // ======================
        function showStudentInfoModal() {
            const modal = document.getElementById('student-info-modal');
            modal.style.display = 'flex';
            
            // å¾æœ¬åœ°å­˜å„²åŠ è¼‰å·²ä¿å­˜çš„å­¸ç”Ÿè³‡è¨Š
            const savedInfo = localStorage.getItem('wordSearchStudentInfo');
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                document.getElementById('class-input').value = info.class || '';
                document.getElementById('seat-input').value = info.seat || '';
                document.getElementById('name-input').value = info.name || '';
            }
            
            // èšç„¦åˆ°å§“åè¼¸å…¥æ¡†
            document.getElementById('name-input').focus();
        }
        
        function hideStudentInfoModal() {
            const modal = document.getElementById('student-info-modal');
            modal.style.display = 'none';
        }
        
        function saveStudentInfo() {
            const classInput = document.getElementById('class-input').value.trim();
            const seatInput = document.getElementById('seat-input').value.trim();
            const nameInput = document.getElementById('name-input').value.trim();
            
            if (!nameInput) {
                alert('è«‹è¼¸å…¥å§“å');
                document.getElementById('name-input').focus();
                return false;
            }
            
            gameState.studentInfo = {
                class: classInput,
                seat: seatInput,
                name: nameInput
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('wordSearchStudentInfo', JSON.stringify(gameState.studentInfo));
            
            return true;
        }

        async function generatePDF() {
            // æª¢æŸ¥æ˜¯å¦æœ‰ç”ŸæˆéŠæˆ²
            if (gameState.wordList.length === 0) {
                alert('è«‹å…ˆç”Ÿæˆå–®å­—æœå°‹éŠæˆ²');
                return;
            }

            // é¡¯ç¤ºå­¸ç”Ÿè³‡è¨Šå½ˆçª—
            showStudentInfoModal();
        }
        
        async function confirmAndGeneratePDF() {
            // ä¿å­˜å­¸ç”Ÿè³‡è¨Š
            if (!saveStudentInfo()) {
                return;
            }
            
            // é—œé–‰å½ˆçª—
            hideStudentInfoModal();
            
            // ç”ŸæˆPDFå ±å‘Š
            await generatePDFReport();
        }

        async function generatePDFReport() {
            const now = new Date();
            const durationMs = now - gameState.startTime;
            const minutes = Math.floor(durationMs / 60000);
            const seconds = Math.floor((durationMs % 60000) / 1000);
            const durationStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // æ›´æ–°PDFå ±å‘Šä¸­çš„å­¸ç”Ÿè³‡è¨Š
            document.getElementById('pdf-student-name').textContent = gameState.studentInfo.name;
            document.getElementById('pdf-class').textContent = gameState.studentInfo.class || 'æœªå¡«å¯«';
            document.getElementById('pdf-seat').textContent = gameState.studentInfo.seat || 'æœªå¡«å¯«';
            document.getElementById('pdf-name').textContent = gameState.studentInfo.name;
            
            document.getElementById('pdf-start-time').textContent = gameState.startTime.toLocaleString('zh-CN');
            document.getElementById('pdf-end-time').textContent = now.toLocaleString('zh-CN');
            document.getElementById('pdf-duration').textContent = durationStr;
            document.getElementById('pdf-completion').textContent = 
                `${gameState.foundWords.size}/${gameState.wordList.length} (${Math.round(gameState.foundWords.size / gameState.wordList.length * 100)}%)`;

            // æ›´æ–°PDFç¶²æ ¼
            const pdfGrid = document.getElementById('pdf-grid');
            pdfGrid.innerHTML = '';
            pdfGrid.style.gridTemplateColumns = `repeat(${gameState.gridSize}, 1fr)`;
            
            for (let i = 0; i < gameState.gridSize; i++) {
                for (let j = 0; j < gameState.gridSize; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.textContent = gameState.grid[i][j];
                    let inFound = false;
                    for (const word of gameState.foundWords) {
                        const pos = gameState.wordPositions[word];
                        if (pos && pos.some(p => p.row === i && p.col === j)) {
                            inFound = true;
                            break;
                        }
                    }
                    if (inFound) {
                        cell.classList.add('found');
                    }
                    pdfGrid.appendChild(cell);
                }
            }

            // æ›´æ–°PDFå–®å­—åˆ—è¡¨
            const pdfWords = document.getElementById('pdf-all-words');
            pdfWords.innerHTML = '';
            
            gameState.wordList.forEach(word => {
                const wordItem = document.createElement('div');
                wordItem.className = 'pdf-word-item';
                
                if (gameState.foundWords.has(word)) {
                    wordItem.classList.add('pdf-word-found');
                    wordItem.textContent = word + ' âœ“';
                } else {
                    wordItem.classList.add('pdf-word-notfound');
                    wordItem.textContent = word + ' âœ—';
                }
                
                pdfWords.appendChild(wordItem);
            });

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            // ç¬¬ä¸€é  - éŠæˆ²å ±å‘Š
            document.getElementById('pdf-report-page1').style.display = 'block';
            const page1El = document.getElementById('pdf-report-page1');
            const canvas1 = await html2canvas(page1El, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff'
            });

            const imgData1 = canvas1.toDataURL('image/png');
            const imgWidth = 210;
            const imgHeight1 = (canvas1.height * imgWidth) / canvas1.width;
            pdf.addImage(imgData1, 'PNG', 0, 0, imgWidth, imgHeight1);

            // ç¬¬äºŒé  - å–®å­—åˆ—è¡¨
            document.getElementById('pdf-report-page2').style.display = 'block';
            pdf.addPage();
            const page2El = document.getElementById('pdf-report-page2');
            const canvas2 = await html2canvas(page2El, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff'
            });

            const imgData2 = canvas2.toDataURL('image/png');
            const imgHeight2 = (canvas2.height * imgWidth) / canvas2.width;
            pdf.addImage(imgData2, 'PNG', 0, 0, imgWidth, imgHeight2);
            
            // éš±è—PDFæ¨¡æ¿
            document.getElementById('pdf-report-page1').style.display = 'none';
            document.getElementById('pdf-report-page2').style.display = 'none';
            
            // ä½¿ç”¨å­¸ç”Ÿå§“åä½œç‚ºPDFæª”æ¡ˆåç¨±çš„ä¸€éƒ¨åˆ†
            const fileName = `${gameState.studentInfo.name}'s Self-designed Word Search_${new Date().toISOString().slice(0,10)}.pdf`;
            pdf.save(fileName);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            document.getElementById('generate-btn').addEventListener('click', generateWordSearch);
            document.getElementById('reset-btn').addEventListener('click', resetGame);
            document.getElementById('download-pdf-btn').addEventListener('click', generatePDF);
            
            // å­¸ç”Ÿè³‡è¨Šå½ˆçª—äº‹ä»¶
            document.getElementById('cancel-btn').addEventListener('click', hideStudentInfoModal);
            document.getElementById('confirm-btn').addEventListener('click', confirmAndGeneratePDF);
            
            // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰å½ˆçª—
            document.getElementById('student-info-modal').addEventListener('click', (e) => {
                if (e.target.id === 'student-info-modal') {
                    hideStudentInfoModal();
                }
            });
        });
    </script>
</body>
</html>
