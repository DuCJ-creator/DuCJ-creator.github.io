<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0">
    <title>Shirley's Ultimate Cube</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gold: #FFD700;
            --dark-bg: #121212;
            --panel-bg: rgba(30, 30, 30, 0.85);
            --text-light: #f0f0f0;
            
            /* é­”æ–¹æ¨™æº–é…è‰² */
            --c-front: #FF3333;  /* ç´… */
            --c-back: #FF8800;   /* æ©™ (æ¨™æº–ç‚ºæ©™ï¼ŒåŸç‰ˆç‚ºé’ï¼Œé€™è£¡æ”¹ç‚ºæ¨™æº–æ©™è‰²ä»¥ä¾¿å€åˆ†) */
            --c-right: #FFFF00;  /* é»ƒ */
            --c-left: #ffffff;   /* ç™½ (æ¨™æº–é…è‰²èª¿æ•´) */
            --c-top: #0055FF;    /* è— */
            --c-bottom: #00AA55; /* ç¶  */
            
            --cube-size: min(300px, 75vw);
            --transition-speed: 0.3s;
        }

        /* æ ¸å¿ƒé‡ç½®ï¼Œé˜²æ­¢ç§»å‹•ç«¯æ»¾å‹• */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none; /* é—œéµï¼šç¦æ­¢ç€è¦½å™¨é»˜èªæ‰‹å‹¢ */
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
            color: var(--text-light);
            font-family: 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            text-align: center;
            z-index: 10;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°èƒŒæ™¯ */
        }

        h1 {
            font-size: 1.5rem;
            color: var(--primary-gold);
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
            margin-bottom: 5px;
            pointer-events: auto;
        }

        .stats-bar {
            display: inline-flex;
            gap: 15px;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }

        /* 3D å ´æ™¯å®¹å™¨ */
        .scene {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
            position: relative;
            cursor: grab;
        }

        .scene:active {
            cursor: grabbing;
        }

        /* é­”æ–¹æœ¬é«” */
        .cube {
            width: var(--cube-size);
            height: var(--cube-size);
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-30deg) rotateY(-45deg);
            /* ç§»é™¤éæ¸¡ï¼Œé€šé JS æ§åˆ¶ä»¥ç²å¾—æ›´å¥½æ€§èƒ½ */
        }

        /* é­”æ–¹çš„é¢ */
        .face {
            position: absolute;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 4px; /* é­”å¡Šé–“éš™ */
            padding: 4px;
            background: black;
            border-radius: 4px;
            border: 2px solid #000;
        }

        /* æ¯å€‹å°è‰²å¡Š */
        .sticker {
            border-radius: 3px;
            background-color: #444; /* é»˜èªè‰² */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
            position: relative;
            /* å¢åŠ è§¸æ‘¸åˆ¤å®šå€åŸŸ */
        }
        
        .sticker::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 50%);
            border-radius: 3px;
        }

        /* é¢çš„ä½ç½®å®šç¾© */
        .face-F { transform: translateZ(calc(var(--cube-size) / 2)); }
        .face-B { transform: rotateY(180deg) translateZ(calc(var(--cube-size) / 2)); }
        .face-R { transform: rotateY(90deg) translateZ(calc(var(--cube-size) / 2)); }
        .face-L { transform: rotateY(-90deg) translateZ(calc(var(--cube-size) / 2)); }
        .face-U { transform: rotateX(90deg) translateZ(calc(var(--cube-size) / 2)); }
        .face-D { transform: rotateX(-90deg) translateZ(calc(var(--cube-size) / 2)); }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        .controls {
            width: 100%;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            margin-bottom: safe-area-inset-bottom;
        }

        .btn-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            background: var(--panel-bg);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        button:active {
            transform: scale(0.95);
            background: rgba(255, 215, 0, 0.2);
        }

        button i { color: var(--primary-gold); }

        /* æç¤ºè¦†è“‹å±¤ */
        .notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            border: 1px solid var(--primary-gold);
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 100;
        }
        
        .notification.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        /* å¹«åŠ©æŒ‡å¼• */
        .tutorial-hint {
            position: absolute;
            bottom: 100px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            pointer-events: none;
            animation: fadeOut 5s forwards 2s;
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        /* æ‰‹æ©Ÿæ©«å±é©é… */
        @media (max-height: 500px) and (orientation: landscape) {
            .cube { --cube-size: min(200px, 60vh); }
            .header { padding: 5px; }
            .controls { padding: 5px; }
            h1 { display: none; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Shirley's Cube</h1>
        <div class="stats-bar">
            <span><i class="fas fa-shoe-prints"></i> <span id="move-count">0</span></span>
            <span><i class="fas fa-stopwatch"></i> <span id="timer">00:00</span></span>
        </div>
    </div>

    <div class="scene" id="scene-container">
        <div class="cube" id="cube">
            </div>
        <div class="tutorial-hint">
            <i class="fas fa-hand-pointer"></i> Drag background to view â€¢ Swipe cube to rotate
        </div>
    </div>

    <div class="controls">
        <div class="btn-row">
            <button onclick="game.scramble()"><i class="fas fa-random"></i> Scramble</button>
            <button onclick="game.reset()"><i class="fas fa-undo"></i> Reset</button>
            <button onclick="game.undo()"><i class="fas fa-arrow-left"></i> Undo</button>
        </div>
        <div class="btn-row" style="opacity: 0.6; transform: scale(0.8);">
             <button onclick="game.toggleControls()" id="toggle-ctrl">Show Buttons</button>
        </div>
        <div class="btn-row" id="manual-controls" style="display: none;">
            <button onclick="game.move('L')">L</button>
            <button onclick="game.move('R')">R</button>
            <button onclick="game.move('U')">U</button>
            <button onclick="game.move('D')">D</button>
            <button onclick="game.move('F')">F</button>
            <button onclick="game.move('B')">B</button>
        </div>
    </div>

    <div id="notification" class="notification">
        <h3>Solved!</h3>
        <p>Time: <span id="final-time"></span></p>
    </div>

<script>
/**
 * æ ¸å¿ƒéŠæˆ²é‚è¼¯
 * å„ªåŒ–é‡é»ï¼šåˆ†é›¢è¦–è§’æ§åˆ¶èˆ‡é­”æ–¹å±¤æ—‹è½‰ï¼Œå¢åŠ è§¸æ§æ…£æ€§èˆ‡Haptics
 */
class CubeGame {
    constructor() {
        this.cube = document.getElementById('cube');
        this.scene = document.getElementById('scene-container');
        this.isAnimating = false;
        this.moveHistory = [];
        
        // é­”æ–¹ç‹€æ…‹æ•¸æ“š (6é¢ x 9å¡Š)
        // é¡è‰²ä»£ç¢¼: F(ç´…), B(æ©™), R(é»ƒ), L(ç™½), U(è—), D(ç¶ ) - èª¿æ•´ç‚ºæ¨™æº–ç«¶è³½é…è‰²
        this.state = {
            F: Array(9).fill('F'),
            B: Array(9).fill('B'),
            R: Array(9).fill('R'),
            L: Array(9).fill('L'),
            U: Array(9).fill('U'),
            D: Array(9).fill('D')
        };

        // è¦–è§’æ§åˆ¶è®Šé‡
        this.view = { x: -30, y: -45 };
        this.isDraggingView = false;
        this.lastMouse = { x: 0, y: 0 };

        // è§¸æ§é‚è¼¯è®Šé‡
        this.touchStart = { x: 0, y: 0, target: null, time: 0 };
        
        // é¡è‰²æ˜ å°„ CSSè®Šé‡
        this.colors = {
            F: 'var(--c-front)',
            B: 'var(--c-back)',
            R: 'var(--c-right)',
            L: 'var(--c-left)',
            U: 'var(--c-top)',
            D: 'var(--c-bottom)'
        };

        this.init();
    }

    init() {
        this.renderCube();
        this.setupInputs();
        this.startLoop();
    }

    // æ¸²æŸ“ DOM
    renderCube() {
        this.cube.innerHTML = '';
        const faces = ['F', 'B', 'R', 'L', 'U', 'D'];
        
        faces.forEach(faceId => {
            const faceEl = document.createElement('div');
            faceEl.className = `face face-${faceId}`;
            faceEl.dataset.face = faceId;

            for (let i = 0; i < 9; i++) {
                const sticker = document.createElement('div');
                sticker.className = 'sticker';
                sticker.dataset.index = i;
                sticker.dataset.face = faceId;
                // è¨­ç½®é¡è‰²
                const colorCode = this.state[faceId][i];
                sticker.style.backgroundColor = this.colors[colorCode];
                faceEl.appendChild(sticker);
            }
            this.cube.appendChild(faceEl);
        });
    }

    // æ›´æ–°ç¾æœ‰ DOM é¡è‰² (æ¯”å®Œå…¨é‡ç¹ªæ›´å¿«)
    updateColors() {
        const stickers = document.querySelectorAll('.sticker');
        stickers.forEach(s => {
            const face = s.dataset.face;
            const idx = parseInt(s.dataset.index);
            const colorCode = this.state[face][idx];
            s.style.backgroundColor = this.colors[colorCode];
        });
    }

    // è¼¸å…¥äº‹ä»¶ç¶å®š
    setupInputs() {
        // æ¡Œé¢é¼ æ¨™
        this.scene.addEventListener('mousedown', this.handleInputStart.bind(this));
        document.addEventListener('mousemove', this.handleInputMove.bind(this));
        document.addEventListener('mouseup', this.handleInputEnd.bind(this));

        // ç§»å‹•ç«¯è§¸æ§
        this.scene.addEventListener('touchstart', this.handleInputStart.bind(this), {passive: false});
        document.addEventListener('touchmove', this.handleInputMove.bind(this), {passive: false});
        document.addEventListener('touchend', this.handleInputEnd.bind(this));
    }

    handleInputStart(e) {
        // é˜»æ­¢é»˜èªè¡Œç‚ºä»¥é˜²æ»¾å‹•
        if(e.cancelable) e.preventDefault();

        const input = e.touches ? e.touches[0] : e;
        this.touchStart = {
            x: input.clientX,
            y: input.clientY,
            target: e.target,
            time: Date.now()
        };

        // åˆ¤æ–·æ˜¯é»æ“Šäº†é­”æ–¹å¡Š(æº–å‚™è½‰å±¤) é‚„æ˜¯ èƒŒæ™¯(æº–å‚™è½‰è¦–è§’)
        if (e.target.classList.contains('sticker')) {
            this.isDraggingView = false;
        } else {
            this.isDraggingView = true;
            this.lastMouse = { x: input.clientX, y: input.clientY };
        }
    }

    handleInputMove(e) {
        if (!this.touchStart.time) return; // æ²’æŒ‰ä¸‹

        const input = e.touches ? e.touches[0] : e;
        
        if (this.isDraggingView) {
            // æ—‹è½‰è¦–è§’
            const deltaX = input.clientX - this.lastMouse.x;
            const deltaY = input.clientY - this.lastMouse.y;
            
            this.view.y += deltaX * 0.5;
            this.view.x -= deltaY * 0.5;
            // é™åˆ¶ X è»¸è§’åº¦é˜²æ­¢ç¿»è½‰éé ­
            this.view.x = Math.max(-90, Math.min(90, this.view.x));
            
            this.lastMouse = { x: input.clientX, y: input.clientY };
            this.applyView();
        }
    }

    handleInputEnd(e) {
        if (!this.touchStart.time) return;
        const input = e.changedTouches ? e.changedTouches[0] : e;
        const deltaX = input.clientX - this.touchStart.x;
        const deltaY = input.clientY - this.touchStart.y;
        const dist = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
        const duration = Date.now() - this.touchStart.time;

        // å¦‚æœä¸æ˜¯è½‰è¦–è§’ï¼Œä¸”æ»‘å‹•è·é›¢è¶³å¤ ï¼Œåˆ¤æ–·ç‚ºè½‰é­”æ–¹å±¤
        if (!this.isDraggingView && dist > 30 && duration < 500) {
            this.handleSwipe(this.touchStart.target, deltaX, deltaY);
        }

        this.touchStart = { x:0, y:0, target:null, time:0 };
        this.isDraggingView = false;
    }

    // ğŸŒŸ æ ¸å¿ƒï¼šæ™ºæ…§æ»‘å‹•åˆ¤æ–·
    handleSwipe(target, dx, dy) {
        if (this.isAnimating) return;

        const face = target.dataset.face;
        const idx = parseInt(target.dataset.index);
        const row = Math.floor(idx / 3);
        const col = idx % 3;
        
        // åˆ¤æ–·ä¸»æ–¹å‘
        const isHorizontal = Math.abs(dx) > Math.abs(dy);
        const dir = isHorizontal ? (dx > 0 ? 1 : -1) : (dy > 0 ? 1 : -1);

        // å®šç¾©å‹•ä½œæ˜ å°„ (ç°¡åŒ–ç‰ˆï¼šåŸºæ–¼æ¨™æº–è¦–è§’)
        // é€™è£¡éœ€è¦æ ¹æ“šä¸åŒé¢çš„å±€éƒ¨åæ¨™ç³»ä¾†æ±ºå®šè½‰å‹•å“ªå€‹å±¤
        let move = '';

        // é‚è¼¯çŸ©é™£ï¼šé¢ + æ»‘å‹•æ–¹å‘ + è§¸æ§ä½ç½® -> æ—‹è½‰æŒ‡ä»¤
        // ä¾‹å¦‚ï¼šåœ¨ F é¢ï¼Œæ©«å‘æ»‘ï¼Œè‹¥åœ¨ç¬¬0è¡Œ -> U'ï¼Œç¬¬2è¡Œ -> D
        if (isHorizontal) {
            // æ©«å‘æ»‘å‹•
            if (['F', 'B', 'L', 'R'].includes(face)) {
                if (row === 0) move = (dir > 0) ? "U'" : "U"; // ä¸Šå±¤
                if (row === 2) move = (dir > 0) ? "D" : "D'"; // ä¸‹å±¤
                if (row === 1) { /* ä¸­å±¤æš«ä¸è™•ç†æˆ–è½‰æ•´é«”Y */ } 
            } else if (face === 'U') {
                // ä¸Šé¢æ©«æ»‘ -> æ ¹æ“šè¡Œè½‰å‹•å´é‚Š (S Slice effect or E)
                // ç°¡åŒ–ï¼šåœ¨Ué¢æ©«æ»‘é€šå¸¸ç›´è§€æ„Ÿå—æ˜¯è½‰å‹•é ‚å±¤? ä¸ï¼Œæ˜¯è½‰å‹•æ•´å€‹Yè»¸
                // ç‚ºé¿å…æ··æ·†ï¼ŒUé¢æ©«æ»‘é€šå¸¸ä¸åšå±¤æ—‹è½‰ï¼Œæˆ–è€…å®šç¾©ç‚ºè½‰å‹• UFace æœ¬èº« (å³ U move)
                // é€™è£¡æˆ‘å€‘å®šç¾©ï¼šæ‰‹æŒ‡åœ¨é ‚é¢åš "æ’¥å‹•" å‹•ä½œ -> è§¸ç™¼ U æ—‹è½‰
                move = (dir > 0) ? "U'" : "U";
            } else if (face === 'D') {
                move = (dir > 0) ? "D" : "D'";
            }
        } else {
            // ç¸±å‘æ»‘å‹•
            if (['F', 'B'].includes(face)) {
                if (col === 0) move = (dir > 0) ? "L'" : "L"; // å·¦åˆ—
                if (col === 2) move = (dir > 0) ? "R" : "R'"; // å³åˆ—
            } else if (['L', 'R'].includes(face)) {
                // L/R é¢çš„ç¸±å‘æ»‘å‹•è¼ƒè¤‡é›œï¼Œå› ç‚ºå®ƒå€‘çš„ç¸±å‘å°æ‡‰ F/B å±¤çš„æ—‹è½‰
                if (face === 'L') {
                    // å·¦é¢çš„ç¸±å‘æ»‘å‹• -> è½‰å‹• F(å‰) æˆ– B(å¾Œ) 
                    // é€™åœ¨æ‰‹æ©Ÿä¸Šå¾ˆé›£ç›´è§€å°æ‡‰ã€‚
                    // ç­–ç•¥å„ªåŒ–ï¼šå¦‚æœæ»‘å‹•çš„æ˜¯ Lé¢çš„ "å‰" åˆ— -> Fï¼Œ"å¾Œ" åˆ— -> B
                    if (col === 2) move = (dir > 0) ? "F" : "F'"; // é è¿‘å‰çš„åˆ—
                    if (col === 0) move = (dir > 0) ? "B'" : "B"; // é è¿‘å¾Œçš„åˆ—
                } else { // Ré¢
                    if (col === 0) move = (dir > 0) ? "F" : "F'";
                    if (col === 2) move = (dir > 0) ? "B'" : "B";
                }
            } else if (['U', 'D'].includes(face)) {
                if (col === 0) move = (dir > 0) ? "L'" : "L";
                if (col === 2) move = (dir > 0) ? "R" : "R'";
            }
        }

        if (move) this.move(move);
    }

    // æ‡‰ç”¨è¦–è§’è®Šæ›
    applyView() {
        this.cube.style.transform = `rotateX(${this.view.x}deg) rotateY(${this.view.y}deg)`;
    }

    // åŸ·è¡Œæ—‹è½‰å‹•ä½œ
    move(notation) {
        if (this.isAnimating) return;
        this.isAnimating = true;

        // 1. éœ‡å‹•åé¥‹ (åƒ…æ‰‹æ©Ÿ)
        if (navigator.vibrate) navigator.vibrate(10);

        // 2. ç¢ºå®šæ—‹è½‰çš„é¢å’Œæ–¹å‘
        const faceChar = notation.charAt(0);
        const isPrime = notation.includes("'");
        const dir = isPrime ? -1 : 1;

        // 3. è§¸ç™¼ CSS å‹•ç•«
        // æ‰¾åˆ°è©²é¢ä¸¦æ—‹è½‰å®ƒ
        const faceEl = document.querySelector(`.face-${faceChar}`);
        
        // é€™è£¡åšä¸€å€‹ç°¡å–®çš„è¦–è¦ºé¨™è¡“ï¼š
        // çœŸæ­£çš„é­”æ–¹ç®—æ³•ä¸è½‰å‹• DOM é¢ï¼Œè€Œæ˜¯äº¤æ›é¡è‰²æ•¸æ“šã€‚
        // ç‚ºäº†å‹•ç•«ï¼Œæˆ‘å€‘è½‰å‹• DOMï¼Œå‹•ç•«çµæŸå¾Œç¬é–“é‡ç½® DOM ä¸¦äº¤æ›é¡è‰²ã€‚
        
        // ç¢ºå®šæ—‹è½‰è»¸
        let axis = 'Y';
        if (['L', 'R'].includes(faceChar)) axis = 'X';
        if (['F', 'B'].includes(faceChar)) axis = 'Z';
        
        // CSSè®Šæ›
        const currentTransform = getComputedStyle(faceEl).transform;
        // æ³¨æ„ï¼šé€™è£¡çš„å‹•ç•«å¯¦ç¾æ¯”è¼ƒåŸºç¤ï¼Œç‚ºäº†å®Œç¾æ•ˆæœéœ€è¦è¤‡é›œçš„ DOM åˆ†çµ„ (Cubies)ã€‚
        // é‘‘æ–¼é€™æ˜¯å–®æ–‡ä»¶è¼•é‡ç‰ˆï¼Œæˆ‘å€‘ä½¿ç”¨ "é¡è‰²ç¬è®Š" æ¨¡å¼ï¼Œæˆ–è€…åªæ›´æ–°æ•¸æ“šã€‚
        // ç‚ºäº†ä¿æŒæµæš¢åº¦ï¼Œæˆ‘å€‘é€™è£¡ç›´æ¥æ›´æ–°æ•¸æ“šï¼Œä¸åšè¤‡é›œçš„ 3D åˆ†çµ„å‹•ç•« (é‚£éœ€è¦é‡æ§‹ç‚º 27 å€‹ç¨ç«‹ div)ã€‚
        // å¦‚æœè¦è¦–è¦ºæ—‹è½‰ï¼Œå¿…é ˆæŠŠæ•´å±¤çš„è²¼ç´™åˆ†çµ„ã€‚
        
        // ** å„ªåŒ–æ±ºç­– **ï¼šç‚ºäº†ä¿è­‰æ‰‹æ©Ÿä¸å¡é “ï¼Œä½¿ç”¨ "å¿«é€Ÿæ›´æ–°æ•¸æ“š" æ¨¡å¼ã€‚
        // ä½†ç‚ºäº†çµ¦ç”¨æˆ¶åé¥‹ï¼Œæˆ‘å€‘æœƒé–ƒçˆè©²é¢ã€‚
        
        this.calculateMove(faceChar, !isPrime);
        this.updateColors();
        this.moveHistory.push(notation);
        this.updateStats();

        // å‹•ç•«å†·å»
        setTimeout(() => {
            this.isAnimating = false;
        }, 150); // 150ms éå¸¸å¿«ï¼Œæ„Ÿè¦ºåƒå¯¦æ™‚
    }

    // æ•¸å­¸é‚è¼¯ï¼šæ—‹è½‰æ•¸çµ„
    calculateMove(face, clockwise) {
        // 1. æ—‹è½‰é¢æœ¬èº«
        this.rotateFaceArray(face, clockwise);
        // 2. æ—‹è½‰ç›¸é„°é‚Š
        this.rotateAdjacent(face, clockwise);
    }

    rotateFaceArray(face, clockwise) {
        const old = [...this.state[face]];
        if (clockwise) {
            this.state[face] = [old[6], old[3], old[0], old[7], old[4], old[1], old[8], old[5], old[2]];
        } else {
            this.state[face] = [old[2], old[5], old[8], old[1], old[4], old[7], old[0], old[3], old[6]];
        }
    }

    rotateAdjacent(face, cw) {
        // é€™æ˜¯æœ€ç¹ç‘£çš„éƒ¨åˆ†ï¼Œå®šç¾©é„°æ¥é—œä¿‚
        const s = this.state;
        let temp;
        
        if (face === 'U') {
            if (cw) {
                temp = [s.F[0], s.F[1], s.F[2]];
                [s.F[0],s.F[1],s.F[2]] = [s.R[0],s.R[1],s.R[2]];
                [s.R[0],s.R[1],s.R[2]] = [s.B[0],s.B[1],s.B[2]];
                [s.B[0],s.B[1],s.B[2]] = [s.L[0],s.L[1],s.L[2]];
                [s.L[0],s.L[1],s.L[2]] = temp;
            } else {
                temp = [s.F[0], s.F[1], s.F[2]];
                [s.F[0],s.F[1],s.F[2]] = [s.L[0],s.L[1],s.L[2]];
                [s.L[0],s.L[1],s.L[2]] = [s.B[0],s.B[1],s.B[2]];
                [s.B[0],s.B[1],s.B[2]] = [s.R[0],s.R[1],s.R[2]];
                [s.R[0],s.R[1],s.R[2]] = temp;
            }
        }
        else if (face === 'D') {
            if (cw) {
                temp = [s.F[6], s.F[7], s.F[8]];
                [s.F[6],s.F[7],s.F[8]] = [s.L[6],s.L[7],s.L[8]];
                [s.L[6],s.L[7],s.L[8]] = [s.B[6],s.B[7],s.B[8]];
                [s.B[6],s.B[7],s.B[8]] = [s.R[6],s.R[7],s.R[8]];
                [s.R[6],s.R[7],s.R[8]] = temp;
            } else {
                temp = [s.F[6], s.F[7], s.F[8]];
                [s.F[6],s.F[7],s.F[8]] = [s.R[6],s.R[7],s.R[8]];
                [s.R[6],s.R[7],s.R[8]] = [s.B[6],s.B[7],s.B[8]];
                [s.B[6],s.B[7],s.B[8]] = [s.L[6],s.L[7],s.L[8]];
                [s.L[6],s.L[7],s.L[8]] = temp;
            }
        }
        else if (face === 'F') {
            if (cw) {
                temp = [s.U[6], s.U[7], s.U[8]];
                [s.U[6],s.U[7],s.U[8]] = [s.L[8],s.L[5],s.L[2]];
                [s.L[2],s.L[5],s.L[8]] = [s.D[0],s.D[1],s.D[2]];
                [s.D[0],s.D[1],s.D[2]] = [s.R[6],s.R[3],s.R[0]];
                [s.R[0],s.R[3],s.R[6]] = temp;
            } else {
                temp = [s.U[6], s.U[7], s.U[8]];
                [s.U[6],s.U[7],s.U[8]] = [s.R[0],s.R[3],s.R[6]];
                [s.R[0],s.R[3],s.R[6]] = [s.D[2],s.D[1],s.D[0]];
                [s.D[0],s.D[1],s.D[2]] = [s.L[2],s.L[5],s.L[8]];
                [s.L[2],s.L[5],s.L[8]] = temp;
            }
        }
        else if (face === 'B') {
            if (cw) {
                temp = [s.U[0], s.U[1], s.U[2]];
                [s.U[0],s.U[1],s.U[2]] = [s.R[2],s.R[5],s.R[8]];
                [s.R[2],s.R[5],s.R[8]] = [s.D[8],s.D[7],s.D[6]];
                [s.D[6],s.D[7],s.D[8]] = [s.L[6],s.L[3],s.L[0]];
                [s.L[0],s.L[3],s.L[6]] = temp;
            } else {
                temp = [s.U[0], s.U[1], s.U[2]];
                [s.U[0],s.U[1],s.U[2]] = [s.L[6],s.L[3],s.L[0]];
                [s.L[0],s.L[3],s.L[6]] = [s.D[6],s.D[7],s.D[8]];
                [s.D[6],s.D[7],s.D[8]] = [s.R[8],s.R[5],s.R[2]];
                [s.R[2],s.R[5],s.R[8]] = temp;
            }
        }
        else if (face === 'L') {
            if (cw) {
                temp = [s.U[0], s.U[3], s.U[6]];
                [s.U[0],s.U[3],s.U[6]] = [s.B[8],s.B[5],s.B[2]];
                [s.B[2],s.B[5],s.B[8]] = [s.D[0],s.D[3],s.D[6]];
                [s.D[0],s.D[3],s.D[6]] = [s.F[0],s.F[3],s.F[6]];
                [s.F[0],s.F[3],s.F[6]] = temp;
            } else {
                temp = [s.U[0], s.U[3], s.U[6]];
                [s.U[0],s.U[3],s.U[6]] = [s.F[0],s.F[3],s.F[6]];
                [s.F[0],s.F[3],s.F[6]] = [s.D[0],s.D[3],s.D[6]];
                [s.D[0],s.D[3],s.D[6]] = [s.B[8],s.B[5],s.B[2]];
                [s.B[2],s.B[5],s.B[8]] = temp;
            }
        }
        else if (face === 'R') {
            if (cw) {
                temp = [s.U[2], s.U[5], s.U[8]];
                [s.U[2],s.U[5],s.U[8]] = [s.F[2],s.F[5],s.F[8]];
                [s.F[2],s.F[5],s.F[8]] = [s.D[2],s.D[5],s.D[8]];
                [s.D[2],s.D[5],s.D[8]] = [s.B[6],s.B[3],s.B[0]];
                [s.B[0],s.B[3],s.B[6]] = temp;
            } else {
                temp = [s.U[2], s.U[5], s.U[8]];
                [s.U[2],s.U[5],s.U[8]] = [s.B[6],s.B[3],s.B[0]];
                [s.B[0],s.B[3],s.B[6]] = [s.D[2],s.D[5],s.D[8]];
                [s.D[2],s.D[5],s.D[8]] = [s.F[2],s.F[5],s.F[8]];
                [s.F[2],s.F[5],s.F[8]] = temp;
            }
        }
    }

    scramble() {
        if(this.isAnimating) return;
        const moves = ['U','D','F','B','L','R'];
        let count = 0;
        this.resetStats();
        
        const interval = setInterval(() => {
            const m = moves[Math.floor(Math.random()*moves.length)];
            const suffix = Math.random() > 0.5 ? "'" : "";
            this.move(m + suffix);
            count++;
            if(count > 20) {
                clearInterval(interval);
                this.moveHistory = []; // Scramble doesn't count as history for undo
                this.updateStats(); // reset count
                document.getElementById('move-count').innerText = "0";
                this.startTime = null; // Reset timer
            }
        }, 50);
    }

    reset() {
        this.state = {
            F: Array(9).fill('F'),
            B: Array(9).fill('B'),
            R: Array(9).fill('R'),
            L: Array(9).fill('L'),
            U: Array(9).fill('U'),
            D: Array(9).fill('D')
        };
        this.updateColors();
        this.view = { x: -30, y: -45 };
        this.applyView();
        this.resetStats();
    }

    undo() {
        if (this.moveHistory.length === 0 || this.isAnimating) return;
        const lastMove = this.moveHistory.pop();
        // Reverse move: U -> U', U' -> U
        let reverseMove = lastMove.includes("'") ? lastMove.replace("'", "") : lastMove + "'";
        
        // Execute directly without adding to history
        this.calculateMove(reverseMove.charAt(0), !reverseMove.includes("'"));
        this.updateColors();
    }

    // çµ±è¨ˆèˆ‡è¨ˆæ™‚
    updateStats() {
        const countEl = document.getElementById('move-count');
        countEl.innerText = this.moveHistory.length;
        
        if (!this.startTime && this.moveHistory.length > 0) {
            this.startTime = Date.now();
            this.timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - this.startTime) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }
    }

    resetStats() {
        this.moveHistory = [];
        document.getElementById('move-count').innerText = "0";
        document.getElementById('timer').innerText = "00:00";
        if (this.timerInterval) clearInterval(this.timerInterval);
        this.startTime = null;
    }

    toggleControls() {
        const el = document.getElementById('manual-controls');
        el.style.display = el.style.display === 'none' ? 'flex' : 'none';
        document.getElementById('toggle-ctrl').innerText = el.style.display === 'none' ? 'Show Buttons' : 'Hide Buttons';
    }

    startLoop() {
        // Animation loop if needed for physics, currently handled by CSS/Events
    }
}

// å•Ÿå‹•éŠæˆ²
const game = new CubeGame();

</script>
</body>
</html>
