<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hungry Snake â€“ Word Learning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
Â  Â  /* Setup Screen */
Â  Â  .setup-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#E8E5DA;
Â  Â  Â  Â  display:flex;flex-direction:column;justify-content:center;align-items:center;
Â  Â  Â  Â  z-index:200;font-family:system-ui,sans-serif;gap:20px}
Â  Â  .setup-screen h2{color:#5A4A42}
Â  Â  select,button{padding:10px 20px;font-size:16px;border-radius:8px;border:1px solid #A89F94}
Â  Â  button.start-game-btn{background:#A8B7A5;color:#5A4A42;font-weight:bold;cursor:pointer;margin-top:10px}

Â  Â  /* Body & Layout */
Â  Â  body{font-family:system-ui,sans-serif;margin:0;padding:0;display:flex;justify-content:center;
Â  Â  Â  Â  align-items:center;background:#E8E5DA;height:100vh;overflow:hidden;-webkit-user-select:none;
Â  Â  Â  Â  user-select:none;touch-action:manipulation}
Â  Â  .game-container{display:flex;width:95vw;max-width:1200px;height:80vh;gap:10px}
Â  Â  .game-area{flex:1;position:relative;aspect-ratio:1/1;max-height:100%;display:flex;
Â  Â  Â  Â  justify-content:center;align-items:center}
Â  Â  #game-board{border:3px solid #A89F94;border-radius:8px;background:#F0EDE5;width:100%;height:100%}

Â  Â  /* Right Panel */
Â  Â  .right-panel{width:200px;height:100%;display:flex;flex-direction:column;gap:15px}
Â  Â  .question-box{background:#B7AFA1;color:#5A4A42;padding:15px;border-radius:8px;
Â  Â  Â  Â  text-align:center;font-weight:bold;word-break:break-word}
Â  Â  /* Responsive word size: Bigger on mobile, scales on desktop */
Â  Â  @media (min-width: 768px) {.question-box {font-size: 2.2vw; min-font-size: 18px;}}
Â  Â  @media (max-width: 767px) {.question-box {font-size: 4.5vw;}}

Â  Â  .score-container,.time-container{background:#A8B7A5;color:#5A4A42;padding:15px;border-radius:8px;text-align:center}
Â  Â  .score-container div,.time-container div{margin:8px 0;font-weight:bold}
Â  Â  .time-selector{display:flex;justify-content:space-between;margin-top:8px}
Â  Â  .time-btn{background:rgba(90,74,66,.1);border:none;border-radius:4px;color:#5A4A42;padding:4px 8px;cursor:pointer}
Â  Â  .time-btn.selected{background:#5A4A42;color:#F0EDE5;font-weight:bold}
Â  Â  .touch-controls{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(4,1fr);gap:10px;margin-top:auto}
Â  Â  .control-btn{background:rgba(168,159,148,.7);border:none;border-radius:12px;font-size:20px;display:flex;align-items:center;justify-content:center;padding:12px 0;cursor:pointer;color:#5A4A42}
Â  Â  .control-btn.up{grid-column:2;grid-row:1}
Â  Â  .control-btn.left{grid-column:1;grid-row:2}
Â  Â  .control-btn.right{grid-column:3;grid-row:2}
Â  Â  .control-btn.down{grid-column:2;grid-row:3}
Â  Â  .control-btn.start{grid-column:2;grid-row:2;font-size:16px;background:#A8B7A5}
Â  Â  .control-btn.pause{grid-column:2;grid-row:2;font-size:16px;background:#C4B6A0;display:none}
Â  Â  .control-btn.end{grid-column:1/span 3;grid-row:4;font-size:16px;background:#B7AFA1;display:none}
Â  Â  .resume-btn{background:#B7AFA1;color:#5A4A42;padding:10px 20px;border:none;border-radius:12px;font-size:16px;cursor:pointer;margin-top:auto;display:none}
Â  Â  @media(max-width:768px){
Â  Â  Â  Â  .control-btn.up,.control-btn.down,.control-btn.left,.control-btn.right{display:none}
Â  Â  Â  Â  .touch-controls{grid-template-rows:repeat(2,1fr)}
Â  Â  Â  Â  .right-panel{width:150px;font-size:13px}
Â  Â  }

Â  Â  /* Dialogs */
Â  Â  .confirmation-dialog,.results-screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:100;justify-content:center;align-items:center}
Â  Â  .confirmation-box,.results-content{background:#F0EDE5;padding:20px;border-radius:8px;text-align:center;max-width:300px;color:#5A4A42}
Â  Â  .results-content{background:#5A4A42;color:#F0EDE5}
Â  Â  .confirm-btn,.results-button{margin-top:15px;padding:8px 20px;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
Â  Â  .confirm-yes{background:#A8B7A5;color:#5A4A42}
Â  Â  .confirm-no{background:#B7AFA1;color:#5A4A42;margin-left:10px}
Â  Â  .results-button{background:#A89F94;color:#5A4A42}

Â  Â  /* Cute Animations */
Â  Â  @keyframes snakeWiggle {0%, 100% {transform: rotate(0deg);} 25% {transform: rotate(5deg);} 75% {transform: rotate(-5deg);}}
Â  Â  @keyframes bunJump {0%, 100% {transform: translateY(0) scale(1);} 50% {transform: translateY(-15px) scale(1.1);}}
Â  Â  @keyframes confettiFall {0% {transform: translateY(-100vh) rotate(0deg); opacity: 1;} 100% {transform: translateY(100vh) rotate(720deg); opacity: 0;}}
Â  Â  @keyframes gameOverSparkle {0%, 100% {opacity: 0.5;} 50% {opacity: 1; transform: scale(1.2);}}
Â  Â  .snake-head {animation: snakeWiggle 0.5s ease-in-out infinite;}
Â  Â  .jump-bun {animation: bunJump 0.6s ease-out;}
Â  Â  .confetti {position: absolute; width: 6px; height: 6px; pointer-events: none; border-radius: 50%; z-index: 50;}
Â  Â  .sparkle {position: absolute; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; pointer-events: none; z-index: 50; animation: gameOverSparkle 1s infinite;}
</style>
</head>
<body>

<div class="setup-screen" id="setup-screen">
Â  Â  <h2>Choose Your Level & Units</h2>
Â  Â  <select id="level-select">
Â  Â  Â  Â  <option value="1">Level 1</option>
Â  Â  Â  Â  <option value="2">Level 2</option>
Â  Â  Â  Â  <option value="3">Level 3</option>
Â  Â  Â  Â  <option value="4">Level 4</option>
Â  Â  Â  Â  <option value="5">Level 5</option>
Â  Â  Â  Â  <option value="6">Level 6</option>
Â  Â  </select>
Â  Â  <select id="unit-range-select">
Â  Â  Â  Â  <option value="1-5">Unit 1â€“5</option>
Â  Â  Â  Â  <option value="6-10">Unit 6â€“10</option>
Â  Â  Â  Â  <option value="11-15">Unit 11â€“15</option>
Â  Â  Â  Â  <option value="16-20">Unit 16â€“20</option>
Â  Â  Â  Â  <option value="21-25">Unit 21â€“25</option>
Â  Â  Â  Â  <option value="26-30">Unit 26â€“30</option>
Â  Â  Â  Â  <option value="31-35">Unit 31â€“35</option>
Â  Â  Â  Â  <option value="36-40">Unit 36â€“40</option>
Â  Â  Â  Â  <option value="41-45">Unit 41â€“45</option>
Â  Â  Â  Â  <option value="46-50">Unit 46â€“50</option>
Â  Â  </select>
Â  Â  <button class="start-game-btn" id="go-to-game">Start Game</button>
</div>

<div class="game-container" id="game-container" style="display:none">
Â  Â  <div class="game-area"><canvas id="game-board"></canvas></div>
Â  Â  <div class="right-panel">
Â  Â  Â  Â  <div class="question-box" id="question">Words</div>
Â  Â  Â  Â  <div class="score-container">
Â  Â  Â  Â  Â  Â  <div>Score: <span id="score">0</span></div>
Â  Â  Â  Â  Â  Â  <div>High: <span id="high-score">0</span></div>
Â  Â  Â  Â  Â  Â  <div>Length: <span id="snake-length">1</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="time-container">
Â  Â  Â  Â  Â  Â  <div>Time: <span id="time-left">00:00</span></div>
Â  Â  Â  Â  Â  Â  <div class="time-selector">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="time-btn" id="time-5">5m</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="time-btn selected" id="time-10">10m</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="time-btn" id="time-15">15m</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="touch-controls">
Â  Â  Â  Â  Â  Â  <button class="control-btn up">â†‘</button>
Â  Â  Â  Â  Â  Â  <button class="control-btn left">â†</button>
Â  Â  Â  Â  Â  Â  <button class="control-btn start" id="start-btn">Start</button>
Â  Â  Â  Â  Â  Â  <button class="control-btn pause" id="pause-btn">Pause</button>
Â  Â  Â  Â  Â  Â  <button class="control-btn end" id="end-btn">End Game</button>
Â  Â  Â  Â  Â  Â  <button class="control-btn down">â†“</button>
Â  Â  Â  Â  Â  Â  <button class="control-btn right">â†’</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="resume-btn" id="resume-btn">Resume</button>
Â  Â  </div>
</div>

<div class="confirmation-dialog" id="confirmation-dialog">
Â  Â  <div class="confirmation-box">
Â  Â  Â  Â  <h3>End game?</h3>
Â  Â  Â  Â  <p>Score: <span id="current-score">0</span><br>Length: <span id="current-length">1</span></p>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <button class="confirm-btn confirm-yes" id="confirm-yes">Yes</button>
Â  Â  Â  Â  Â  Â  <button class="confirm-btn confirm-no" id="confirm-no">No</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div class="results-screen" id="results-screen">
Â  Â  <div class="results-content">
Â  Â  Â  Â  <h2>Game Over ğŸ</h2>
Â  Â  Â  Â  <p>Score: <span id="final-score">0</span></p>
Â  Â  Â  Â  <p>Length: <span id="final-length">1</span></p>
Â  Â  Â  Â  <p>Time: <span id="game-time">00:00</span></p>
Â  Â  Â  Â  <button class="results-button" id="results-ok">Play Again</button>
Â  Â  </div>
</div>

<audio id="eat-sound" preload="auto">
Â  Â  <source src="https://assets.mixkit.co/sfx/preview/mixkit-coin-win-notification-1939.mp3" type="audio/mpeg">
</audio>
<audio id="wall-sound" preload="auto">
Â  Â  <source src="https://assets.mixkit.co/sfx/preview/mixkit-retro-game-jump-2071.mp3" type="audio/mpeg">
</audio>
<audio id="end-sound" preload="auto">
Â  Â  <source src="https://assets.mixkit.co/sfx/preview/mixkit-sad-sigh-2091.mp3" type="audio/mpeg">
</audio>

<script>
/* Global Vars */
let currentWordDatabase = [];

/* Fallback Data for Level 1 (from your CSV) */
const fallbackLevel1 = [
Â  Â  {level: '1', unit: 1, no: 1, word: 'action', pos: 'n.', meaning: 'åŠ¨ä½œ'},
Â  Â  {level: '1', unit: 1, no: 2, word: 'afternoon', pos: 'n.', meaning: 'ä¸‹åˆ;åˆå'},
Â  Â  {level: '1', unit: 1, no: 3, word: 'air', pos: 'n.', meaning: 'ç©ºæ°”'},
Â  Â  {level: '1', unit: 1, no: 4, word: 'banana', pos: 'n.', meaning: 'é¦™è•‰'},
Â  Â  {level: '1', unit: 1, no: 5, word: 'brown', pos: 'adj.; n.', meaning: 'æ£•è‰²çš„;æ£•è‰²'},
Â  Â  {level: '1', unit: 1, no: 6, word: 'card', pos: 'n.', meaning: 'å¡'},
Â  Â  {level: '1', unit: 1, no: 7, word: 'eat', pos: 'v.', meaning: 'åƒ'},
Â  Â  {level: '1', unit: 1, no: 8, word: 'farm', pos: 'n.', meaning: 'å†œåœº'},
Â  Â  {level: '1', unit: 1, no: 9, word: 'fifteen', pos: 'n., adj.', meaning: 'åäº”(çš„)'},
Â  Â  {level: '1', unit: 1, no: 10, word: 'first', pos: 'adv.', meaning: 'é¦–å…ˆ;ç¬¬ä¸€;æœ€æ—©'}
Â  Â  // Add more rows if your CSV has them; this matches your sample
];

/* Load Words (with fallback & error handling) */
async function loadWordsFromCSV(level, unitRange) {
Â  Â  console.log(`Loading Level ${level}, Units ${unitRange}...`);
Â  Â  let words = [];

Â  Â  // Fallback for Level 1
Â  Â  if (level === '1') {
Â  Â  Â  Â  const [startU, endU] = unitRange.split('-').map(Number);
Â  Â  Â  Â  words = fallbackLevel1.filter(w => w.unit >= startU && w.unit <= endU);
Â  Â  Â  Â  console.log(`Fallback loaded: ${words.length} words`);
Â  Â  Â  Â  if (words.length > 0) return words;
Â  Â  }

Â  Â  // Try fetch for other levels
Â  Â  try {
Â  Â  Â  Â  const csvUrl = `https://raw.githubusercontent.com/DuCJ-creator/iVocab-Self-Practice/main/level${level}.csv`;
Â  Â  Â  Â  console.log(`Fetching: ${csvUrl}`);
Â  Â  Â  Â  const resp = await fetch(csvUrl);
Â  Â  Â  Â  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
Â  Â  Â  Â  const text = await resp.text();
Â  Â  Â  Â  const lines = text.trim().split('\n');

Â  Â  Â  Â  const headers = lines[0].split(',').map(h => h.trim());
Â  Â  Â  Â  const idx = {
Â  Â  Â  Â  Â  Â  level: headers.indexOf('Level'),
Â  Â  Â  Â  Â  Â  unit: headers.indexOf('Unit'),
Â  Â  Â  Â  Â  Â  no: headers.indexOf('No.'),
Â  Â  Â  Â  Â  Â  word: headers.indexOf('Word'),
Â  Â  Â  Â  Â  Â  pos: headers.indexOf('POS'),
Â  Â  Â  Â  Â  Â  meaning: headers.indexOf('Chinese Meaning')
Â  Â  Â  Â  };

Â  Â  Â  Â  if (Object.values(idx).some(i => i === -1)) throw new Error('Missing columns');

Â  Â  Â  Â  for (let i = 1; i < lines.length; i++) {
Â  Â  Â  Â  Â  Â  const row = lines[i].split(',').map(c => c.trim());
Â  Â  Â  Â  Â  Â  if (row.length < Math.max(...Object.values(idx)) + 1) continue;
Â  Â  Â  Â  Â  Â  words.push({
Â  Â  Â  Â  Â  Â  Â  Â  level: row[idx.level],
Â  Â  Â  Â  Â  Â  Â  Â  unit: Number(row[idx.unit]),
Â  Â  Â  Â  Â  Â  Â  Â  no: Number(row[idx.no]),
Â  Â  Â  Â  Â  Â  Â  Â  word: row[idx.word],
Â  Â  Â  Â  Â  Â  Â  Â  pos: row[idx.pos],
Â  Â  Â  Â  Â  Â  Â  Â  meaning: row[idx.meaning]
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const [startU, endU] = unitRange.split('-').map(Number);
Â  Â  Â  Â  words = words.filter(w => w.unit >= startU && w.unit <= endU);
Â  Â  Â  Â  console.log(`Loaded: ${words.length} words`);
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Fetch failed:', e);
Â  Â  Â  Â  alert(`Failed to load Level ${level} (CORS?). Using fallback or try Level 1.`);
Â  Â  Â  Â  // For non-Level 1, you can add more fallbacks here
Â  Â  Â  Â  words = [];
Â  Â  }

Â  Â  if (words.length === 0) {
Â  Â  Â  Â  alert(`No words found! Try Level 1.`);
Â  Â  }
Â  Â  return words;
}

/* Start Game from Setup */
document.getElementById('go-to-game').addEventListener('click', async () => {
Â  Â  const level = document.getElementById('level-select').value;
Â  Â  const unitRange = document.getElementById('unit-range-select').value;
Â  Â  const words = await loadWordsFromCSV(level, unitRange);
Â  Â  if (words.length === 0) return;
Â  Â  currentWordDatabase = words;
Â  Â  document.getElementById('setup-screen').style.display = 'none';
Â  Â  document.getElementById('game-container').style.display = 'flex';
Â  Â  // è¼‰å…¥å–®å­—å¾Œï¼Œç«‹å³å•Ÿå‹•éŠæˆ²
Â  Â  startGame(); 
Â  Â  console.log('Game setup complete and started!');
});

/* Game Core (Canvas & Logic) */
const canvas = document.getElementById('game-board');
const ctx = canvas.getContext('2d');
// ... (all other element refs, game vars, functions like newQuestion, genFoods, draw, move, etc. - same as previous version)
const startBtn = document.getElementById('start-btn');
const pauseBtn = document.getElementById('pause-btn');
const endBtn = document.getElementById('end-btn');
const resumeBtn = document.getElementById('resume-btn');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('high-score');
const lengthEl = document.getElementById('snake-length');
const questionEl = document.getElementById('question');
const timeEl = document.getElementById('time-left');
const time5 = document.getElementById('time-5');
const time10 = document.getElementById('time-10');
const time15 = document.getElementById('time-15');
const confirmDlg = document.getElementById('confirmation-dialog');
const confirmYes = document.getElementById('confirm-yes');
const confirmNo = document.getElementById('confirm-no');
const currentScore = document.getElementById('current-score');
const currentLength = document.getElementById('current-length');
const resultsScreen = document.getElementById('results-screen');
const finalScore = document.getElementById('final-score');
const finalLength = document.getElementById('final-length');
const gameTime = document.getElementById('game-time');
const resultsOk = document.getElementById('results-ok');

const eatSound = document.getElementById('eat-sound');
const wallSound = document.getElementById('wall-sound');
const endSound = document.getElementById('end-sound');

function resizeCanvas() {
Â  Â  const s = Math.min(canvas.parentElement.clientWidth, canvas.parentElement.clientHeight);
Â  Â  canvas.width = s;
Â  Â  canvas.height = s;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const GRID = 20;
let snakeGrid = [], snakePos = [], direction = 'right', nextDirection = 'right';
let moveProgress = 0, lastTime = 0;
let baseTime = 180, acceleration = 0, maxAcc = 0.7;
let foods = [], score = 0, highScore = Number(localStorage.getItem('snakeHighScore') || 0);
let gameStarted = false, gamePaused = false, gameEnded = false;
let correctCount = 0, penalty = 0, timeLeft = 600, timer;
let invincible = false, usedWords = [], startTime = 0, currentQuestion = null;

const formatTime = s => `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
const lerp = (a, b, t) => a + (b - a) * t;

function selectTime(m) {
Â  Â  [time5, time10, time15].forEach(b => b.classList.remove('selected'));
Â  Â  if (m === 5) time5.classList.add('selected');
Â  Â  else if (m === 10) time10.classList.add('selected');
Â  Â  else time15.classList.add('selected');
Â  Â  timeLeft = m * 60;
Â  Â  timeEl.textContent = formatTime(timeLeft);
}

function newQuestion() {
Â  Â  if (!currentWordDatabase.length) {
Â  Â  Â  Â  questionEl.textContent = 'No words loaded! Try Level 1.';
Â  Â  Â  Â  console.error('No words in database');
Â  Â  Â  Â  return null;
Â  Â  }
Â  Â  if (usedWords.length >= currentWordDatabase.length) usedWords = [];
Â  Â  const avail = currentWordDatabase.filter(w => !usedWords.includes(w.word));
Â  Â  if (avail.length === 0) return null;
Â  Â  const q = avail[Math.floor(Math.random() * avail.length)];
Â  Â  usedWords.push(q.word);
Â  Â  currentQuestion = q;
Â  Â  questionEl.textContent = `${q.word} (${q.pos})`; // Responsive size via CSS
Â  Â  console.log('New question:', q.word);
Â  Â  return q;
}

function genFoods(correctMeaning) {
Â  Â  const uniques = [...new Set(currentWordDatabase.map(w => w.meaning))];
Â  Â  const wrongs = uniques.filter(m => m !== correctMeaning).sort(() => 0.5 - Math.random()).slice(0, 3);
Â  Â  const options = [...wrongs, correctMeaning].sort(() => 0.5 - Math.random());
Â  Â  const free = [];
Â  Â  for (let y = 0; y < GRID; y++) {
Â  Â  Â  Â  for (let x = 0; x < GRID; x++) {
Â  Â  Â  Â  Â  Â  if (!snakeGrid.some(s => s.x === x && s.y === y)) free.push({ x, y });
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (free.length < 4) { foods = []; return; }
Â  Â  const chosen = [];
Â  Â  while (chosen.length < 4) {
Â  Â  Â  Â  const idx = Math.floor(Math.random() * free.length);
Â  Â  Â  Â  chosen.push(free.splice(idx, 1)[0]);
Â  Â  }
Â  Â  foods = chosen.map((cell, i) => ({
Â  Â  Â  Â  x: cell.x, y: cell.y,
Â  Â  Â  Â  meaning: options[i],
Â  Â  Â  Â  correct: options[i] === correctMeaning
Â  Â  }));
}

function ensureFourFoods() {
Â  Â  if (!currentQuestion) return;
Â  Â  if (foods.length === 4) return;
Â  Â  const occupied = new Set(snakeGrid.map(s => `${s.x},${s.y}`));
Â  Â  foods.forEach(f => occupied.add(`${f.x},${f.y}`));
Â  Â  const freeCells = [];
Â  Â  for (let y = 0; y < GRID; y++) for (let x = 0; x < GRID; x++) {
Â  Â  Â  Â  const k = `${x},${y}`;
Â  Â  Â  Â  if (!occupied.has(k)) freeCells.push({ x, y });
Â  Â  }
Â  Â  if (!freeCells.length) return;
Â  Â  const correct = currentQuestion.meaning;
Â  Â  const pool = [...new Set(currentWordDatabase.map(w => w.meaning))].filter(m => m !== correct);
Â  Â  while (foods.length < 4 && freeCells.length) {
Â  Â  Â  Â  const needCorrect = foods.every(f => !f.correct);
Â  Â  Â  Â  const meaning = needCorrect ? correct : pool[Math.floor(Math.random() * pool.length)];
Â  Â  Â  Â  const cell = freeCells.splice(Math.floor(Math.random() * freeCells.length), 1)[0];
Â  Â  Â  Â  foods.push({ x: cell.x, y: cell.y, meaning, correct: meaning === correct });
Â  Â  }
Â  Â  if (foods.length && foods.every(f => !f.correct)) {
Â  Â  Â  Â  const j = Math.floor(Math.random() * foods.length);
Â  Â  Â  Â  foods[j] = { ...foods[j], meaning: correct, correct: true };
Â  Â  }
}

function draw() {
Â  Â  const sz = canvas.width / GRID;
Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);

Â  Â  // Snake body
Â  Â  for (let i = 1; i < snakePos.length; i++) {
Â  Â  Â  Â  const s = snakePos[i];
Â  Â  Â  Â  ctx.fillStyle = '#A8B7A5';
Â  Â  Â  Â  ctx.beginPath(); ctx.arc(s.x, s.y, sz * 0.45, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  ctx.strokeStyle = '#8C9D8A'; ctx.lineWidth = 2; ctx.stroke();
Â  Â  }

Â  Â  // Snake head (with wiggle class for animation)
Â  Â  if (snakePos.length) {
Â  Â  Â  Â  const h = snakePos[0];
Â  Â  Â  Â  ctx.fillStyle = invincible ? 'rgba(216,168,168,.7)' : '#D8A8A8';
Â  Â  Â  Â  ctx.beginPath(); ctx.arc(h.x, h.y, sz * 0.48, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  ctx.strokeStyle = '#B78A8A'; ctx.lineWidth = 2; ctx.stroke();
Â  Â  Â  Â  // Eyes
Â  Â  Â  Â  ctx.fillStyle = '#fff'; const e = sz * 0.2;
Â  Â  Â  Â  let ex1, ey1, ex2, ey2;
Â  Â  Â  Â  if (direction === 'right') { ex1 = ex2 = h.x + e; ey1 = h.y - e; ey2 = h.y + e; }
Â  Â  Â  Â  else if (direction === 'left') { ex1 = ex2 = h.x - e; ey1 = h.y - e; ey2 = h.y + e; }
Â  Â  Â  Â  else if (direction === 'up') { ey1 = ey2 = h.y - e; ex1 = h.x - e; ex2 = h.x + e; }
Â  Â  Â  Â  else { ey1 = ey2 = h.y + e; ex1 = h.x - e; ex2 = h.x + e; }
Â  Â  Â  Â  ctx.beginPath(); ctx.arc(ex1, ey1, sz * 0.12, 0, Math.PI * 2); ctx.arc(ex2, ey2, sz * 0.12, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  // Cute tongue if moving right
Â  Â  Â  Â  if (direction === 'right') {
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#FF69B4'; ctx.beginPath(); ctx.ellipse(h.x + sz * 0.3, h.y, sz * 0.1, sz * 0.05, 0, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Foods (buns with jump on correct)
Â  Â  foods.forEach(f => {
Â  Â  Â  Â  const cx = (f.x + 0.5) * sz, cy = (f.y + 0.5) * sz;
Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  if (f.correct) ctx.translate(0, Math.sin(Date.now() / 300) * 3); // Subtle bob
Â  Â  Â  Â  ctx.fillStyle = '#D8C4A8';
Â  Â  Â  Â  ctx.beginPath(); ctx.ellipse(cx, cy, sz * 0.8, sz * 0.6, 0, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  ctx.strokeStyle = '#C4B6A0'; ctx.lineWidth = 2; ctx.stroke();
Â  Â  Â  Â  // Cute steam if correct
Â  Â  Â  Â  if (f.correct) {
Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'rgba(255,255,255,0.6)';Â 
Â  Â  Â  Â  Â  Â  for (let i = 0; i < 3; i++) ctx.beginPath(); ctx.arc(cx + i*5 - 5, cy - sz*0.4, 2, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  }
Â  Â  Â  Â  ctx.restore();

Â  Â  Â  Â  // Meaning text
Â  Â  Â  Â  ctx.fillStyle = '#000';
Â  Â  Â  Â  ctx.font = `${Math.max(12, Math.floor(sz * 0.28))}px sans-serif`;
Â  Â  Â  Â  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
Â  Â  Â  Â  const ws = f.meaning.split(';'), h = Math.max(16, Math.floor(sz * 0.32)), sy = cy - (ws.length - 1) * h / 2;
Â  Â  Â  Â  ws.forEach((w, i) => {
Â  Â  Â  Â  Â  Â  const txt = w.trim().length > 8 ? w.trim().substring(0, 7) + '...' : w.trim();
Â  Â  Â  Â  Â  Â  ctx.fillText(txt, cx, sy + i * h);
Â  Â  Â  Â  });
Â  Â  });
}

function applyPenaltyAndRefresh() {
Â  Â  penalty = (penalty || 0) + 1;
Â  Â  const cost = penalty * 10;
Â  Â  if (score >= cost) {
Â  Â  Â  Â  score -= cost;
Â  Â  Â  Â  for (let i = 0; i < penalty && snakeGrid.length > 1; i++) snakeGrid.pop();
Â  Â  Â  Â  snakePos.length = snakeGrid.length;
Â  Â  Â  Â  const q = newQuestion();
Â  Â  Â  Â  if (q) { foods = []; genFoods(q.meaning); ensureFourFoods(); }
Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  // Penalty flash
Â  Â  Â  Â  ctx.fillStyle = 'rgba(183,175,161,.3)'; ctx.fillRect(0, 0, canvas.width, canvas.height); setTimeout(draw, 180);
Â  Â  Â  Â  wallSound.play().catch(() => {});
Â  Â  } else {
Â  Â  Â  Â  gameOver();
Â  Â  }
}

function moveSnake() {
Â  Â  const head = { ...snakeGrid[0] };
Â  Â  switch (nextDirection) {
Â  Â  Â  Â  case 'up': head.y--; break;
Â  Â  Â  Â  case 'down': head.y++; break;
Â  Â  Â  Â  case 'left': head.x--; break;
Â  Â  Â  Â  case 'right': head.x++; break;
Â  Â  }
Â  Â  direction = nextDirection;

Â  Â  if (head.x < 0 || head.x >= GRID || head.y < 0 || head.y >= GRID ||
Â  Â  Â  Â  snakeGrid.some((s, i) => i > 0 && s.x === head.x && s.y === head.y)) {
Â  Â  Â  Â  if (!invincible && timeLeft > 0) applyPenaltyAndRefresh();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  snakeGrid.unshift(head);
Â  Â  const sz = canvas.width / GRID;
Â  Â  const headC = { x: (head.x + 0.5) * sz, y: (head.y + 0.5) * sz };
Â  Â  const eatDist = sz * 0.9;
Â  Â  let eaten = false;
Â  Â  for (let i = 0; i < foods.length; i++) {
Â  Â  Â  Â  const f = foods[i], fc = { x: (f.x + 0.5) * sz, y: (f.y + 0.5) * sz };
Â  Â  Â  Â  if (Math.hypot(headC.x - fc.x, headC.y - fc.y) < eatDist) {
Â  Â  Â  Â  Â  Â  if (f.correct) {
Â  Â  Â  Â  Â  Â  Â  Â  correctCount++;
Â  Â  Â  Â  Â  Â  Â  Â  score += correctCount * 10;
Â  Â  Â  Â  Â  Â  Â  Â  if (score > highScore) { highScore = score; localStorage.setItem('snakeHighScore', String(highScore)); }
Â  Â  Â  Â  Â  Â  Â  Â  invincible = true; setTimeout(() => invincible = false, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  eatSound.play().catch(() => {});
Â  Â  Â  Â  Â  Â  Â  Â  confettiBurst(headC.x + canvas.offsetLeft, headC.y + canvas.offsetTop); // Screen coords for confetti
Â  Â  Â  Â  Â  Â  Â  Â  const q = newQuestion();
Â  Â  Â  Â  Â  Â  Â  Â  if (q) { foods = []; genFoods(q.meaning); ensureFourFoods(); }
Â  Â  Â  Â  Â  Â  Â  Â  eaten = true;
Â  Â  Â  Â  Â  Â  Â  Â  // Jump animation for eaten bun (visual feedback)
Â  Â  Â  Â  Â  Â  Â  Â  const jumpEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  jumpEl.className = 'jump-bun confetti';
Â  Â  Â  Â  Â  Â  Â  Â  jumpEl.style.left = `${headC.x - 10 + canvas.offsetLeft}px`;
Â  Â  Â  Â  Â  Â  Â  Â  jumpEl.style.top = `${headC.y - 10 + canvas.offsetTop}px`;
Â  Â  Â  Â  Â  Â  Â  Â  jumpEl.style.background = '#FFD700';
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(jumpEl);
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => jumpEl.remove(), 600);
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (!invincible && timeLeft > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  applyPenaltyAndRefresh();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (!eaten && snakeGrid.length > 1) snakeGrid.pop();
Â  Â  snakePos.length = snakeGrid.length;
Â  Â  ensureFourFoods();
Â  Â  updateUI();
}

function updateUI() {
Â  Â  scoreEl.textContent = score;
Â  Â  highScoreEl.textContent = highScore;
Â  Â  lengthEl.textContent = snakeGrid.length;
Â  Â  timeEl.textContent = formatTime(timeLeft);
}

function gameOver() {
Â  Â  if (gameEnded) return;
Â  Â  gameEnded = true;
Â  Â  clearInterval(timer);
Â  Â  gameStarted = false;
Â  Â  endSound.play().catch(() => {});
Â  Â  // Cute game over sparkles
Â  Â  for (let i = 0; i < 20; i++) {
Â  Â  Â  Â  const sparkle = document.createElement('div');
Â  Â  Â  Â  sparkle.className = 'sparkle';
Â  Â  Â  Â  sparkle.style.left = `${Math.random() * window.innerWidth}px`;
Â  Â  Â  Â  sparkle.style.top = `${Math.random() * window.innerHeight}px`;
Â  Â  Â  Â  document.body.appendChild(sparkle);
Â  Â  Â  Â  setTimeout(() => sparkle.remove(), 2000);
Â  Â  }
Â  Â  showResults();
}

function showResults() {
Â  Â  const elapsed = Math.floor((Date.now() - startTime) / 1000);
Â  Â  finalScore.textContent = score;
Â  Â  finalLength.textContent = snakeGrid.length;
Â  Â  gameTime.textContent = formatTime(elapsed);
Â  Â  resultsScreen.style.display = 'flex';
Â  Â  startBtn.style.display = 'flex';
Â  Â  pauseBtn.style.display = 'none';
Â  Â  endBtn.style.display = 'none';
Â  Â  resumeBtn.style.display = 'none';
}

function gameLoop(ts) {
Â  Â  if (!gameStarted || gamePaused || gameEnded) {
Â  Â  Â  Â  requestAnimationFrame(gameLoop);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  const dt = ts - lastTime;
Â  Â  lastTime = ts;
Â  Â  const moveT = baseTime * (1 - acceleration * maxAcc);
Â  Â  moveProgress += dt / moveT;
Â  Â  if (moveProgress >= 1) {
Â  Â  Â  Â  moveProgress = 0;
Â  Â  Â  Â  moveSnake();
Â  Â  }
Â  Â  const sz = canvas.width / GRID;
Â  Â  if (snakeGrid.length) {
Â  Â  Â  Â  const tx = (snakeGrid[0].x + 0.5) * sz, ty = (snakeGrid[0].y + 0.5) * sz;
Â  Â  Â  Â  snakePos[0] = { x: lerp(snakePos[0]?.x || tx, tx, moveProgress), y: lerp(snakePos[0]?.y || ty, ty, moveProgress) };
Â  Â  Â  Â  for (let i = 1; i < snakeGrid.length; i++) snakePos[i] = { x: (snakeGrid[i].x + 0.5) * sz, y: (snakeGrid[i].y + 0.5) * sz };
Â  Â  }
Â  Â  draw();
Â  Â  requestAnimationFrame(gameLoop);
}

function startGame() {
Â  Â  // ç§»é™¤ if (gameStarted && !gameEnded) return; ç¢ºä¿æ¯æ¬¡é»æ“Šéƒ½èƒ½é‡æ–°åˆå§‹åŒ–

Â  Â  // é‡ç½®ä¸¦åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹
Â  Â  snakeGrid = [{ x: Math.floor(GRID / 2), y: Math.floor(GRID / 2) }];
Â  Â  const sz = canvas.width / GRID;
Â  Â  snakePos = [{ x: (snakeGrid[0].x + 0.5) * sz, y: (snakeGrid[0].y + 0.5) * sz }];
Â  Â  direction = 'right';
Â  Â  nextDirection = 'right';
Â  Â  moveProgress = 0;
Â  Â  score = 0;
Â  Â  correctCount = 0;
Â  Â  penalty = 0;
Â  Â  usedWords = [];
Â  Â  gameEnded = false;
Â  Â  gamePaused = false;
Â  Â  invincible = false;
Â  Â  
Â  Â  const q = newQuestion();
Â  Â  if (!q) {
Â  Â  Â  Â  alert('Word database error! Reload and try Level 1.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  genFoods(q.meaning);
Â  Â  ensureFourFoods();
Â  Â  updateUI();
Â  Â  startTime = Date.now();
Â  Â  clearInterval(timer);
Â  Â  timer = setInterval(() => {
Â  Â  Â  Â  if (timeLeft <= 0) {
Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  gameOver();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  timeLeft--;
Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  }
Â  Â  }, 1000);
Â  Â  gameStarted = true;
Â  Â  lastTime = performance.now();
Â  Â  requestAnimationFrame(gameLoop);
Â  Â  startBtn.style.display = 'none';
Â  Â  pauseBtn.style.display = 'flex';
Â  Â  endBtn.style.display = 'flex';
Â  Â  resumeBtn.style.display = 'none';
Â  Â  console.log('Game started!');
}

function togglePause() {
Â  Â  if (!gameStarted) return startGame();
Â  Â  gamePaused = !gamePaused;
Â  Â  pauseBtn.textContent = gamePaused ? 'Resume' : 'Pause';
Â  Â  pauseBtn.style.display = gamePaused ? 'none' : 'flex';
Â  Â  resumeBtn.style.display = gamePaused ? 'block' : 'none';
Â  Â  if (!gamePaused) draw();
}

function resumeGame() { togglePause(); }

function endConfirm() {
Â  Â  if (!gameStarted || gameEnded) return;
Â  Â  gamePaused = true;
Â  Â  currentScore.textContent = score;
Â  Â  currentLength.textContent = snakeGrid.length;
Â  Â  confirmDlg.style.display = 'flex';
}

function endNow() {
Â  Â  clearInterval(timer);
Â  Â  gameEnded = true;
Â  Â  gameStarted = false;
Â  Â  confirmDlg.style.display = 'none';
Â  Â  showResults();
}

// Confetti Burst (cute celebration)
function confettiBurst(x, y) {
Â  Â  const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
Â  Â  for (let i = 0; i < 30; i++) {
Â  Â  Â  Â  const conf = document.createElement('div');
Â  Â  Â  Â  conf.className = 'confetti';
Â  Â  Â  Â  conf.style.left = `${x}px`;
Â  Â  Â  Â  conf.style.top = `${y}px`;
Â  Â  Â  Â  conf.style.background = colors[Math.floor(Math.random() * colors.length)];
Â  Â  Â  Â  conf.style.transform = `translate(${Math.random() * 20 - 10}px, ${Math.random() * 20 - 10}px)`;
Â  Â  Â  Â  document.body.appendChild(conf);
Â  Â  Â  Â  conf.animate([
Â  Â  Â  Â  Â  Â  { transform: 'translateY(0px) rotate(0deg)', opacity: 1 },
Â  Â  Â  Â  Â  Â  { transform: `translateY(${window.innerHeight}px) rotate(720deg)`, opacity: 0 }
Â  Â  Â  Â  ], {
Â  Â  Â  Â  Â  Â  duration: 1000 + Math.random() * 1000,
Â  Â  Â  Â  Â  Â  easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
Â  Â  Â  Â  }).onfinish = () => conf.remove();
Â  Â  }
}

// Event Listeners
startBtn.addEventListener('click', startGame);
pauseBtn.addEventListener('click', togglePause);
resumeBtn.addEventListener('click', resumeGame);
endBtn.addEventListener('click', endConfirm);
confirmYes.addEventListener('click', endNow);
confirmNo.addEventListener('click', () => { confirmDlg.style.display = 'none'; gamePaused = false; });
resultsOk.addEventListener('click', () => { resultsScreen.style.display = 'none'; });
time5.addEventListener('click', () => selectTime(5));
time10.addEventListener('click', () => selectTime(10));
time15.addEventListener('click', () => selectTime(15));
selectTime(10);

// Touch & Keyboard Controls
let touchX = 0, touchY = 0;
canvas.addEventListener('touchstart', e => { touchX = e.touches[0].clientX; touchY = e.touches[0].clientY; e.preventDefault(); }, { passive: false });
canvas.addEventListener('touchmove', e => {
Â  Â  if (!gameStarted || gamePaused || gameEnded) return;
Â  Â  const dx = e.touches[0].clientX - touchX, dy = e.touches[0].clientY - touchY, threshold = 30;
Â  Â  if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
Â  Â  Â  Â  nextDirection = dx > 0 && direction !== 'left' ? 'right' : (dx < 0 && direction !== 'right' ? 'left' : direction);
Â  Â  Â  Â  touchX = e.touches[0].clientX;
Â  Â  } else if (Math.abs(dy) > threshold) {
Â  Â  Â  Â  nextDirection = dy > 0 && direction !== 'up' ? 'down' : (dy < 0 && direction !== 'down' ? 'up' : direction);
Â  Â  Â  Â  touchY = e.touches[0].clientY;
Â  Â  }
Â  Â  e.preventDefault();
}, { passive: false });

document.addEventListener('keydown', e => {
Â  Â  if (e.key === ' ') { e.preventDefault(); !gameStarted ? startGame() : togglePause(); }
Â  Â  else if (['ArrowUp', 'w', 'W'].includes(e.key) && direction !== 'down') { nextDirection = 'up'; e.preventDefault(); }
Â  Â  else if (['ArrowDown', 's', 'S'].includes(e.key) && direction !== 'up') { nextDirection = 'down'; e.preventDefault(); }
Â  Â  else if (['ArrowLeft', 'a', 'A'].includes(e.key) && direction !== 'right') { nextDirection = 'left'; e.preventDefault(); }
Â  Â  else if (['ArrowRight', 'd', 'D'].includes(e.key) && direction !== 'left') { nextDirection = 'right'; e.preventDefault(); }
Â  Â  else if (e.key === 'Escape' && gameStarted) { endConfirm(); e.preventDefault(); }
});

// Init
draw();
console.log('Page loaded. Open console for logs.');
</script>
</body>
</html>
