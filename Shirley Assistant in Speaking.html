<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Assistant in Speaking</title>
    <style>
        /* ÂéüÊúâ CSS ÂÆåÂÖ®‰øùÁïô */
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff7e5f;
            --light-color: #f5f7fa;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            font-size: 2.2em;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color), #ff9a7f);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
        }
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        .btn-error {
            background: linear-gradient(135deg, var(--error-color), #c0392b);
        }
        .hidden {
            display: none !important;
        }
        .practice-item {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        .practice-item:hover {
            transform: translateY(-2px);
        }
        .sentence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .sentence-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .sentence-source {
            font-size: 14px;
            color: #666;
        }
        .sentence-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .sentence-text {
            flex-grow: 1;
            font-size: 18px;
            font-weight: 500;
            color: var(--dark-color);
        }
        .audio-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: white;
            margin-left: 15px;
            padding: 12px;
            border-radius: 50%;
            min-width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .recording-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .recording-btn {
            padding: 18px 35px;
            border-radius: 50px;
            font-weight: 600;
            margin-bottom: 20px;
            width: 100%;
            max-width: 250px;
            font-size: 18px;
        }
        .recording-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            background-color: var(--error-color);
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .feedback-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }
        .feedback-item {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .feedback-positive {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.1));
            border-left: 4px solid var(--success-color);
        }
        .feedback-improve {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
            border-left: 4px solid var(--warning-color);
        }
        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 25px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        .report-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }
        .report-info-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .report-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .report-info-label {
            font-weight: 600;
            color: var(--primary-color);
        }
        .report-score {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 30px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .report-feedback {
            margin-top: 30px;
        }
        .sentence-list {
            margin: 20px 0;
        }
        .sentence-score-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        .sentence-score {
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 5px;
        }
        .print-btn {
            display: block;
            margin: 30px auto 0;
            max-width: 200px;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }
        .navigation .btn {
            width: auto;
            flex: 1;
        }
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        .status-error {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.1));
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }
        .status-info {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(41, 128, 185, 0.1));
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        .permission-prompt {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
            border: 2px solid var(--warning-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
            color: #666;
            font-size: 1.1em;
        }
        .sentence-source {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .sentence-source-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .sentence-source-btn:hover {
            background: #e9ecef;
        }
        .sentence-source-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .level-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .level-btn {
            padding: 12px;
            text-align: center;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .level-btn:hover {
            background: #e9ecef;
        }
        .level-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .feedback-bilingual {
            margin-bottom: 10px;
        }
        .feedback-english {
            font-weight: 500;
        }
        .feedback-chinese {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .score-breakdown {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        .score-label {
            font-weight: 500;
        }
        .score-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        .pronunciation-details {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--primary-color);
        }
        .detail-item {
            margin: 5px 0;
            padding: 3px 0;
        }
        .word-analysis {
            background: #f0f8ff;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #4a6fa5;
        }
        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 3px 0;
        }
        .word-correct {
            color: var(--success-color);
            font-weight: 600;
        }
        .word-incorrect {
            color: var(--error-color);
            font-weight: 600;
        }
        .accuracy-meter {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--primary-color));
            transition: width 0.5s ease;
        }
        /* ÊâãÊ©üÈÅ©ÈÖç */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; border-radius: 10px; }
            h1 { font-size: 1.8em; }
            .practice-item { padding: 20px; }
            .sentence-container { flex-direction: column; align-items: flex-start; padding: 15px; }
            .audio-btn { margin-left: 0; margin-top: 15px; align-self: center; }
            .report-info-line { flex-direction: column; align-items: flex-start; gap: 8px; }
            .navigation { flex-direction: column; }
            .btn { padding: 18px; }
            .sentence-source { flex-direction: column; }
            .level-selection { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            body { padding: 5px; }
            .container { padding: 15px; }
            h1 { font-size: 1.5em; }
            .sentence-text { font-size: 16px; }
            .recording-btn { padding: 20px; font-size: 16px; }
            .level-selection { grid-template-columns: 1fr; }
        }
        @media print {
            body { background: white !important; padding: 0; }
            .container { box-shadow: none !important; border-radius: 0 !important; }
            .btn { display: none !important; }
            .practice-item, .report-section { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Student Information Input Page -->
        <div id="student-info-page">
            <h1>Shirley's AI Assistant in Speaking</h1>
            <div class="welcome-message">
                Improve your English pronunciation with instant AI feedback! Please fill in the information below to start practicing.
            </div>
            <div class="form-group">
                <label for="class">Class</label>
                <input type="text" id="class" placeholder="">
            </div>
            <div class="form-group">
                <label for="seat-no">Seat Number</label>
                <input type="number" id="seat-no" min="1" max="99" placeholder="">
            </div>
            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" placeholder="">
            </div>
            <div class="form-group">
                <label>Sentence Source</label>
                <div class="sentence-source">
                    <div class="sentence-source-btn active" data-source="manual">Enter Manually</div>
                    <div class="sentence-source-btn" data-source="level">From Sentence Bank</div>
                </div>
                <div id="manual-input" class="sentence-input">
                    <label for="sentences">Practice Sentences (one per line, maximum 10)</label>
                    <textarea id="sentences" placeholder="Enter or paste sentences to practice, one per line"></textarea>
                </div>
                <div id="level-input" class="sentence-input hidden">
                    <label>Select Difficulty Level</label>
                    <div class="level-selection">
                        <div class="level-btn" data-level="1">Level 1</div>
                        <div class="level-btn" data-level="2">Level 2</div>
                        <div class="level-btn" data-level="3">Level 3</div>
                        <div class="level-btn" data-level="4">Level 4</div>
                        <div class="level-btn" data-level="5">Level 5</div>
                        <div class="level-btn" data-level="6">Level 6</div>
                    </div>
                    <button id="load-level-sentences" class="btn btn-accent" style="margin-top: 15px;">Load 10 Random Sentences</button>
                </div>
            </div>
            <button id="start-practice" class="btn">Start Practice</button>
        </div>
        <!-- Practice Page -->
        <div id="practice-page" class="hidden">
            <h1>English Pronunciation Practice</h1>
            <div class="progress-bar">
                <div id="progress" class="progress"></div>
            </div>
            <div id="practice-container">
                <!-- Practice items will be dynamically generated here -->
            </div>
            <div class="navigation">
                <button id="prev-sentence" class="btn">Previous</button>
                <button id="next-sentence" class="btn">Next</button>
            </div>
            <button id="finish-practice" class="btn btn-accent">Finish Practice</button>
        </div>
        <!-- Report Page -->
        <div id="report-page" class="hidden">
            <div class="report-section">
                <div class="report-header">
                    <h1>English Pronunciation Practice Report</h1>
                </div>
                <div class="report-info-line">
                    <div class="report-info-item">
                        <span class="report-info-label">Class:</span>
                        <span id="report-class"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Seat No:</span>
                        <span id="report-seat-no"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Name:</span>
                        <span id="report-name"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Date:</span>
                        <span id="report-date"></span>
                    </div>
                </div>
                <div class="report-score">
                    Overall Pronunciation Score: <span id="overall-score">85</span>/100
                </div>
                <div class="sentence-list">
                    <h3>Practice Sentences & Scores</h3>
                    <div id="sentence-scores-content">
                        <!-- Sentence scores will be dynamically generated here -->
                    </div>
                </div>
                <div class="report-feedback">
                    <h3>Comprehensive Feedback</h3>
                    <div id="report-feedback-content">
                        <!-- Feedback content will be dynamically generated here -->
                    </div>
                </div>
                <button id="print-report" class="btn print-btn">Print Report</button>
                <button id="new-practice" class="btn btn-accent print-btn">New Practice</button>
            </div>
        </div>
    </div>

    <script>
        // =============== ÈÖçÁΩÆÂçÄ ===============
        let studentInfo = {};
        let sentences = [];
        let currentSentenceIndex = 0;
        let feedbackData = [];
        let sentenceSource = 'manual';
        let selectedLevel = null;
        let usedSentences = {};
        let currentTranscript = ''; // Áî®Êñº‰øùÂ≠òË≠òÂà•ÁµêÊûú
        let isRecognizing = false;
        let recognition = null;

        const SHEET_ID = '1EbMNgRD3WRVr2KVFFBkqOATeR-QI4YgcHlpDtrcwa0w';
        const SHEET_NAMES = {
            1: 'Level 1',
            2: 'Level 2', 
            3: 'Level 3',
            4: 'Level 4',
            5: 'Level 5',
            6: 'Level 6'
        };

        // DOM ÂÖÉÁ¥†
        const studentInfoPage = document.getElementById('student-info-page');
        const practicePage = document.getElementById('practice-page');
        const reportPage = document.getElementById('report-page');
        const startPracticeBtn = document.getElementById('start-practice');
        const finishPracticeBtn = document.getElementById('finish-practice');
        const prevSentenceBtn = document.getElementById('prev-sentence');
        const nextSentenceBtn = document.getElementById('next-sentence');
        const printReportBtn = document.getElementById('print-report');
        const newPracticeBtn = document.getElementById('new-practice');
        const practiceContainer = document.getElementById('practice-container');
        const progressBar = document.getElementById('progress');
        const manualInput = document.getElementById('manual-input');
        const levelInput = document.getElementById('level-input');
        const loadLevelSentencesBtn = document.getElementById('load-level-sentences');

        // =============== ‰∫ã‰ª∂Á∂ÅÂÆö ===============
        startPracticeBtn.addEventListener('click', startPractice);
        finishPracticeBtn.addEventListener('click', finishPractice);
        prevSentenceBtn.addEventListener('click', showPreviousSentence);
        nextSentenceBtn.addEventListener('click', showNextSentence);
        printReportBtn.addEventListener('click', printReport);
        newPracticeBtn.addEventListener('click', startNewPractice);
        loadLevelSentencesBtn.addEventListener('click', loadLevelSentences);

        document.querySelectorAll('.sentence-source-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.sentence-source-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                sentenceSource = this.getAttribute('data-source');
                if (sentenceSource === 'manual') {
                    manualInput.classList.remove('hidden');
                    levelInput.classList.add('hidden');
                } else {
                    manualInput.classList.add('hidden');
                    levelInput.classList.remove('hidden');
                }
            });
        });

        document.querySelectorAll('.level-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedLevel = this.getAttribute('data-level');
            });
        });

        // =============== Ë™ûÈü≥Ë≠òÂà•ÂàùÂßãÂåñ ===============
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("‚ùå Your browser doesn't support speech recognition. Please use Chrome or Edge.");
                throw new Error("SpeechRecognition not supported");
            }
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecognizing = true;
                document.getElementById('recording-indicator').classList.remove('hidden');
                document.getElementById('record-btn').textContent = 'üõë Stop Listening';
                document.getElementById('record-btn').classList.remove('btn-success');
                document.getElementById('record-btn').classList.add('btn-error');
                showStatusMessage('üé§ Listening... Please start speaking.', 'info');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                handleRecognitionResult(transcript);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                isRecognizing = false;
                document.getElementById('recording-error').textContent = `‚ùå Recognition failed: ${event.error}`;
                document.getElementById('recording-error').classList.remove('hidden');
                document.getElementById('recording-indicator').classList.add('hidden');
                document.getElementById('record-btn').textContent = 'üé§ Start Recording';
                document.getElementById('record-btn').classList.remove('btn-error');
                document.getElementById('record-btn').classList.add('btn-success');
                showStatusMessage('‚ùå Speech recognition failed.', 'error');
            };

            recognition.onend = () => {
                if (!isRecognizing) return;
                isRecognizing = false;
                document.getElementById('recording-indicator').classList.add('hidden');
                if (!document.getElementById('playback-section').classList.contains('hidden')) {
                    document.getElementById('record-btn').textContent = 'üé§ Record Again';
                } else {
                    document.getElementById('record-btn').textContent = 'üé§ Start Recording';
                    document.getElementById('record-btn').classList.remove('btn-error');
                    document.getElementById('record-btn').classList.add('btn-success');
                }
            };
        }

        // =============== Google Sheets ËôïÁêÜ ===============
        async function loadLevelSentences() {
            if (!selectedLevel) {
                showStatusMessage('Please select a difficulty level first', 'error', levelInput);
                return;
            }
            try {
                showStatusMessage(`Loading sentences from Level ${selectedLevel}...`, 'info', levelInput);
                const levelData = await fetchLevelSentences(selectedLevel);
                if (levelData.length === 0) {
                    showStatusMessage('No sentences found for this level', 'error', levelInput);
                    return;
                }

                const levelKey = `level_${selectedLevel}`;
                const used = usedSentences[levelKey] || [];
                const availableData = levelData.filter(item => !used.includes(item.number));
                if (availableData.length < 10) {
                    usedSentences[levelKey] = [];
                }

                const shuffled = [...availableData].sort(() => 0.5 - Math.random());
                const selectedData = shuffled.slice(0, 10);
                usedSentences[levelKey] = [...(usedSentences[levelKey] || []), ...selectedData.map(item => item.number)];

                const formattedSentences = selectedData.map((item, index) => 
                    `${item.sentence} [${index + 1}/10 - Level ${selectedLevel}, Sentence ${item.number}]`
                );
                document.getElementById('sentences').value = formattedSentences.join('\n');
                showStatusMessage(`10 random sentences loaded from Level ${selectedLevel}!`, 'info', levelInput);
            } catch (error) {
                console.error('Error loading level sentences:', error);
                showStatusMessage('Failed to load sentences from Google Sheets.', 'error', levelInput);
            }
        }

        async function fetchLevelSentences(level) {
            const sheetName = SHEET_NAMES[level];
            if (!sheetName) throw new Error(`Invalid level: ${level}`);
            const exportUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
            const response = await fetch(exportUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            return parseCSV(csvText, level);
        }

        function parseCSV(csvText, level) {
            const lines = csvText.split('\n');
            const sentenceData = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const columns = parseCSVLine(line);
                    if (columns.length >= 2) {
                        const number = columns[0].replace(/^"|"$/g, '').trim();
                        const sentence = columns[1].replace(/^"|"$/g, '').trim();
                        if (number && sentence && !isNaN(parseInt(number))) {
                            sentenceData.push({ number, sentence });
                        }
                    }
                }
            }
            return sentenceData;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // „ÄêÈóúÈçµ„ÄëÁßªÈô§Êú¨Âú∞ÂÇôÁî®Âè•Â≠êÔºåÂº∑Âà∂‰æùË≥¥Á∂≤Ë∑Ø
        function getDefaultSentencesForLevel(level) {
            throw new Error(`Failed to load from Google Sheets for Level ${level}.`);
        }

        // =============== ‰∏ªÊµÅÁ®ã ===============
        function startPractice() {
            const className = document.getElementById('class').value;
            const seatNo = document.getElementById('seat-no').value;
            const name = document.getElementById('name').value;
            if (!className || !seatNo || !name) {
                showStatusMessage('Please fill in all fields', 'error');
                return;
            }

            let sentenceArray = [];
            if (sentenceSource === 'manual') {
                const sentencesText = document.getElementById('sentences').value;
                sentenceArray = sentencesText.split('\n').map(s => s.trim()).filter(s => s).slice(0, 10);
            } else {
                const sentencesText = document.getElementById('sentences').value;
                sentenceArray = sentencesText.split('\n').map(s => s.trim()).filter(s => s);
            }

            if (sentenceArray.length === 0) {
                showStatusMessage('Please enter or load at least one sentence', 'error');
                return;
            }

            studentInfo = { className, seatNo, name };
            sentences = sentenceArray;
            currentSentenceIndex = 0;
            feedbackData = [];
            currentTranscript = '';

            studentInfoPage.classList.add('hidden');
            practicePage.classList.remove('hidden');
            showCurrentSentence();
            updateProgress();
        }

        function showCurrentSentence() {
            practiceContainer.innerHTML = '';
            const sentence = sentences[currentSentenceIndex];
            const sentenceMatch = sentence.match(/^(.+?)\s*\[(\d+\/10)\s*-\s*(Level\s+\d+,\s*Sentence\s+\d+)\]$/);
            const displaySentence = sentenceMatch ? sentenceMatch[1] : sentence;
            const practiceNumber = sentenceMatch ? sentenceMatch[2] : `${currentSentenceIndex + 1}/10`;
            const sentenceInfo = sentenceMatch ? sentenceMatch[3] : null;

            practiceContainer.innerHTML = `
                <div class="practice-item">
                    <div class="sentence-header">
                        <div class="sentence-number">Sentence ${practiceNumber}</div>
                        ${sentenceInfo ? `<div class="sentence-source">${sentenceInfo}</div>` : ''}
                    </div>
                    <div class="sentence-container">
                        <div class="sentence-text">${displaySentence}</div>
                        <button class="audio-btn" data-sentence="${displaySentence}" title="Listen to original">üîä</button>
                    </div>
                    <div class="recording-controls">
                        <button id="record-btn" class="btn recording-btn btn-success">üé§ Start Recording</button>
                        <div id="recording-indicator" class="hidden">
                            <span class="recording-indicator"></span> üî¥ Listening... 
                        </div>
                        <div id="recording-error" class="hidden status-error" style="margin-top: 10px;">
                            ‚ùå Speech recognition failed.
                        </div>
                    </div>
                    <div id="playback-section" class="hidden">
                        <p><strong>You said:</strong> "<span id="user-transcript"></span>"</p>
                        <button id="analyze-btn" class="btn btn-success" style="margin-top: 15px;">ü§ñ Analyze Pronunciation</button>
                    </div>
                    <div id="feedback-section" class="feedback-section hidden">
                        <h3>üí° Pronunciation Feedback</h3>
                        <div id="score-breakdown"></div>
                        <div id="pronunciation-details"></div>
                        <div id="feedback-content"></div>
                    </div>
                </div>
            `;

            document.querySelector('.audio-btn').addEventListener('click', function() {
                const utter = new SpeechSynthesisUtterance(this.getAttribute('data-sentence'));
                utter.lang = 'en-US'; utter.rate = 0.9;
                speechSynthesis.speak(utter);
            });

            document.getElementById('record-btn').addEventListener('click', toggleRecording);
            document.getElementById('analyze-btn').addEventListener('click', analyzePronunciation);
        }

        // =============== Ë™ûÈü≥Êìç‰Ωú ===============
        async function toggleRecording() {
            if (!recognition) initSpeechRecognition();
            if (!isRecognizing) {
                document.getElementById('playback-section').classList.add('hidden');
                document.getElementById('recording-error').classList.add('hidden');
                document.getElementById('feedback-section').classList.add('hidden');
                currentTranscript = '';
                recognition.start();
            } else {
                recognition.stop();
            }
        }

        function handleRecognitionResult(transcript) {
            currentTranscript = transcript;
            document.getElementById('user-transcript').textContent = transcript;
            document.getElementById('playback-section').classList.remove('hidden');
            showStatusMessage('‚úÖ Speech recognized! Ready to analyze.', 'info');
        }

        // =============== ÂàÜÊûêÈÇèËºØ ===============
        async function analyzePronunciation() {
            if (!currentTranscript) {
                showStatusMessage('‚ùå No speech recognized. Please record again.', 'error');
                return;
            }

            const currentSentence = sentences[currentSentenceIndex];
            const cleanOriginal = currentSentence.replace(/\s*\[\d+\/10\s*-\s*Level\s+\d+,\s*Sentence\s+\d+\]/, '').trim().toLowerCase();
            const userTranscript = currentTranscript.trim().toLowerCase();

            const distance = levenshteinDistance(cleanOriginal, userTranscript);
            const maxLength = Math.max(cleanOriginal.length, userTranscript.length);
            const similarity = maxLength > 0 ? (1 - distance / maxLength) : 0;
            const score = Math.round(similarity * 100);

            let feedbackMessage, feedbackType;
            if (score >= 85) {
                feedbackMessage = "Excellent! Your pronunciation was very accurate.";
                feedbackType = "positive";
            } else if (score >= 70) {
                feedbackMessage = "Good job! There are a few words you can practice.";
                feedbackType = "positive";
            } else {
                feedbackMessage = "Keep practicing! Focus on saying the sentence more clearly.";
                feedbackType = "improve";
            }

            const feedback = [{ aspect: "Overall Accuracy", aspect_zh: "Êï¥È´îÊ∫ñÁ¢∫Â∫¶", message: feedbackMessage, message_zh: feedbackMessage, type: feedbackType }];

            document.getElementById('score-breakdown').innerHTML = `
                <div class="score-breakdown">
                    <h4>Score Breakdown:</h4>
                    <div class="score-item">
                        <span class="score-label">Text Similarity:</span>
                        <span class="score-value">${score}/100</span>
                    </div>
                    <div class="score-item" style="border-top: 2px solid var(--primary-color); padding-top: 8px; margin-top: 8px;">
                        <span class="score-label" style="font-weight: 700;">Total Score:</span>
                        <span class="score-value" style="font-size: 1.2em;">${score}/100</span>
                    </div>
                </div>
            `;

            document.getElementById('pronunciation-details').innerHTML = `
                <div class="pronunciation-details">
                    <h4>Recognition Result:</h4>
                    <div class="detail-item"><strong>Original:</strong> ${cleanOriginal}</div>
                    <div class="detail-item"><strong>Your Speech:</strong> ${userTranscript}</div>
                </div>
            `;

            const feedbackContent = document.getElementById('feedback-content');
            feedbackContent.innerHTML = '';
            feedback.forEach(item => {
                const feedbackItem = document.createElement('div');
                feedbackItem.className = `feedback-item ${item.type === 'positive' ? 'feedback-positive' : 'feedback-improve'}`;
                feedbackItem.innerHTML = `<div class="feedback-english"><strong>${item.aspect}:</strong> ${item.message}</div>`;
                feedbackContent.appendChild(feedbackItem);
            });

            document.getElementById('feedback-section').classList.remove('hidden');

            feedbackData[currentSentenceIndex] = {
                sentence: currentSentence,
                feedback: feedback,
                score: score,
                scoreBreakdown: [{ category: "Text Similarity", score: score }],
                pronunciationDetails: null,
                recordingSuccessful: true
            };

            showStatusMessage(`‚úÖ Analysis completed! Score: ${score}/100`, 'info');
        }

        // =============== Â∑•ÂÖ∑ÂáΩÊï∏ ===============
        function levenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = Array(b.length + 1).fill().map((_, i) => [i]);
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    const cost = b[i-1] === a[j-1] ? 0 : 1;
                    matrix[i][j] = Math.min(matrix[i-1][j] + 1, matrix[i][j-1] + 1, matrix[i-1][j-1] + cost);
                }
            }
            return matrix[b.length][a.length];
        }

        function showStatusMessage(message, type, container = document.body) {
            const existing = container.querySelector('.status-message');
            if (existing) existing.remove();
            const el = document.createElement('div');
            el.className = `status-message status-${type}`;
            el.textContent = message;
            container.insertBefore(el, container.firstChild);
            setTimeout(() => el.remove(), type === 'error' ? 8000 : 5000);
        }

        function showPreviousSentence() {
            if (currentSentenceIndex > 0) {
                currentSentenceIndex--;
                showCurrentSentence();
                updateProgress();
            }
        }

        function showNextSentence() {
            if (currentSentenceIndex < sentences.length - 1) {
                currentSentenceIndex++;
                showCurrentSentence();
                updateProgress();
            }
        }

        function updateProgress() {
            const progress = ((currentSentenceIndex + 1) / sentences.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function finishPractice() {
            const completed = feedbackData.filter(item => item !== undefined).length;
            if (completed < sentences.length) {
                if (!confirm(`You have completed ${completed}/${sentences.length} sentences. Finish now?`)) return;
            }
            practicePage.classList.add('hidden');
            reportPage.classList.remove('hidden');
            generateReport();
        }

        function generateReport() {
            document.getElementById('report-class').textContent = studentInfo.className;
            document.getElementById('report-seat-no').textContent = studentInfo.seatNo;
            document.getElementById('report-name').textContent = studentInfo.name;
            document.getElementById('report-date').textContent = new Date().toLocaleDateString('en-US');

            const scores = feedbackData.filter(item => item).map(item => item.score);
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            document.getElementById('overall-score').textContent = avgScore;

            const sentenceScoresContent = document.getElementById('sentence-scores-content');
            sentenceScoresContent.innerHTML = '';
            sentences.forEach((sentence, index) => {
                const feedback = feedbackData[index];
                const score = feedback ? feedback.score : 'Not analyzed';
                const clean = sentence.replace(/\s*\[\d+\/10\s*-\s*Level\s+\d+,\s*Sentence\s+\d+\]/, '');
                const el = document.createElement('div');
                el.className = 'sentence-score-item';
                el.innerHTML = `<div><strong>Sentence ${index + 1}:</strong> ${clean}</div><div class="sentence-score">Score: ${score}/100</div>`;
                sentenceScoresContent.appendChild(el);
            });

            const feedbackContent = document.getElementById('report-feedback-content');
            feedbackContent.innerHTML = '';
            if (feedbackData.length === 0) {
                feedbackContent.innerHTML = '<p>No pronunciation analysis completed.</p>';
                return;
            }

            const finalFeedback = [{
                aspect: 'Overall Performance',
                aspect_zh: 'Êï¥È´îË°®Áèæ',
                message: avgScore >= 80 ? 'Great work!' : 'Keep practicing regularly.',
                message_zh: avgScore >= 80 ? 'ÂÅöÂæóÂæàÂ•ΩÔºÅ' : 'Ë´ãÊåÅÁ∫åÁ∑¥Áøí„ÄÇ',
                type: avgScore >= 80 ? 'positive' : 'improve'
            }];

            finalFeedback.forEach(item => {
                const el = document.createElement('div');
                el.className = `feedback-item ${item.type === 'positive' ? 'feedback-positive' : 'feedback-improve'}`;
                el.innerHTML = `<div class="feedback-english"><strong>${item.aspect}:</strong> ${item.message}</div>`;
                feedbackContent.appendChild(el);
            });
        }

        function printReport() {
            window.print();
        }

        function startNewPractice() {
            studentInfo = {};
            sentences = [];
            currentSentenceIndex = 0;
            feedbackData = [];
            currentTranscript = '';
            isRecognizing = false;
            recognition = null;

            // Reset UI
            ['class', 'seat-no', 'name', 'sentences'].forEach(id => document.getElementById(id).value = '');
            document.querySelectorAll('.sentence-source-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.sentence-source-btn[data-source="manual"]').classList.add('active');
            sentenceSource = 'manual';
            manualInput.classList.remove('hidden');
            levelInput.classList.add('hidden');
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            selectedLevel = null;

            reportPage.classList.add('hidden');
            studentInfoPage.classList.remove('hidden');
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Shirley's AI Assistant in Speaking (Real Speech Recognition) loaded.");
        });
    </script>
</body>
</html>
