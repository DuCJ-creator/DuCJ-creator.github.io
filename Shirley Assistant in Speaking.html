<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Assistant in Speaking</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff7e5f;
            --light-color: #f5f7fa;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            font-size: 2.2em;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color), #ff9a7f);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .btn-error {
            background: linear-gradient(135deg, var(--error-color), #c0392b);
        }
        
        .hidden {
            display: none !important;
        }
        
        .practice-item {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .practice-item:hover {
            transform: translateY(-2px);
        }
        
        .sentence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sentence-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .sentence-source {
            font-size: 14px;
            color: #666;
        }
        
        .sentence-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .sentence-text {
            flex-grow: 1;
            font-size: 18px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .audio-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: white;
            margin-left: 15px;
            padding: 12px;
            border-radius: 50%;
            min-width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .recording-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .recording-btn {
            padding: 18px 35px;
            border-radius: 50px;
            font-weight: 600;
            margin-bottom: 20px;
            width: 100%;
            max-width: 250px;
            font-size: 18px;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            background-color: var(--error-color);
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { 
                transform: scale(1);
                opacity: 1; 
            }
            50% { 
                transform: scale(1.2);
                opacity: 0.7; 
            }
            100% { 
                transform: scale(1);
                opacity: 1; 
            }
        }
        
        .feedback-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }
        
        .feedback-item {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .feedback-positive {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.1));
            border-left: 4px solid var(--success-color);
        }
        
        .feedback-improve {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
            border-left: 4px solid var(--warning-color);
        }
        
        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 25px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .report-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .report-info-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .report-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .report-info-label {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .report-score {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 30px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-feedback {
            margin-top: 30px;
        }
        
        .sentence-list {
            margin: 20px 0;
        }
        
        .sentence-score-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .sentence-score {
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 5px;
        }
        
        .print-btn {
            display: block;
            margin: 30px auto 0;
            max-width: 200px;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }
        
        .navigation .btn {
            width: auto;
            flex: 1;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        
        .status-error {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.1));
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }
        
        .status-info {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(41, 128, 185, 0.1));
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        
        .permission-prompt {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
            border: 2px solid var(--warning-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
            color: #666;
            font-size: 1.1em;
        }
        
        .sentence-source {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .sentence-source-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sentence-source-btn:hover {
            background: #e9ecef;
        }
        
        .sentence-source-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .level-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .level-btn {
            padding: 12px;
            text-align: center;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .level-btn:hover {
            background: #e9ecef;
        }
        
        .level-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .feedback-bilingual {
            margin-bottom: 10px;
        }
        
        .feedback-english {
            font-weight: 500;
        }
        
        .feedback-chinese {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .score-breakdown {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .score-label {
            font-weight: 500;
        }
        
        .score-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .pronunciation-details {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--primary-color);
        }

        .detail-item {
            margin: 5px 0;
            padding: 3px 0;
        }

        /* ÊâãÊ©üÈÅ©ÈÖç */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .practice-item {
                padding: 20px;
            }
            
            .sentence-container {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }
            
            .audio-btn {
                margin-left: 0;
                margin-top: 15px;
                align-self: center;
            }
            
            .report-info-line {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .navigation {
                flex-direction: column;
            }
            
            .btn {
                padding: 18px;
            }
            
            .sentence-source {
                flex-direction: column;
            }
            
            .level-selection {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .sentence-text {
                font-size: 16px;
            }
            
            .recording-btn {
                padding: 20px;
                font-size: 16px;
            }
            
            .level-selection {
                grid-template-columns: 1fr;
            }
        }

        /* ÊâìÂç∞Ê®£Âºè */
        @media print {
            body {
                background: white !important;
                padding: 0;
            }
            
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            
            .btn {
                display: none !important;
            }
            
            .practice-item, .report-section {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Student Information Input Page -->
        <div id="student-info-page">
            <h1>Shirley's AI Assistant in Speaking</h1>
            <div class="welcome-message">
                Improve your English pronunciation with instant AI feedback! Please fill in the information below to start practicing.
            </div>
            
            <div class="form-group">
                <label for="class">Class</label>
                <input type="text" id="class" placeholder="">
            </div>
            
            <div class="form-group">
                <label for="seat-no">Seat Number</label>
                <input type="number" id="seat-no" min="1" max="99" placeholder="">
            </div>
            
            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" placeholder="">
            </div>
            
            <div class="form-group">
                <label>Sentence Source</label>
                <div class="sentence-source">
                    <div class="sentence-source-btn active" data-source="manual">Enter Manually</div>
                    <div class="sentence-source-btn" data-source="level">From Sentence Bank</div>
                </div>
                
                <div id="manual-input" class="sentence-input">
                    <label for="sentences">Practice Sentences (one per line, maximum 10)</label>
                    <textarea id="sentences" placeholder="Enter or paste sentences to practice, one per line"></textarea>
                </div>
                
                <div id="level-input" class="sentence-input hidden">
                    <label>Select Difficulty Level</label>
                    <div class="level-selection">
                        <div class="level-btn" data-level="1">Level 1</div>
                        <div class="level-btn" data-level="2">Level 2</div>
                        <div class="level-btn" data-level="3">Level 3</div>
                        <div class="level-btn" data-level="4">Level 4</div>
                        <div class="level-btn" data-level="5">Level 5</div>
                        <div class="level-btn" data-level="6">Level 6</div>
                    </div>
                    <button id="load-level-sentences" class="btn btn-accent" style="margin-top: 15px;">Load 10 Random Sentences</button>
                </div>
            </div>
            
            <button id="start-practice" class="btn">Start Practice</button>
        </div>
        
        <!-- Practice Page -->
        <div id="practice-page" class="hidden">
            <h1>English Pronunciation Practice</h1>
            
            <div class="progress-bar">
                <div id="progress" class="progress"></div>
            </div>
            
            <div id="practice-container">
                <!-- Practice items will be dynamically generated here -->
            </div>
            
            <div class="navigation">
                <button id="prev-sentence" class="btn">Previous</button>
                <button id="next-sentence" class="btn">Next</button>
            </div>
            
            <button id="finish-practice" class="btn btn-accent">Finish Practice</button>
        </div>
        
        <!-- Report Page -->
        <div id="report-page" class="hidden">
            <div class="report-section">
                <div class="report-header">
                    <h1>English Pronunciation Practice Report</h1>
                </div>
                
                <div class="report-info-line">
                    <div class="report-info-item">
                        <span class="report-info-label">Class:</span>
                        <span id="report-class"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Seat No:</span>
                        <span id="report-seat-no"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Name:</span>
                        <span id="report-name"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Date:</span>
                        <span id="report-date"></span>
                    </div>
                </div>
                
                <div class="report-score">
                    Overall Pronunciation Score: <span id="overall-score">85</span>/100
                </div>
                
                <div class="sentence-list">
                    <h3>Practice Sentences & Scores</h3>
                    <div id="sentence-scores-content">
                        <!-- Sentence scores will be dynamically generated here -->
                    </div>
                </div>
                
                <div class="report-feedback">
                    <h3>Comprehensive Feedback</h3>
                    <div id="report-feedback-content">
                        <!-- Feedback content will be dynamically generated here -->
                    </div>
                </div>
                
                <button id="print-report" class="btn print-btn">Print Report</button>
                <button id="new-practice" class="btn btn-accent print-btn">New Practice</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let studentInfo = {};
        let sentences = [];
        let currentSentenceIndex = 0;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let feedbackData = [];
        let hasRequestedPermission = false;
        let sentenceSource = 'manual';
        let selectedLevel = null;
        let usedSentences = {};
        let currentStream = null;
        let recordingFailed = false;
        let recordingDuration = 0;
        let recordingStartTime = 0;
        
        // DOM elements
        const studentInfoPage = document.getElementById('student-info-page');
        const practicePage = document.getElementById('practice-page');
        const reportPage = document.getElementById('report-page');
        const startPracticeBtn = document.getElementById('start-practice');
        const finishPracticeBtn = document.getElementById('finish-practice');
        const prevSentenceBtn = document.getElementById('prev-sentence');
        const nextSentenceBtn = document.getElementById('next-sentence');
        const printReportBtn = document.getElementById('print-report');
        const newPracticeBtn = document.getElementById('new-practice');
        const practiceContainer = document.getElementById('practice-container');
        const progressBar = document.getElementById('progress');
        const manualInput = document.getElementById('manual-input');
        const levelInput = document.getElementById('level-input');
        const loadLevelSentencesBtn = document.getElementById('load-level-sentences');
        
        // ÁôºÈü≥Ë©ïÂàÜÊ®ôÊ∫ñÊï∏ÊìöÂ∫´
        const pronunciationStandards = {
            vowels: {
                'a': { correct: '√¶', difficulty: 2 },
                'e': { correct: '…õ', difficulty: 2 },
                'i': { correct: '…™', difficulty: 2 },
                'o': { correct: '…ë', difficulty: 2 },
                'u': { correct: ' å', difficulty: 2 },
                'ee': { correct: 'i', difficulty: 3 },
                'oo': { correct: 'u', difficulty: 3 },
                'ai': { correct: 'e…™', difficulty: 4 },
                'ay': { correct: 'e…™', difficulty: 4 },
                'ea': { correct: 'i', difficulty: 4 },
                'ou': { correct: 'a ä', difficulty: 4 },
                'ow': { correct: 'a ä', difficulty: 4 },
                'oi': { correct: '…î…™', difficulty: 4 },
                'oy': { correct: '…î…™', difficulty: 4 }
            },
            
            consonants: {
                'th': { correct: 'Œ∏', difficulty: 5 },
                'sh': { correct: ' É', difficulty: 3 },
                'ch': { correct: 't É', difficulty: 3 },
                'ph': { correct: 'f', difficulty: 2 },
                'gh': { correct: 'f', difficulty: 4 },
                'ng': { correct: '≈ã', difficulty: 3 },
                'wh': { correct: 'hw', difficulty: 4 }
            }
        };

        // Event listeners
        startPracticeBtn.addEventListener('click', startPractice);
        finishPracticeBtn.addEventListener('click', finishPractice);
        prevSentenceBtn.addEventListener('click', showPreviousSentence);
        nextSentenceBtn.addEventListener('click', showNextSentence);
        printReportBtn.addEventListener('click', printReport);
        newPracticeBtn.addEventListener('click', startNewPractice);
        loadLevelSentencesBtn.addEventListener('click', loadLevelSentences);
        
        // Sentence source selection
        document.querySelectorAll('.sentence-source-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.sentence-source-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                sentenceSource = this.getAttribute('data-source');
                
                if (sentenceSource === 'manual') {
                    manualInput.classList.remove('hidden');
                    levelInput.classList.add('hidden');
                } else {
                    manualInput.classList.add('hidden');
                    levelInput.classList.remove('hidden');
                }
            });
        });
        
        // Level selection
        document.querySelectorAll('.level-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedLevel = this.getAttribute('data-level');
            });
        });
        
        // Initialize speech synthesis
        let speechSynthesis = window.speechSynthesis;
        
        // Load random sentences from selected level
        async function loadLevelSentences() {
            if (!selectedLevel) {
                showStatusMessage('Please select a difficulty level first', 'error', levelInput);
                return;
            }
            
            try {
                showStatusMessage(`Loading sentences from Level ${selectedLevel}...`, 'info', levelInput);
                
                const levelData = getDefaultSentencesForLevel(selectedLevel);
                
                const formattedSentences = levelData.map((item, index) => 
                    `${item.sentence} [${index + 1}/10 - Level ${selectedLevel}, Sentence ${item.number}]`
                );
                
                document.getElementById('sentences').value = formattedSentences.join('\n');
                showStatusMessage(`10 sentences loaded from Level ${selectedLevel}!`, 'info', levelInput);
                
            } catch (error) {
                console.error('Error loading level sentences:', error);
                showStatusMessage('Error loading sentences. Please try again.', 'error', levelInput);
            }
        }
        
        // Default sentences fallback for each level
        function getDefaultSentencesForLevel(level) {
            const defaultSentences = {
                1: [
                    { number: "1", sentence: "Hello, how are you?" },
                    { number: "2", sentence: "My name is John." },
                    { number: "3", sentence: "I like to read books." },
                    { number: "4", sentence: "The weather is nice today." },
                    { number: "5", sentence: "What is your favorite color?" },
                    { number: "6", sentence: "I have two brothers." },
                    { number: "7", sentence: "She is a good student." },
                    { number: "8", sentence: "We go to school every day." },
                    { number: "9", sentence: "Can you help me, please?" },
                    { number: "10", sentence: "I love my family." }
                ],
                2: [
                    { number: "1", sentence: "I would like to order a coffee, please." },
                    { number: "2", sentence: "Could you tell me the time?" },
                    { number: "3", sentence: "What do you do for a living?" },
                    { number: "4", sentence: "I enjoy watching movies on weekends." },
                    { number: "5", sentence: "She has been studying English for three years." },
                    { number: "6", sentence: "We should meet for lunch sometime." },
                    { number: "7", sentence: "The restaurant around the corner serves great food." },
                    { number: "8", sentence: "He is planning to visit his grandparents next month." },
                    { number: "9", sentence: "I need to finish this report by Friday." },
                    { number: "10", sentence: "They are going to the beach this weekend." }
                ],
                3: [
                    { number: "1", sentence: "Despite the heavy rain, the outdoor concert continued as scheduled." },
                    { number: "2", sentence: "The company is considering several candidates for the management position." },
                    { number: "3", sentence: "She expressed her concerns about the proposed changes to the project." },
                    { number: "4", sentence: "After careful consideration, we decided to implement the new policy." },
                    { number: "5", sentence: "The research findings suggest a correlation between diet and health." },
                    { number: "6", sentence: "He emphasized the importance of maintaining a positive attitude." },
                    { number: "7", sentence: "The committee will review all applications by the end of the week." },
                    { number: "8", sentence: "We appreciate your cooperation in this matter." },
                    { number: "9", sentence: "The new regulations will take effect starting next month." },
                    { number: "10", sentence: "They conducted a comprehensive analysis of the market trends." }
                ]
            };
            
            return defaultSentences[level] || defaultSentences[1];
        }
        
        // Show status message
        function showStatusMessage(message, type, container = document.body) {
            const existingMessage = container.querySelector('.status-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const statusMessage = document.createElement('div');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = message;
            
            container.insertBefore(statusMessage, container.firstChild);
            
            const timeout = type === 'error' ? 8000 : 5000;
            setTimeout(() => {
                if (statusMessage.parentNode) {
                    statusMessage.remove();
                }
            }, timeout);
        }
        
        // Start practice
        function startPractice() {
            const className = document.getElementById('class').value;
            const seatNo = document.getElementById('seat-no').value;
            const name = document.getElementById('name').value;
            
            if (!className || !seatNo || !name) {
                showStatusMessage('Please fill in all fields', 'error');
                return;
            }
            
            let sentenceArray = [];
            
            if (sentenceSource === 'manual') {
                const sentencesText = document.getElementById('sentences').value;
                sentenceArray = sentencesText.split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0)
                    .slice(0, 10);
            } else {
                const sentencesText = document.getElementById('sentences').value;
                sentenceArray = sentencesText.split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);
            }
            
            if (sentenceArray.length === 0) {
                showStatusMessage('Please enter at least one sentence or load sentences from the bank', 'error');
                return;
            }
            
            studentInfo = { className, seatNo, name };
            sentences = sentenceArray;
            currentSentenceIndex = 0;
            feedbackData = [];
            recordingFailed = false;
            
            studentInfoPage.classList.add('hidden');
            practicePage.classList.remove('hidden');
            
            showCurrentSentence();
            updateProgress();
        }
        
        // Show current sentence
        function showCurrentSentence() {
            practiceContainer.innerHTML = '';
            
            const sentence = sentences[currentSentenceIndex];
            
            const practiceItem = document.createElement('div');
            practiceItem.className = 'practice-item';
            
            const sentenceMatch = sentence.match(/^(.+?)\s*\[(\d+\/10)\s*-\s*(Level\s+\d+,\s*Sentence\s+\d+)\]$/);
            const displaySentence = sentenceMatch ? sentenceMatch[1] : sentence;
            const practiceNumber = sentenceMatch ? sentenceMatch[2] : `${currentSentenceIndex + 1}/10`;
            const sentenceInfo = sentenceMatch ? sentenceMatch[3] : null;
            
            practiceItem.innerHTML = `
                <div class="sentence-header">
                    <div class="sentence-number">Sentence ${practiceNumber}</div>
                    ${sentenceInfo ? `<div class="sentence-source">${sentenceInfo}</div>` : ''}
                </div>
                <div class="sentence-container">
                    <div class="sentence-text">${displaySentence}</div>
                    <button class="audio-btn" data-sentence="${displaySentence}" title="Listen to original">üîä</button>
                </div>
                
                <div class="recording-controls">
                    <button id="record-btn" class="btn recording-btn btn-success">üé§ Start Recording</button>
                    <div id="recording-indicator" class="hidden">
                        <span class="recording-indicator"></span> üî¥ Recording... <span id="recording-timer">0s</span>
                    </div>
                    <div id="recording-error" class="hidden status-error" style="margin-top: 10px;">
                        ‚ùå Recording failed. Please check microphone permissions.
                    </div>
                </div>
                
                <div id="playback-section" class="hidden">
                    <p>üéß Your recording:</p>
                    <audio id="playback-audio" controls style="width: 100%; margin: 15px 0;"></audio>
                    <button id="analyze-btn" class="btn btn-success" style="margin-top: 15px;">ü§ñ Analyze Pronunciation</button>
                </div>
                
                <div id="feedback-section" class="feedback-section hidden">
                    <h3>üí° Pronunciation Feedback</h3>
                    <div id="score-breakdown"></div>
                    <div id="pronunciation-details"></div>
                    <div id="feedback-content"></div>
                </div>
            `;
            
            practiceContainer.appendChild(practiceItem);
            
            const audioBtn = practiceItem.querySelector('.audio-btn');
            audioBtn.addEventListener('click', function() {
                playSentence(this.getAttribute('data-sentence'));
            });
            
            const recordBtn = document.getElementById('record-btn');
            recordBtn.addEventListener('click', toggleRecording);
            
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.addEventListener('click', analyzePronunciation);
        }
        
        // Play sentence audio
        function playSentence(sentence) {
            speechSynthesis.cancel();
            
            const cleanSentence = sentence.replace(/\s*\[.*?\]/g, '').trim();
            
            const utterance = new SpeechSynthesisUtterance(cleanSentence);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            
            utterance.onerror = function(event) {
                console.error('Audio playback error:', event);
                showStatusMessage('‚ùå Audio playback failed, please try again', 'error');
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // Toggle recording state
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }
        
        // Start recording with improved error handling
        async function startRecording() {
            try {
                recordingFailed = false;
                recordingDuration = 0;
                document.getElementById('recording-error').classList.add('hidden');
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Your browser does not support recording');
                }
                
                showStatusMessage('üé§ Requesting microphone permission...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                currentStream = stream;
                hasRequestedPermission = true;
                
                const options = { 
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 128000
                };
                
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch (e) {
                    console.warn('Using default MIME type');
                    mediaRecorder = new MediaRecorder(stream);
                }
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    if (recordingFailed) return;
                    
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const playbackAudio = document.getElementById('playback-audio');
                    playbackAudio.src = audioUrl;
                    
                    document.getElementById('playback-section').classList.remove('hidden');
                    showStatusMessage('‚úÖ Recording completed! You can now analyze your pronunciation.', 'info');
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event);
                    recordingFailed = true;
                    showStatusMessage('‚ùå An error occurred during recording', 'error');
                };
                
                mediaRecorder.start(100);
                isRecording = true;
                recordingStartTime = Date.now();
                
                // Start timer
                const timerElement = document.getElementById('recording-timer');
                const timerInterval = setInterval(() => {
                    if (isRecording) {
                        recordingDuration = Math.floor((Date.now() - recordingStartTime) / 1000);
                        timerElement.textContent = `${recordingDuration}s`;
                    } else {
                        clearInterval(timerInterval);
                    }
                }, 1000);
                
                document.getElementById('record-btn').textContent = 'üõë Stop Recording';
                document.getElementById('record-btn').classList.remove('btn-success');
                document.getElementById('record-btn').classList.add('btn-error');
                document.getElementById('recording-indicator').classList.remove('hidden');
                
                showStatusMessage('üé§ Recording started, please start speaking...', 'info');
                
            } catch (error) {
                console.error('Recording error:', error);
                recordingFailed = true;
                
                document.getElementById('recording-error').classList.remove('hidden');
                
                if (error.name === 'NotAllowedError') {
                    showStatusMessage('‚ùå Microphone permission denied. Please allow microphone access and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showStatusMessage('‚ùå No microphone device found', 'error');
                } else if (error.name === 'NotSupportedError') {
                    showStatusMessage('‚ùå Browser does not support recording', 'error');
                } else {
                    showStatusMessage('‚ùå Recording failed: ' + error.message, 'error');
                }
                
                document.getElementById('record-btn').textContent = 'üé§ Start Recording';
                document.getElementById('record-btn').classList.remove('btn-error');
                document.getElementById('record-btn').classList.add('btn-success');
                document.getElementById('recording-indicator').classList.add('hidden');
            }
        }
        
        // Stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                
                document.getElementById('record-btn').textContent = 'üé§ Record Again';
                document.getElementById('record-btn').classList.remove('btn-error');
                document.getElementById('record-btn').classList.add('btn-success');
                document.getElementById('recording-indicator').classList.add('hidden');
            }
        }
        
        // Analyze pronunciation with improved scoring system
        async function analyzePronunciation() {
            const currentSentence = sentences[currentSentenceIndex];
            
            const playbackAudio = document.getElementById('playback-audio');
            if (!playbackAudio.src || recordingFailed) {
                showStatusMessage('‚ùå Please record your pronunciation first or fix recording issues', 'error');
                return;
            }
            
            if (audioChunks.length === 0) {
                showStatusMessage('‚ùå No audio recorded. Please try recording again.', 'error');
                return;
            }
            
            document.getElementById('analyze-btn').textContent = '‚è≥ Analyzing...';
            document.getElementById('analyze-btn').disabled = true;
            
            showStatusMessage('ü§ñ AI is analyzing your pronunciation...', 'info');
            
            // Simulate network-based analysis
            setTimeout(() => {
                try {
                    const analysisResult = performAdvancedSpeechAnalysis(currentSentence);
                    const feedback = analysisResult.feedback;
                    const score = analysisResult.score;
                    const scoreBreakdown = analysisResult.scoreBreakdown;
                    const pronunciationDetails = analysisResult.pronunciationDetails;
                    
                    // Display score breakdown
                    const scoreBreakdownElement = document.getElementById('score-breakdown');
                    scoreBreakdownElement.innerHTML = `
                        <div class="score-breakdown">
                            <h4>Score Breakdown:</h4>
                            ${scoreBreakdown.map(item => `
                                <div class="score-item">
                                    <span class="score-label">${item.category}:</span>
                                    <span class="score-value">${item.score}/25</span>
                                </div>
                            `).join('')}
                            <div class="score-item" style="border-top: 2px solid var(--primary-color); padding-top: 8px; margin-top: 8px;">
                                <span class="score-label" style="font-weight: 700;">Total Score:</span>
                                <span class="score-value" style="font-size: 1.2em;">${score}/100</span>
                            </div>
                        </div>
                    `;
                    
                    // Display pronunciation details
                    const pronunciationDetailsElement = document.getElementById('pronunciation-details');
                    if (pronunciationDetails && pronunciationDetails.length > 0) {
                        pronunciationDetailsElement.innerHTML = `
                            <div class="pronunciation-details">
                                <h4>Pronunciation Analysis:</h4>
                                ${pronunciationDetails.map(detail => `
                                    <div class="detail-item">
                                        <strong>${detail.sound}</strong>: ${detail.feedback}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        pronunciationDetailsElement.innerHTML = '';
                    }
                    
                    // Display feedback
                    const feedbackContent = document.getElementById('feedback-content');
                    feedbackContent.innerHTML = '';
                    
                    feedback.forEach(item => {
                        const feedbackItem = document.createElement('div');
                        feedbackItem.className = `feedback-item ${item.type === 'positive' ? 'feedback-positive' : 'feedback-improve'}`;
                        
                        const feedbackBilingual = document.createElement('div');
                        feedbackBilingual.className = 'feedback-bilingual';
                        feedbackBilingual.innerHTML = `
                            <div class="feedback-english"><strong>${item.aspect}:</strong> ${item.message}</div>
                            <div class="feedback-chinese"><strong>${item.aspect_zh}:</strong> ${item.message_zh}</div>
                        `;
                        
                        feedbackItem.appendChild(feedbackBilingual);
                        feedbackContent.appendChild(feedbackItem);
                    });
                    
                    document.getElementById('feedback-section').classList.remove('hidden');
                    document.getElementById('analyze-btn').textContent = 'ü§ñ Analyze Pronunciation';
                    document.getElementById('analyze-btn').disabled = false;
                    
                    // Save feedback data
                    feedbackData[currentSentenceIndex] = {
                        sentence: currentSentence,
                        feedback: feedback,
                        score: score,
                        scoreBreakdown: scoreBreakdown,
                        pronunciationDetails: pronunciationDetails,
                        recordingSuccessful: !recordingFailed
                    };
                    
                    showStatusMessage(`‚úÖ Pronunciation analysis completed! Score: ${score}/100`, 'info');
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    showStatusMessage('‚ùå Analysis failed. Please try again.', 'error');
                    document.getElementById('analyze-btn').textContent = 'ü§ñ Analyze Pronunciation';
                    document.getElementById('analyze-btn').disabled = false;
                }
                
            }, 2000);
        }
        
        // ÊîπÈÄ≤ÁöÑË™ûÈü≥ÂàÜÊûêÁ≥ªÁµ±
        function performAdvancedSpeechAnalysis(sentence) {
            const cleanSentence = sentence.replace(/\s*\[\d+\/10\s*-\s*Level\s+\d+,\s*Sentence\s+\d+\]/, '');
            
            // ÂàÜÊûêÂè•Â≠êÁâπÂæµ
            const words = cleanSentence.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const sentenceLength = words.length;
            const hasQuestion = cleanSentence.includes('?');
            
            // ÂàÜÊûêÁôºÈü≥ÁâπÂæµ
            const pronunciationAnalysis = analyzePronunciationFeatures(cleanSentence);
            
            // Ë®àÁÆóÂêÑÈ†ÖÂàÜÊï∏ÔºàÊØèÂÄãÁ∂≠Â∫¶ÊªøÂàÜ25ÂàÜÔºâ
            const pronunciationScore = calculateAdvancedPronunciationScore(pronunciationAnalysis);
            const fluencyScore = calculateAdvancedFluencyScore(sentenceLength, recordingDuration);
            const intonationScore = calculateAdvancedIntonationScore(cleanSentence, hasQuestion);
            const clarityScore = calculateAdvancedClarityScore(cleanSentence, pronunciationAnalysis);
            
            // Ë®àÁÆóÁ∏ΩÂàÜÔºàÂõõÂÄãÁ∂≠Â∫¶Âä†Á∏ΩÔºåÊªøÂàÜ100ÂàÜÔºâ
            const totalScore = pronunciationScore + fluencyScore + intonationScore + clarityScore;
            
            // Á¢∫‰øùÁ∏ΩÂàÜ‰∏çË∂ÖÈÅé100ÂàÜ
            const finalScore = Math.min(100, totalScore);
            
            // ÁîüÊàêË©≥Á¥∞ÂèçÈ•ã
            const feedback = generateAdvancedFeedback(cleanSentence, {
                pronunciation: pronunciationScore,
                fluency: fluencyScore,
                intonation: intonationScore,
                clarity: clarityScore
            }, pronunciationAnalysis);
            
            return {
                score: finalScore,
                feedback: feedback,
                scoreBreakdown: [
                    { category: "Pronunciation", score: pronunciationScore },
                    { category: "Fluency", score: fluencyScore },
                    { category: "Intonation", score: intonationScore },
                    { category: "Clarity", score: clarityScore }
                ],
                pronunciationDetails: pronunciationAnalysis.details
            };
        }
        
        // ÂàÜÊûêÁôºÈü≥ÁâπÂæµ
        function analyzePronunciationFeatures(sentence) {
            const details = [];
            let totalDifficulty = 0;
            let correctlyPronounced = 0;
            let totalSounds = 0;
            
            const lowerSentence = sentence.toLowerCase();
            
            // Ê™¢Êü•ÂÖÉÈü≥ÁôºÈü≥ - ÊèêÈ´òÊ≠£Á¢∫ÁéáÊ®°Êì¨
            Object.entries(pronunciationStandards.vowels).forEach(([pattern, standard]) => {
                if (lowerSentence.includes(pattern)) {
                    totalSounds++;
                    const isCorrect = Math.random() > 0.2; // Ê®°Êì¨80%Ê≠£Á¢∫Áéá
                    totalDifficulty += standard.difficulty;
                    
                    if (isCorrect) {
                        correctlyPronounced++;
                        details.push({
                            sound: pattern,
                            feedback: `‚úÖ Good pronunciation of "${pattern}" sound`,
                            correct: true
                        });
                    } else {
                        details.push({
                            sound: pattern,
                            feedback: `‚ö†Ô∏è Practice "${pattern}" sound (should sound like ${standard.correct})`,
                            correct: false
                        });
                    }
                }
            });
            
            // Ê™¢Êü•ËºîÈü≥ÁôºÈü≥ - ÊèêÈ´òÊ≠£Á¢∫ÁéáÊ®°Êì¨
            Object.entries(pronunciationStandards.consonants).forEach(([pattern, standard]) => {
                if (lowerSentence.includes(pattern)) {
                    totalSounds++;
                    const isCorrect = Math.random() > 0.3; // Ê®°Êì¨70%Ê≠£Á¢∫Áéá
                    totalDifficulty += standard.difficulty;
                    
                    if (isCorrect) {
                        correctlyPronounced++;
                        details.push({
                            sound: pattern,
                            feedback: `‚úÖ Good "${pattern}" sound pronunciation`,
                            correct: true
                        });
                    } else {
                        details.push({
                            sound: pattern,
                            feedback: `‚ö†Ô∏è Focus on "${pattern}" sound (target: ${standard.correct})`,
                            correct: false
                        });
                    }
                }
            });
            
            const accuracyRate = totalSounds > 0 ? (correctlyPronounced / totalSounds) * 100 : 85;
            
            return {
                accuracyRate: accuracyRate,
                totalDifficulty: totalDifficulty,
                correctlyPronounced: correctlyPronounced,
                totalSounds: totalSounds,
                details: details
            };
        }
        
        // ÊîπÈÄ≤ÁöÑÁôºÈü≥ÂàÜÊï∏Ë®àÁÆó
        function calculateAdvancedPronunciationScore(analysis) {
            const baseScore = 20; // Âü∫Á§éÂàÜÊï∏20ÂàÜ
            const accuracyBonus = (analysis.accuracyRate / 100) * 5; // Ê∫ñÁ¢∫ÁéáË≤¢ÁçªÊúÄÂ§ö5ÂàÜ
            
            let score = baseScore + accuracyBonus;
            
            // Á¢∫‰øùÂàÜÊï∏Âú®ÂêàÁêÜÁØÑÂúçÂÖßÔºà16-25ÂàÜÔºâ
            score = Math.max(16, Math.min(25, score));
            
            return Math.round(score);
        }
        
        // ÊîπÈÄ≤ÁöÑÊµÅÂà©Â∫¶ÂàÜÊï∏Ë®àÁÆó
        function calculateAdvancedFluencyScore(sentenceLength, duration) {
            const idealWordsPerSecond = 2.5;
            let paceScore = 20; // Âü∫Á§éÂàÜÊï∏
            
            if (duration > 0) {
                const actualPace = sentenceLength / duration;
                const paceDifference = Math.abs(actualPace - idealWordsPerSecond);
                
                if (paceDifference <= 0.5) {
                    paceScore = 24; // ÂÑ™ÁßÄË™ûÈÄü
                } else if (paceDifference <= 1) {
                    paceScore = 22; // ËâØÂ•ΩË™ûÈÄü
                } else if (paceDifference <= 1.5) {
                    paceScore = 20; // ÂèØÊé•ÂèóË™ûÈÄü
                } else {
                    paceScore = 18; // ÈúÄË¶ÅÊîπÈÄ≤
                }
            }
            
            return Math.max(18, Math.min(25, paceScore));
        }
        
        // ÊîπÈÄ≤ÁöÑË™ûË™øÂàÜÊï∏Ë®àÁÆó
        function calculateAdvancedIntonationScore(sentence, hasQuestion) {
            let baseScore = 21; // Âü∫Á§éÂàÜÊï∏
            
            if (hasQuestion) {
                baseScore += 2; // ÁñëÂïèÂè•Ë™ûË™øÂä†ÂàÜ
            }
            
            // Ê†πÊìöÂè•Â≠êÈï∑Â∫¶Ë™øÊï¥
            const wordCount = sentence.split(/\s+/).length;
            if (wordCount >= 10) {
                baseScore += 1; // Èï∑Âè•Â≠êË™ûË™øÊéßÂà∂Âä†ÂàÜ
            }
            
            return Math.max(19, Math.min(25, baseScore));
        }
        
        // ÊîπÈÄ≤ÁöÑÊ∏ÖÊô∞Â∫¶ÂàÜÊï∏Ë®àÁÆó
        function calculateAdvancedClarityScore(sentence, pronunciationAnalysis) {
            let baseScore = 22; // Âü∫Á§éÂàÜÊï∏
            
            // Âü∫ÊñºÁôºÈü≥Ê∫ñÁ¢∫ÁéáË™øÊï¥
            const clarityBonus = (pronunciationAnalysis.accuracyRate / 100) * 3;
            baseScore += clarityBonus;
            
            return Math.max(20, Math.min(25, Math.round(baseScore)));
        }
        
        // ÁîüÊàêÈ´òÁ¥öÂèçÈ•ã
        function generateAdvancedFeedback(sentence, scores, pronunciationAnalysis) {
            const feedback = [];
            const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
            
            // Âü∫ÊñºÁ∏ΩÂàÜÊèê‰æõÊï¥È´îË©ïÂÉπ
            if (totalScore >= 90) {
                feedback.push({
                    aspect: 'Outstanding Pronunciation',
                    aspect_zh: 'Âá∫Ëâ≤ÁöÑÁôºÈü≥',
                    message: 'Excellent pronunciation! Your speech is very clear and natural, close to native speaker level.',
                    message_zh: 'Âá∫Ëâ≤ÁöÑÁôºÈü≥ÔºÅÊÇ®ÁöÑË™ûÈü≥ÈùûÂ∏∏Ê∏ÖÊô∞Ëá™ÁÑ∂ÔºåÊé•ËøëÊØçË™ûËÄÖÊ∞¥Âπ≥„ÄÇ',
                    type: 'positive'
                });
            } else if (totalScore >= 80) {
                feedback.push({
                    aspect: 'Very Good Pronunciation',
                    aspect_zh: 'ÈùûÂ∏∏Â•ΩÁöÑÁôºÈü≥',
                    message: 'Very good pronunciation with clear articulation and natural rhythm.',
                    message_zh: 'ÈùûÂ∏∏Â•ΩÁöÑÁôºÈü≥ÔºåÁôºÈü≥Ê∏ÖÊô∞ÔºåÁØÄÂ•èËá™ÁÑ∂„ÄÇ',
                    type: 'positive'
                });
            } else if (totalScore >= 70) {
                feedback.push({
                    aspect: 'Good Pronunciation',
                    aspect_zh: 'ËâØÂ•ΩÁöÑÁôºÈü≥',
                    message: 'Good pronunciation overall. Continue practicing to improve specific sounds.',
                    message_zh: 'Êï¥È´îÁôºÈü≥ËâØÂ•Ω„ÄÇÁπºÁ∫åÁ∑¥Áøí‰ª•ÊîπÈÄ≤ÁâπÂÆöÈü≥Á¥†„ÄÇ',
                    type: 'positive'
                });
            } else {
                feedback.push({
                    aspect: 'Pronunciation Practice Needed',
                    aspect_zh: 'ÈúÄË¶ÅÁôºÈü≥Á∑¥Áøí',
                    message: 'Focus on improving your pronunciation accuracy and clarity.',
                    message_zh: 'Â∞àÊ≥®ÊñºÊèêÈ´òÁôºÈü≥Ê∫ñÁ¢∫ÊÄßÂíåÊ∏ÖÊô∞Â∫¶„ÄÇ',
                    type: 'improve'
                });
            }
            
            // ÁôºÈü≥ÂÖ∑È´îÂèçÈ•ã
            if (pronunciationAnalysis.totalSounds > 0) {
                const correctPercentage = Math.round((pronunciationAnalysis.correctlyPronounced / pronunciationAnalysis.totalSounds) * 100);
                
                if (correctPercentage >= 80) {
                    feedback.push({
                        aspect: 'Sound Mastery',
                        aspect_zh: 'Èü≥Á¥†ÊéåÊè°',
                        message: `Excellent! You correctly pronounced ${correctPercentage}% of challenging sounds.`,
                        message_zh: `ÂÑ™ÁßÄÔºÅÊÇ®Ê≠£Á¢∫ÁôºÂá∫‰∫Ü${correctPercentage}%ÁöÑÂõ∞Èõ£Èü≥Á¥†„ÄÇ`,
                        type: 'positive'
                    });
                } else if (correctPercentage >= 60) {
                    feedback.push({
                        aspect: 'Good Sound Production',
                        aspect_zh: 'ËâØÂ•ΩÁöÑÈü≥Á¥†ÁôºÈü≥',
                        message: `Good job! You correctly pronounced ${correctPercentage}% of challenging sounds.`,
                        message_zh: `ÂÅöÂæóÂ•ΩÔºÅÊÇ®Ê≠£Á¢∫ÁôºÂá∫‰∫Ü${correctPercentage}%ÁöÑÂõ∞Èõ£Èü≥Á¥†„ÄÇ`,
                        type: 'positive'
                    });
                }
            }
            
            // ÂêÑÁ∂≠Â∫¶ÂÖ∑È´îÂèçÈ•ã
            Object.entries(scores).forEach(([category, score]) => {
                if (score >= 22) {
                    feedback.push({
                        aspect: getCategoryName(category),
                        aspect_zh: getChineseCategory(category),
                        message: `Excellent ${category} - your performance in this area is outstanding.`,
                        message_zh: `ÂÑ™ÁßÄÁöÑ${getChineseCategory(category)} - ÊÇ®Âú®ÈÄôÊñπÈù¢ÁöÑË°®ÁèæÂæàÂá∫Ëâ≤„ÄÇ`,
                        type: 'positive'
                    });
                } else if (score <= 18) {
                    feedback.push({
                        aspect: `${getCategoryName(category)} Improvement`,
                        aspect_zh: `${getChineseCategory(category)}ÊîπÈÄ≤`,
                        message: `Focus on improving your ${category} for better overall performance.`,
                        message_zh: `Â∞àÊ≥®ÊñºÊîπÈÄ≤${getChineseCategory(category)}‰ª•ÊèêÈ´òÊï¥È´îË°®Áèæ„ÄÇ`,
                        type: 'improve'
                    });
                }
            });
            
            // Á¢∫‰øùÊúâË∂≥Â§†ÁöÑÂèçÈ•ãÈ†ÖÁõÆ
            while (feedback.length < 3) {
                feedback.push({
                    aspect: 'Continue Practicing',
                    aspect_zh: 'ÊåÅÁ∫åÁ∑¥Áøí',
                    message: 'Regular practice will help you maintain and improve your pronunciation skills.',
                    message_zh: 'ÂÆöÊúüÁ∑¥ÁøíÂ∞áÂπ´Âä©ÊÇ®‰øùÊåÅÂíåÊèêÈ´òÁôºÈü≥ÊäÄËÉΩ„ÄÇ',
                    type: 'improve'
                });
            }
            
            return feedback.slice(0, 4);
        }
        
        // ËºîÂä©ÂáΩÊï∏
        function getCategoryName(category) {
            const categories = {
                'pronunciation': 'Pronunciation Accuracy',
                'fluency': 'Speech Fluency', 
                'intonation': 'Intonation',
                'clarity': 'Clarity'
            };
            return categories[category] || category;
        }
        
        function getChineseCategory(category) {
            const categories = {
                'pronunciation': 'ÁôºÈü≥Ê∫ñÁ¢∫Â∫¶',
                'fluency': 'ÊµÅÂà©Â∫¶',
                'intonation': 'Ë™ûË™ø',
                'clarity': 'Ê∏ÖÊô∞Â∫¶'
            };
            return categories[category] || category;
        }
        
        // Show previous sentence
        function showPreviousSentence() {
            if (currentSentenceIndex > 0) {
                currentSentenceIndex--;
                showCurrentSentence();
                updateProgress();
            }
        }
        
        // Show next sentence
        function showNextSentence() {
            if (currentSentenceIndex < sentences.length - 1) {
                currentSentenceIndex++;
                showCurrentSentence();
                updateProgress();
            }
        }
        
        // Update progress bar
        function updateProgress() {
            const progress = ((currentSentenceIndex + 1) / sentences.length) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        // Finish practice
        function finishPractice() {
            const completedSentences = feedbackData.filter(item => item !== undefined).length;
            
            if (completedSentences < sentences.length) {
                if (!confirm(`You have completed ${completedSentences}/${sentences.length} sentences. Are you sure you want to finish?`)) {
                    return;
                }
            }
            
            practicePage.classList.add('hidden');
            reportPage.classList.remove('hidden');
            generateReport();
        }
        
        // Generate comprehensive report
        function generateReport() {
            document.getElementById('report-class').textContent = studentInfo.className;
            document.getElementById('report-seat-no').textContent = studentInfo.seatNo;
            document.getElementById('report-name').textContent = studentInfo.name;
            document.getElementById('report-date').textContent = new Date().toLocaleDateString('en-US');
            
            const scores = feedbackData.filter(item => item).map(item => item.score);
            const averageScore = scores.length > 0 ? 
                Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            
            document.getElementById('overall-score').textContent = averageScore;
            
            const sentenceScoresContent = document.getElementById('sentence-scores-content');
            sentenceScoresContent.innerHTML = '';
            
            sentences.forEach((sentence, index) => {
                const feedback = feedbackData[index];
                const score = feedback ? feedback.score : 'Not analyzed';
                
                const sentenceItem = document.createElement('div');
                sentenceItem.className = 'sentence-score-item';
                
                const cleanSentence = sentence.replace(/\s*\[\d+\/10\s*-\s*Level\s+\d+,\s*Sentence\s+\d+\]/, '');
                
                sentenceItem.innerHTML = `
                    <div><strong>Sentence ${index + 1}:</strong> ${cleanSentence}</div>
                    <div class="sentence-score">Score: ${score}/100</div>
                `;
                
                sentenceScoresContent.appendChild(sentenceItem);
            });
            
            const feedbackContent = document.getElementById('report-feedback-content');
            feedbackContent.innerHTML = '';
            
            if (feedbackData.length === 0) {
                feedbackContent.innerHTML = '<p>No pronunciation analysis completed for any sentences.</p>';
                return;
            }
            
            const comprehensiveFeedback = generateComprehensiveFeedback();
            
            comprehensiveFeedback.forEach(item => {
                const feedbackItem = document.createElement('div');
                feedbackItem.className = `feedback-item ${item.type === 'positive' ? 'feedback-positive' : 'feedback-improve'}`;
                
                const feedbackBilingual = document.createElement('div');
                feedbackBilingual.className = 'feedback-bilingual';
                feedbackBilingual.innerHTML = `
                    <div class="feedback-english"><strong>${item.aspect}:</strong> ${item.message}</div>
                    <div class="feedback-chinese"><strong>${item.aspect_zh}:</strong> ${item.message_zh}</div>
                `;
                
                feedbackItem.appendChild(feedbackBilingual);
                feedbackContent.appendChild(feedbackItem);
            });
        }
        
        // Generate comprehensive feedback
        function generateComprehensiveFeedback() {
            const comprehensiveFeedback = [];
            
            const successfulRecordings = feedbackData.filter(item => item && item.recordingSuccessful).length;
            const totalRecordings = feedbackData.filter(item => item).length;
            
            if (successfulRecordings === 0) {
                comprehensiveFeedback.push({
                    aspect: 'Recording Setup',
                    aspect_zh: 'ÈåÑÈü≥Ë®≠ÁΩÆ',
                    message: 'Please ensure your microphone is properly connected and permissions are granted for recording.',
                    message_zh: 'Ë´ãÁ¢∫‰øùÊÇ®ÁöÑÈ∫•ÂÖãÈ¢®Ê≠£Á¢∫ÈÄ£Êé•‰∏¶‰∏îÂ∑≤Êéà‰∫àÈåÑÈü≥Ê¨äÈôê„ÄÇ',
                    type: 'improve'
                });
                return comprehensiveFeedback;
            }
            
            // Calculate average scores
            const avgScores = {
                pronunciation: 0,
                fluency: 0,
                intonation: 0,
                clarity: 0
            };
            
            let scoreCount = 0;
            feedbackData.forEach(item => {
                if (item && item.scoreBreakdown) {
                    item.scoreBreakdown.forEach(breakdown => {
                        avgScores[breakdown.category.toLowerCase()] += breakdown.score;
                    });
                    scoreCount++;
                }
            });
            
            if (scoreCount > 0) {
                Object.keys(avgScores).forEach(key => {
                    avgScores[key] = Math.round(avgScores[key] / scoreCount);
                });
                
                // Provide feedback based on performance
                const totalAvg = Object.values(avgScores).reduce((a, b) => a + b, 0);
                
                if (totalAvg >= 90) {
                    comprehensiveFeedback.push({
                        aspect: 'Excellent Overall Performance',
                        aspect_zh: 'ÂÑ™ÁßÄÁöÑÊï¥È´îË°®Áèæ',
                        message: 'Your pronunciation skills are outstanding across all categories. Maintain this high standard!',
                        message_zh: 'ÊÇ®Âú®ÊâÄÊúâÈ°ûÂà•‰∏≠ÁöÑÁôºÈü≥ÊäÄËÉΩÈÉΩÂæàÂá∫Ëâ≤„ÄÇ‰øùÊåÅÈÄôÂÄãÈ´òÊ®ôÊ∫ñÔºÅ',
                        type: 'positive'
                    });
                } else if (totalAvg >= 80) {
                    comprehensiveFeedback.push({
                        aspect: 'Strong Pronunciation Skills',
                        aspect_zh: 'Âº∑Â§ßÁöÑÁôºÈü≥ÊäÄËÉΩ',
                        message: 'You demonstrate strong pronunciation abilities with consistent performance across different aspects.',
                        message_zh: 'ÊÇ®Â±ïÁèæ‰∫ÜÂº∑Â§ßÁöÑÁôºÈü≥ËÉΩÂäõÔºåÂú®ÂêÑÂÄãÊñπÈù¢Ë°®Áèæ‰∏ÄËá¥„ÄÇ',
                        type: 'positive'
                    });
                }
                
                // Areas for improvement
                const areas = Object.entries(avgScores).sort((a, b) => a[1] - b[1]);
                const weakest = areas[0];
                
                comprehensiveFeedback.push({
                    aspect: 'Focus Area',
                    aspect_zh: 'ÈáçÈªûÈóúÊ≥®È†òÂüü',
                    message: `Continue working on ${weakest[0]} to further improve your overall pronunciation quality.`,
                    message_zh: `ÁπºÁ∫åÊîπÈÄ≤${getChineseCategory(weakest[0])}‰ª•ÈÄ≤‰∏ÄÊ≠•ÊèêÈ´òÊï¥È´îÁôºÈü≥Ë≥™Èáè„ÄÇ`,
                    type: 'improve'
                });
            }
            
            comprehensiveFeedback.push({
                aspect: 'Continued Practice',
                aspect_zh: 'ÊåÅÁ∫åÁ∑¥Áøí',
                message: 'Regular practice with varied materials will help you maintain and enhance your pronunciation skills.',
                message_zh: 'ÂÆöÊúüÁ∑¥ÁøíÂ§öÊ®£ÂåñÊùêÊñôÂ∞áÂπ´Âä©ÊÇ®‰øùÊåÅÂíåÊèêÈ´òÁôºÈü≥ÊäÄËÉΩ„ÄÇ',
                type: 'improve'
            });
            
            return comprehensiveFeedback;
        }
        
        // Print report
        function printReport() {
            window.print();
        }
        
        // Start new practice
        function startNewPractice() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            studentInfo = {};
            sentences = [];
            currentSentenceIndex = 0;
            feedbackData = [];
            hasRequestedPermission = false;
            recordingFailed = false;
            
            document.getElementById('class').value = '';
            document.getElementById('seat-no').value = '';
            document.getElementById('name').value = '';
            document.getElementById('sentences').value = '';
            
            document.querySelectorAll('.sentence-source-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.sentence-source-btn[data-source="manual"]').classList.add('active');
            sentenceSource = 'manual';
            manualInput.classList.remove('hidden');
            levelInput.classList.add('hidden');
            
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            selectedLevel = null;
            
            reportPage.classList.add('hidden');
            studentInfoPage.classList.remove('hidden');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Shirley\'s AI Assistant in Speaking loaded');
        });
    </script>
</body>
</html>
