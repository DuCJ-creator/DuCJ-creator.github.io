<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's AI Assistant in Speaking</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff7e5f;
            --light-color: #f5f7fa;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            font-size: 2.2em;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color), #ff9a7f);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .btn-error {
            background: linear-gradient(135deg, var(--error-color), #c0392b);
        }
        
        .hidden {
            display: none !important;
        }
        
        .practice-item {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .practice-item:hover {
            transform: translateY(-2px);
        }
        
        .sentence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sentence-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .sentence-source {
            font-size: 14px;
            color: #666;
        }
        
        .sentence-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .sentence-text {
            flex-grow: 1;
            font-size: 18px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .audio-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: white;
            margin-left: 15px;
            padding: 12px;
            border-radius: 50%;
            min-width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .recording-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .recording-btn {
            padding: 18px 35px;
            border-radius: 50px;
            font-weight: 600;
            margin-bottom: 20px;
            width: 100%;
            max-width: 250px;
            font-size: 18px;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            background-color: var(--error-color);
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { 
                transform: scale(1);
                opacity: 1; 
            }
            50% { 
                transform: scale(1.2);
                opacity: 0.7; 
            }
            100% { 
                transform: scale(1);
                opacity: 1; 
            }
        }
        
        .feedback-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }
        
        .feedback-item {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .feedback-positive {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.1));
            border-left: 4px solid var(--success-color);
        }
        
        .feedback-improve {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
            border-left: 4px solid var(--warning-color);
        }
        
        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 25px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .report-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .report-info-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .report-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .report-info-label {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .report-score {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 30px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-feedback {
            margin-top: 30px;
        }
        
        .sentence-list {
            margin: 20px 0;
        }
        
        .sentence-score-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .sentence-score {
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 5px;
        }
        
        .print-btn {
            display: block;
            margin: 30px auto 0;
            max-width: 200px;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }
        
        .navigation .btn {
            width: auto;
            flex: 1;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        
        .status-error {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.1));
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }
        
        .status-info {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(41, 128, 185, 0.1));
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        
        .permission-prompt {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
            border: 2px solid var(--warning-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
            color: #666;
            font-size: 1.1em;
        }
        
        .sentence-source {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .sentence-source-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sentence-source-btn:hover {
            background: #e9ecef;
        }
        
        .sentence-source-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .level-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .level-btn {
            padding: 12px;
            text-align: center;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .level-btn:hover {
            background: #e9ecef;
        }
        
        .level-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .feedback-bilingual {
            margin-bottom: 10px;
        }
        
        .feedback-english {
            font-weight: 500;
        }
        
        .feedback-chinese {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* ÊâãÊ©üÈÅ©ÈÖç */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .practice-item {
                padding: 20px;
            }
            
            .sentence-container {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }
            
            .audio-btn {
                margin-left: 0;
                margin-top: 15px;
                align-self: center;
            }
            
            .report-info-line {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .navigation {
                flex-direction: column;
            }
            
            .btn {
                padding: 18px;
            }
            
            .sentence-source {
                flex-direction: column;
            }
            
            .level-selection {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .sentence-text {
                font-size: 16px;
            }
            
            .recording-btn {
                padding: 20px;
                font-size: 16px;
            }
            
            .level-selection {
                grid-template-columns: 1fr;
            }
        }

        /* ÊâìÂç∞Ê®£Âºè */
        @media print {
            body {
                background: white !important;
                padding: 0;
            }
            
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            
            .btn {
                display: none !important;
            }
            
            .practice-item, .report-section {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Student Information Input Page -->
        <div id="student-info-page">
            <h1>Shirley's AI Assistant in Speaking</h1>
            <div class="welcome-message">
                Improve your English pronunciation with instant AI feedback! Please fill in the information below to start practicing.
            </div>
            
            <div class="form-group">
                <label for="class">Class</label>
                <input type="text" id="class" placeholder="">
            </div>
            
            <div class="form-group">
                <label for="seat-no">Seat Number</label>
                <input type="number" id="seat-no" min="1" max="99" placeholder="">
            </div>
            
            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" placeholder="">
            </div>
            
            <div class="form-group">
                <label>Sentence Source</label>
                <div class="sentence-source">
                    <div class="sentence-source-btn active" data-source="manual">Enter Manually</div>
                    <div class="sentence-source-btn" data-source="level">From Sentence Bank</div>
                </div>
                
                <div id="manual-input" class="sentence-input">
                    <label for="sentences">Practice Sentences (one per line, maximum 10)</label>
                    <textarea id="sentences" placeholder="Enter or paste sentences to practice, one per line"></textarea>
                </div>
                
                <div id="level-input" class="sentence-input hidden">
                    <label>Select Difficulty Level</label>
                    <div class="level-selection">
                        <div class="level-btn" data-level="1">Level 1</div>
                        <div class="level-btn" data-level="2">Level 2</div>
                        <div class="level-btn" data-level="3">Level 3</div>
                        <div class="level-btn" data-level="4">Level 4</div>
                        <div class="level-btn" data-level="5">Level 5</div>
                        <div class="level-btn" data-level="6">Level 6</div>
                    </div>
                    <button id="load-level-sentences" class="btn btn-accent" style="margin-top: 15px;">Load 10 Random Sentences</button>
                </div>
            </div>
            
            <button id="start-practice" class="btn">Start Practice</button>
        </div>
        
        <!-- Practice Page -->
        <div id="practice-page" class="hidden">
            <h1>English Pronunciation Practice</h1>
            
            <div class="progress-bar">
                <div id="progress" class="progress"></div>
            </div>
            
            <div id="practice-container">
                <!-- Practice items will be dynamically generated here -->
            </div>
            
            <div class="navigation">
                <button id="prev-sentence" class="btn">Previous</button>
                <button id="next-sentence" class="btn">Next</button>
            </div>
            
            <button id="finish-practice" class="btn btn-accent">Finish Practice</button>
        </div>
        
        <!-- Report Page -->
        <div id="report-page" class="hidden">
            <div class="report-section">
                <div class="report-header">
                    <h1>English Pronunciation Practice Report</h1>
                </div>
                
                <div class="report-info-line">
                    <div class="report-info-item">
                        <span class="report-info-label">Class:</span>
                        <span id="report-class"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Seat No:</span>
                        <span id="report-seat-no"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Name:</span>
                        <span id="report-name"></span>
                    </div>
                    <div class="report-info-item">
                        <span class="report-info-label">Date:</span>
                        <span id="report-date"></span>
                    </div>
                </div>
                
                <div class="report-score">
                    Overall Pronunciation Score: <span id="overall-score">85</span>/100
                </div>
                
                <div class="sentence-list">
                    <h3>Practice Sentences & Scores</h3>
                    <div id="sentence-scores-content">
                        <!-- Sentence scores will be dynamically generated here -->
                    </div>
                </div>
                
                <div class="report-feedback">
                    <h3>Comprehensive Feedback</h3>
                    <div id="report-feedback-content">
                        <!-- Feedback content will be dynamically generated here -->
                    </div>
                </div>
                
                <button id="print-report" class="btn print-btn">Print Report</button>
                <button id="new-practice" class="btn btn-accent print-btn">New Practice</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let studentInfo = {};
        let sentences = [];
        let currentSentenceIndex = 0;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let feedbackData = [];
        let hasRequestedPermission = false;
        let sentenceSource = 'manual'; // 'manual' or 'level'
        let selectedLevel = null;
        let usedSentences = {}; // Track used sentences per level
        let currentStream = null; // Keep track of current media stream
        let recordingFailed = false; // Track if recording failed
        
        // DOM elements
        const studentInfoPage = document.getElementById('student-info-page');
        const practicePage = document.getElementById('practice-page');
        const reportPage = document.getElementById('report-page');
        const startPracticeBtn = document.getElementById('start-practice');
        const finishPracticeBtn = document.getElementById('finish-practice');
        const prevSentenceBtn = document.getElementById('prev-sentence');
        const nextSentenceBtn = document.getElementById('next-sentence');
        const printReportBtn = document.getElementById('print-report');
        const newPracticeBtn = document.getElementById('new-practice');
        const practiceContainer = document.getElementById('practice-container');
        const progressBar = document.getElementById('progress');
        const manualInput = document.getElementById('manual-input');
        const levelInput = document.getElementById('level-input');
        const loadLevelSentencesBtn = document.getElementById('load-level-sentences');
        
        // Event listeners
        startPracticeBtn.addEventListener('click', startPractice);
        finishPracticeBtn.addEventListener('click', finishPractice);
        prevSentenceBtn.addEventListener('click', showPreviousSentence);
        nextSentenceBtn.addEventListener('click', showNextSentence);
        printReportBtn.addEventListener('click', printReport);
        newPracticeBtn.addEventListener('click', startNewPractice);
        loadLevelSentencesBtn.addEventListener('click', loadLevelSentences);
        
        // Sentence source selection
        document.querySelectorAll('.sentence-source-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.sentence-source-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                sentenceSource = this.getAttribute('data-source');
                
                if (sentenceSource === 'manual') {
                    manualInput.classList.remove('hidden');
                    levelInput.classList.add('hidden');
                } else {
                    manualInput.classList.add('hidden');
                    levelInput.classList.remove('hidden');
                }
            });
        });
        
        // Level selection
        document.querySelectorAll('.level-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedLevel = this.getAttribute('data-level');
            });
        });
        
        // Initialize speech synthesis
        let speechSynthesis = window.speechSynthesis;
        
        // Load random sentences from selected level
        async function loadLevelSentences() {
            if (!selectedLevel) {
                showStatusMessage('Please select a difficulty level first', 'error', levelInput);
                return;
            }
            
            try {
                showStatusMessage(`Loading sentences from Level ${selectedLevel}...`, 'info', levelInput);
                
                // Use default sentences for demo
                const levelData = getDefaultSentencesForLevel(selectedLevel);
                
                // Format sentences with numbering information
                const formattedSentences = levelData.map((item, index) => 
                    `${item.sentence} [${index + 1}/10 - Level ${selectedLevel}, Sentence ${item.number}]`
                );
                
                // Display the selected sentences
                document.getElementById('sentences').value = formattedSentences.join('\n');
                showStatusMessage(`10 sentences loaded from Level ${selectedLevel}!`, 'info', levelInput);
                
            } catch (error) {
                console.error('Error loading level sentences:', error);
                showStatusMessage('Error loading sentences. Please try again.', 'error', levelInput);
            }
        }
        
        // Default sentences fallback for each level
        function getDefaultSentencesForLevel(level) {
            const defaultSentences = {
                1: [
                    { number: "1", sentence: "Hello, how are you?" },
                    { number: "2", sentence: "My name is John." },
                    { number: "3", sentence: "I like to read books." },
                    { number: "4", sentence: "The weather is nice today." },
                    { number: "5", sentence: "What is your favorite color?" },
                    { number: "6", sentence: "I have two brothers." },
                    { number: "7", sentence: "She is a good student." },
                    { number: "8", sentence: "We go to school every day." },
                    { number: "9", sentence: "Can you help me, please?" },
                    { number: "10", sentence: "I love my family." }
                ],
                2: [
                    { number: "1", sentence: "I would like to order a coffee, please." },
                    { number: "2", sentence: "Could you tell me the time?" },
                    { number: "3", sentence: "What do you do for a living?" },
                    { number: "4", sentence: "I enjoy watching movies on weekends." },
                    { number: "5", sentence: "She has been studying English for three years." },
                    { number: "6", sentence: "We should meet for lunch sometime." },
                    { number: "7", sentence: "The restaurant around the corner serves great food." },
                    { number: "8", sentence: "He is planning to visit his grandparents next month." },
                    { number: "9", sentence: "I need to finish this report by Friday." },
                    { number: "10", sentence: "They are going to the beach this weekend." }
                ],
                3: [
                    { number: "1", sentence: "Despite the heavy rain, the outdoor concert continued as scheduled." },
                    { number: "2", sentence: "The company is considering several candidates for the management position." },
                    { number: "3", sentence: "She expressed her concerns about the proposed changes to the project." },
                    { number: "4", sentence: "After careful consideration, we decided to implement the new policy." },
                    { number: "5", sentence: "The research findings suggest a correlation between diet and health." },
                    { number: "6", sentence: "He emphasized the importance of maintaining a positive attitude." },
                    { number: "7", sentence: "The committee will review all applications by the end of the week." },
                    { number: "8", sentence: "We appreciate your cooperation in this matter." },
                    { number: "9", sentence: "The new regulations will take effect starting next month." },
                    { number: "10", sentence: "They conducted a comprehensive analysis of the market trends." }
                ]
            };
            
            return defaultSentences[level] || defaultSentences[1];
        }
        
        // Show status message in a specific container
        function showStatusMessage(message, type, container = document.body) {
            // Remove existing status message in this container
            const existingMessage = container.querySelector('.status-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message
            const statusMessage = document.createElement('div');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = message;
            
            // Insert into container
            container.insertBefore(statusMessage, container.firstChild);
            
            // Automatically remove after 5 seconds (error messages stay longer)
            const timeout = type === 'error' ? 8000 : 5000;
            setTimeout(() => {
                if (statusMessage.parentNode) {
                    statusMessage.remove();
                }
            }, timeout);
        }
        
        // Start practice
        function startPractice() {
            // Get student information
            const className = document.getElementById('class').value;
            const seatNo = document.getElementById('seat-no').value;
            const name = document.getElementById('name').value;
            
            // Validate input
            if (!className || !seatNo || !name) {
                showStatusMessage('Please fill in all fields', 'error');
                return;
            }
            
            // Process sentences based on source
            let sentenceArray = [];
            
            if (sentenceSource === 'manual') {
                const sentencesText = document.getElementById('sentences').value;
                sentenceArray = sentencesText.split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0)
                    .slice(0, 10); // Limit to 10 sentences
            } else {
                // Use sentences already loaded from level
                const sentencesText = document.getElementById('sentences').value;
                sentenceArray = sentencesText.split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);
            }
            
            if (sentenceArray.length === 0) {
                showStatusMessage('Please enter at least one sentence or load sentences from the bank', 'error');
                return;
            }
            
            // Save information
            studentInfo = { className, seatNo, name };
            sentences = sentenceArray;
            currentSentenceIndex = 0;
            feedbackData = [];
            recordingFailed = false;
            
            // Switch to practice page
            studentInfoPage.classList.add('hidden');
            practicePage.classList.remove('hidden');
            
            // Show first sentence
            showCurrentSentence();
            updateProgress();
        }
        
        // Show current sentence with enhanced display for sentence bank sentences
        function showCurrentSentence() {
            practiceContainer.innerHTML = '';
            
            const sentence = sentences[currentSentenceIndex];
            
            const practiceItem = document.createElement('div');
            practiceItem.className = 'practice-item';
            
            // Check if this is a sentence bank sentence (contains level info in brackets)
            const sentenceMatch = sentence.match(/^(.+?)\s*\[(\d+\/10)\s*-\s*(Level\s+\d+,\s*Sentence\s+\d+)\]$/);
            const displaySentence = sentenceMatch ? sentenceMatch[1] : sentence;
            const practiceNumber = sentenceMatch ? sentenceMatch[2] : `${currentSentenceIndex + 1}/10`;
            const sentenceInfo = sentenceMatch ? sentenceMatch[3] : null;
            
            practiceItem.innerHTML = `
                <div class="sentence-header">
                    <div class="sentence-number">Sentence ${practiceNumber}</div>
                    ${sentenceInfo ? `<div class="sentence-source">${sentenceInfo}</div>` : ''}
                </div>
                <div class="sentence-container">
                    <div class="sentence-text">${displaySentence}</div>
                    <button class="audio-btn" data-sentence="${displaySentence}" title="Listen to original">üîä</button>
                </div>
                
                <div class="recording-controls">
                    <button id="record-btn" class="btn recording-btn btn-success">üé§ Start Recording</button>
                    <div id="recording-indicator" class="hidden">
                        <span class="recording-indicator"></span> üî¥ Recording...
                    </div>
                    <div id="recording-error" class="hidden status-error" style="margin-top: 10px;">
                        ‚ùå Recording failed. Please check microphone permissions.
                    </div>
                </div>
                
                <div id="playback-section" class="hidden">
                    <p>üéß Your recording:</p>
                    <audio id="playback-audio" controls style="width: 100%; margin: 15px 0;"></audio>
                    <button id="analyze-btn" class="btn btn-success" style="margin-top: 15px;">ü§ñ Analyze Pronunciation</button>
                </div>
                
                <div id="feedback-section" class="feedback-section hidden">
                    <h3>üí° Pronunciation Feedback</h3>
                    <div id="feedback-content"></div>
                </div>
            `;
            
            practiceContainer.appendChild(practiceItem);
            
            // Set up audio playback event
            const audioBtn = practiceItem.querySelector('.audio-btn');
            audioBtn.addEventListener('click', function() {
                playSentence(this.getAttribute('data-sentence'));
            });
            
            // Set up recording button event
            const recordBtn = document.getElementById('record-btn');
            recordBtn.addEventListener('click', toggleRecording);
            
            // Set up analysis button event
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.addEventListener('click', analyzePronunciation);
        }
        
        // Play sentence audio (only the sentence, not the metadata)
        function playSentence(sentence) {
            // Stop any currently playing audio
            speechSynthesis.cancel();
            
            // Remove everything inside square brackets including the brackets
            const cleanSentence = sentence.replace(/\s*\[.*?\]/g, '').trim();
            
            // Use Web Speech API to synthesize speech
            const utterance = new SpeechSynthesisUtterance(cleanSentence);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            
            // Ensure audio is ready
            utterance.onstart = function() {
                console.log('Started playing audio:', cleanSentence);
            };
            
            utterance.onerror = function(event) {
                console.error('Audio playback error:', event);
                showStatusMessage('‚ùå Audio playback failed, please try again', 'error');
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // Toggle recording state
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }
        
        // Start recording
        async function startRecording() {
            try {
                // Reset recording state
                recordingFailed = false;
                document.getElementById('recording-error').classList.add('hidden');
                
                // Check browser support
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Your browser does not support recording');
                }
                
                showStatusMessage('üé§ Requesting microphone permission...', 'info');
                
                // Get microphone permission
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                currentStream = stream;
                hasRequestedPermission = true;
                
                // Create MediaRecorder
                const options = { 
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 128000
                };
                
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch (e) {
                    console.warn('Using default MIME type');
                    mediaRecorder = new MediaRecorder(stream);
                }
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    if (recordingFailed) return;
                    
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const playbackAudio = document.getElementById('playback-audio');
                    playbackAudio.src = audioUrl;
                    
                    // Show playback section
                    document.getElementById('playback-section').classList.remove('hidden');
                    showStatusMessage('‚úÖ Recording completed! You can now analyze your pronunciation.', 'info');
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event);
                    recordingFailed = true;
                    showStatusMessage('‚ùå An error occurred during recording', 'error');
                };
                
                mediaRecorder.start(100); // Collect data every 100ms
                isRecording = true;
                
                // Update UI
                document.getElementById('record-btn').textContent = 'üõë Stop Recording';
                document.getElementById('record-btn').classList.remove('btn-success');
                document.getElementById('record-btn').classList.add('btn-error');
                document.getElementById('recording-indicator').classList.remove('hidden');
                
                showStatusMessage('üé§ Recording started, please start speaking...', 'info');
                
            } catch (error) {
                console.error('Recording error:', error);
                recordingFailed = true;
                
                // Show recording error message
                document.getElementById('recording-error').classList.remove('hidden');
                
                if (error.name === 'NotAllowedError') {
                    showStatusMessage('‚ùå Microphone permission denied. Please allow microphone access and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showStatusMessage('‚ùå No microphone device found', 'error');
                } else if (error.name === 'NotSupportedError') {
                    showStatusMessage('‚ùå Browser does not support recording', 'error');
                } else {
                    showStatusMessage('‚ùå Recording failed: ' + error.message, 'error');
                }
                
                // Reset UI
                document.getElementById('record-btn').textContent = 'üé§ Start Recording';
                document.getElementById('record-btn').classList.remove('btn-error');
                document.getElementById('record-btn').classList.add('btn-success');
                document.getElementById('recording-indicator').classList.add('hidden');
            }
        }
        
        // Stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Stop all tracks
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                
                // Update UI
                document.getElementById('record-btn').textContent = 'üé§ Record Again';
                document.getElementById('record-btn').classList.remove('btn-error');
                document.getElementById('record-btn').classList.add('btn-success');
                document.getElementById('recording-indicator').classList.add('hidden');
            }
        }
        
        // Analyze pronunciation with improved error handling
        function analyzePronunciation() {
            const currentSentence = sentences[currentSentenceIndex];
            
            // Check if recording was successful
            const playbackAudio = document.getElementById('playback-audio');
            if (!playbackAudio.src || recordingFailed) {
                showStatusMessage('‚ùå Please record your pronunciation first or fix recording issues', 'error');
                return;
            }
            
            // Check if audio is actually recorded (not just empty)
            if (audioChunks.length === 0) {
                showStatusMessage('‚ùå No audio recorded. Please try recording again.', 'error');
                return;
            }
            
            // Simulate AI analysis process
            document.getElementById('analyze-btn').textContent = '‚è≥ Analyzing...';
            document.getElementById('analyze-btn').disabled = true;
            
            showStatusMessage('ü§ñ AI is analyzing your pronunciation...', 'info');
            
            // Simulate API call delay
            setTimeout(() => {
                try {
                    // Generate feedback based on actual recording status and sentence content
                    const feedback = generateRealisticFeedback(currentSentence, !recordingFailed);
                    
                    // Calculate score based on recording success and sentence complexity
                    const score = calculateRealisticScore(currentSentence, feedback, !recordingFailed);
                    
                    // Display feedback
                    const feedbackContent = document.getElementById('feedback-content');
                    feedbackContent.innerHTML = '';
                    
                    feedback.forEach(item => {
                        const feedbackItem = document.createElement('div');
                        feedbackItem.className = `feedback-item ${item.type === 'positive' ? 'feedback-positive' : 'feedback-improve'}`;
                        
                        const feedbackBilingual = document.createElement('div');
                        feedbackBilingual.className = 'feedback-bilingual';
                        feedbackBilingual.innerHTML = `
                            <div class="feedback-english"><strong>${item.aspect}:</strong> ${item.message}</div>
                            <div class="feedback-chinese"><strong>${item.aspect_zh}:</strong> ${item.message_zh}</div>
                        `;
                        
                        feedbackItem.appendChild(feedbackBilingual);
                        feedbackContent.appendChild(feedbackItem);
                    });
                    
                    document.getElementById('feedback-section').classList.remove('hidden');
                    document.getElementById('analyze-btn').textContent = 'ü§ñ Analyze Pronunciation';
                    document.getElementById('analyze-btn').disabled = false;
                    
                    // Save feedback data
                    feedbackData[currentSentenceIndex] = {
                        sentence: currentSentence,
                        feedback: feedback,
                        score: score,
                        recordingSuccessful: !recordingFailed
                    };
                    
                    showStatusMessage(`‚úÖ Pronunciation analysis completed! Score: ${score}/100`, 'info');
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    showStatusMessage('‚ùå Analysis failed. Please try again.', 'error');
                    document.getElementById('analyze-btn').textContent = 'ü§ñ Analyze Pronunciation';
                    document.getElementById('analyze-btn').disabled = false;
                }
                
            }, 2000);
        }
        
        // Generate realistic feedback based on recording status and sentence content
        function generateRealisticFeedback(sentence, recordingSuccessful) {
            const feedback = [];
            
            if (!recordingSuccessful) {
                // If recording failed, provide specific feedback about the issue
                feedback.push({
                    aspect: 'Recording Issue',
                    aspect_zh: 'ÈåÑÈü≥ÂïèÈ°å',
                    message: 'No usable recording was detected. Please check your microphone and try recording again.',
                    message_zh: 'Êú™Ê™¢Ê∏¨Âà∞ÂèØÁî®ÁöÑÈåÑÈü≥„ÄÇË´ãÊ™¢Êü•ÊÇ®ÁöÑÈ∫•ÂÖãÈ¢®‰∏¶ÈáçÊñ∞ÈåÑÈü≥„ÄÇ',
                    type: 'improve'
                });
                return feedback;
            }
            
            // Extract clean sentence without metadata
            const cleanSentence = sentence.replace(/\s*\[\d+\/10\s*-\s*Level\s+\d+,\s*Sentence\s+\d+\]/, '');
            
            // Analyze sentence characteristics for realistic feedback
            const words = cleanSentence.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const hasQuestion = cleanSentence.includes('?');
            const hasLongWords = words.some(word => word.length > 8);
            const hasComplexStructure = words.length > 12;
            const hasContractions = /\w+'\w+/.test(cleanSentence);
            const hasDifficultSounds = /th|sh|ch|ing\b|ed\b/.test(cleanSentence.toLowerCase());
            
            // Generate specific feedback based on sentence characteristics
            if (hasQuestion) {
                feedback.push({
                    aspect: 'Question Intonation',
                    aspect_zh: 'ÁñëÂïèÂè•Ë™ûË™ø',
                    message: 'Your question intonation needs improvement. Remember to raise your voice at the end of questions.',
                    message_zh: 'ÊÇ®ÁöÑÁñëÂïèÂè•Ë™ûË™øÈúÄË¶ÅÊîπÈÄ≤„ÄÇË´ãË®ò‰ΩèÂú®ÂïèÈ°åÁµêÂ∞æÊôÇÊèêÈ´òËÅ≤Èü≥„ÄÇ',
                    type: 'improve'
                });
            }
            
            if (hasLongWords) {
                const longWords = words.filter(word => word.length > 8);
                if (longWords.length > 0) {
                    feedback.push({
                        aspect: 'Word Pronunciation',
                        aspect_zh: 'ÂñÆË©ûÁôºÈü≥',
                        message: `Pay attention to the pronunciation of longer words. Break them into syllables for better clarity.`,
                        message_zh: `Ë´ãÊ≥®ÊÑèËºÉÈï∑ÂñÆË©ûÁöÑÁôºÈü≥„ÄÇÂ∞áÂÆÉÂÄëÂàÜËß£ÁÇ∫Èü≥ÁØÄÂèØ‰ª•ÊèêÈ´òÊ∏ÖÊô∞Â∫¶„ÄÇ`,
                        type: 'improve'
                    });
                }
            }
            
            if (hasComplexStructure) {
                feedback.push({
                    aspect: 'Sentence Flow',
                    aspect_zh: 'Âè•Â≠êÊµÅÊö¢Â∫¶',
                    message: 'For complex sentences, focus on maintaining natural rhythm and clear pauses.',
                    message_zh: 'Â∞çÊñºË§áÈõúÂè•Â≠êÔºåË´ãÊ≥®ÊÑè‰øùÊåÅËá™ÁÑ∂ÁöÑÁØÄÂ•èÂíåÊ∏ÖÊô∞ÁöÑÂÅúÈ†ì„ÄÇ',
                    type: 'improve'
                });
            }
            
            if (hasContractions) {
                feedback.push({
                    aspect: 'Natural Speech',
                    aspect_zh: 'Ëá™ÁÑ∂Ë™ûÈü≥',
                    message: 'Good use of contractions makes your speech sound more natural and fluent.',
                    message_zh: 'ÂæàÂ•ΩÂú∞‰ΩøÁî®‰∫ÜÁ∏ÆËÆÄÂΩ¢ÂºèÔºå‰ΩøÊÇ®ÁöÑË™ûÈü≥ËÅΩËµ∑‰æÜÊõ¥Ëá™ÁÑ∂ÊµÅÊö¢„ÄÇ',
                    type: 'positive'
                });
            }
            
            if (hasDifficultSounds) {
                feedback.push({
                    aspect: 'Challenging Sounds',
                    aspect_zh: 'Âõ∞Èõ£Èü≥Á¥†',
                    message: 'Pay attention to challenging English sounds. Practice them separately for better accuracy.',
                    message_zh: 'Ë´ãÊ≥®ÊÑèÂõ∞Èõ£ÁöÑËã±Ë™ûÈü≥Á¥†„ÄÇÂñÆÁç®Á∑¥ÁøíÈÄô‰∫õÈü≥Á¥†ÂèØ‰ª•ÊèêÈ´òÊ∫ñÁ¢∫ÊÄß„ÄÇ',
                    type: 'improve'
                });
            }
            
            // Always include some positive feedback
            feedback.push({
                aspect: 'Overall Effort',
                aspect_zh: 'Êï¥È´îË°®Áèæ',
                message: 'Good attempt at pronunciation. Keep practicing to improve your accuracy and fluency.',
                message_zh: 'ÁôºÈü≥ÂòóË©¶ÂæàÂ•Ω„ÄÇÁπºÁ∫åÁ∑¥Áøí‰ª•ÊèêÈ´òÊ∫ñÁ¢∫ÊÄßÂíåÊµÅÂà©Â∫¶„ÄÇ',
                type: 'positive'
            });
            
            return feedback.slice(0, 3); // Limit to 3 feedback items
        }
        
        // Calculate realistic score based on recording status and sentence complexity
        function calculateRealisticScore(sentence, feedback, recordingSuccessful) {
            if (!recordingSuccessful) {
                return 50; // Low score if recording failed
            }
            
            // Extract clean sentence without metadata
            const cleanSentence = sentence.replace(/\s*\[\d+\/10\s*-\s*Level\s+\d+,\s*Sentence\s+\d+\]/, '');
            
            // Base score based on sentence complexity
            const words = cleanSentence.split(/\s+/).length;
            const hasComplexWords = /(\w{9,})/.test(cleanSentence);
            const hasQuestion = cleanSentence.includes('?');
            
            let baseScore = 70; // Base score for average performance
            
            // Adjust for sentence complexity
            if (words > 15) baseScore -= 10;
            else if (words > 10) baseScore -= 5;
            
            if (hasComplexWords) baseScore -= 5;
            if (hasQuestion) baseScore -= 3;
            
            // Adjust based on feedback
            const positiveCount = feedback.filter(f => f.type === 'positive').length;
            const improveCount = feedback.filter(f => f.type === 'improve').length;
            
            baseScore += (positiveCount * 5);
            baseScore -= (improveCount * 4);
            
            // Ensure score is within reasonable bounds
            baseScore = Math.max(50, Math.min(90, baseScore));
            
            return Math.round(baseScore);
        }
        
        // Show previous sentence
        function showPreviousSentence() {
            if (currentSentenceIndex > 0) {
                currentSentenceIndex--;
                showCurrentSentence();
                updateProgress();
            }
        }
        
        // Show next sentence
        function showNextSentence() {
            if (currentSentenceIndex < sentences.length - 1) {
                currentSentenceIndex++;
                showCurrentSentence();
                updateProgress();
            }
        }
        
        // Update progress bar
        function updateProgress() {
            const progress = ((currentSentenceIndex + 1) / sentences.length) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        // Finish practice
        function finishPractice() {
            // Check if all sentences have feedback
            const completedSentences = feedbackData.filter(item => item !== undefined).length;
            
            if (completedSentences < sentences.length) {
                if (!confirm(`You have completed ${completedSentences}/${sentences.length} sentences. Are you sure you want to finish?`)) {
                    return;
                }
            }
            
            // Switch to report page
            practicePage.classList.add('hidden');
            reportPage.classList.remove('hidden');
            
            // Generate report
            generateReport();
        }
        
        // Generate comprehensive report
        function generateReport() {
            // Fill in student information
            document.getElementById('report-class').textContent = studentInfo.className;
            document.getElementById('report-seat-no').textContent = studentInfo.seatNo;
            document.getElementById('report-name').textContent = studentInfo.name;
            document.getElementById('report-date').textContent = new Date().toLocaleDateString('en-US');
            
            // Calculate average score
            const scores = feedbackData.filter(item => item).map(item => item.score);
            const averageScore = scores.length > 0 ? 
                Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            
            document.getElementById('overall-score').textContent = averageScore;
            
            // Generate sentence scores list
            const sentenceScoresContent = document.getElementById('sentence-scores-content');
            sentenceScoresContent.innerHTML = '';
            
            sentences.forEach((sentence, index) => {
                const feedback = feedbackData[index];
                const score = feedback ? feedback.score : 'Not analyzed';
                
                const sentenceItem = document.createElement('div');
                sentenceItem.className = 'sentence-score-item';
                
                // Extract clean sentence without metadata for display
                const cleanSentence = sentence.replace(/\s*\[\d+\/10\s*-\s*Level\s+\d+,\s*Sentence\s+\d+\]/, '');
                
                sentenceItem.innerHTML = `
                    <div><strong>Sentence ${index + 1}:</strong> ${cleanSentence}</div>
                    <div class="sentence-score">Score: ${score}/100</div>
                `;
                
                sentenceScoresContent.appendChild(sentenceItem);
            });
            
            // Generate comprehensive feedback summary
            const feedbackContent = document.getElementById('report-feedback-content');
            feedbackContent.innerHTML = '';
            
            if (feedbackData.length === 0) {
                feedbackContent.innerHTML = '<p>No pronunciation analysis completed for any sentences.</p>';
                return;
            }
            
            // Generate comprehensive bilingual feedback
            const comprehensiveFeedback = generateComprehensiveFeedback();
            
            comprehensiveFeedback.forEach(item => {
                const feedbackItem = document.createElement('div');
                feedbackItem.className = `feedback-item ${item.type === 'positive' ? 'feedback-positive' : 'feedback-improve'}`;
                
                const feedbackBilingual = document.createElement('div');
                feedbackBilingual.className = 'feedback-bilingual';
                feedbackBilingual.innerHTML = `
                    <div class="feedback-english"><strong>${item.aspect}:</strong> ${item.message}</div>
                    <div class="feedback-chinese"><strong>${item.aspect_zh}:</strong> ${item.message_zh}</div>
                `;
                
                feedbackItem.appendChild(feedbackBilingual);
                feedbackContent.appendChild(feedbackItem);
            });
        }
        
        // Generate comprehensive feedback based on all sentences
        function generateComprehensiveFeedback() {
            const comprehensiveFeedback = [];
            
            // Count successful recordings
            const successfulRecordings = feedbackData.filter(item => item && item.recordingSuccessful).length;
            const totalRecordings = feedbackData.filter(item => item).length;
            
            if (successfulRecordings === 0) {
                comprehensiveFeedback.push({
                    aspect: 'Recording Issues',
                    aspect_zh: 'ÈåÑÈü≥ÂïèÈ°å',
                    message: 'No successful recordings were made. Please check your microphone settings and try again.',
                    message_zh: 'Ê≤íÊúâÊàêÂäüÁöÑÈåÑÈü≥„ÄÇË´ãÊ™¢Êü•ÊÇ®ÁöÑÈ∫•ÂÖãÈ¢®Ë®≠ÁΩÆ‰∏¶ÈáçË©¶„ÄÇ',
                    type: 'improve'
                });
                return comprehensiveFeedback;
            }
            
            if (successfulRecordings < totalRecordings) {
                comprehensiveFeedback.push({
                    aspect: 'Recording Consistency',
                    aspect_zh: 'ÈåÑÈü≥‰∏ÄËá¥ÊÄß',
                    message: `You successfully recorded ${successfulRecordings} out of ${totalRecordings} sentences. Try to complete all recordings for better practice.`,
                    message_zh: `ÊÇ®ÊàêÂäüÈåÑË£Ω‰∫Ü${successfulRecordings}ÂÄãÂè•Â≠êÔºåÂÖ±${totalRecordings}ÂÄã„ÄÇÂòóË©¶ÂÆåÊàêÊâÄÊúâÈåÑÈü≥‰ª•Áç≤ÂæóÊõ¥Â•ΩÁöÑÁ∑¥ÁøíÊïàÊûú„ÄÇ`,
                    type: 'improve'
                });
            }
            
            // Add general advice
            comprehensiveFeedback.push({
                aspect: 'Practice Recommendation',
                aspect_zh: 'Á∑¥ÁøíÂª∫Ë≠∞',
                message: 'Continue practicing with varied sentence structures. Focus on difficult sounds and natural rhythm.',
                message_zh: 'ÁπºÁ∫åÁ∑¥Áøí‰∏çÂêåÂè•Â≠êÁµêÊßã„ÄÇÂ∞àÊ≥®ÊñºÂõ∞Èõ£Èü≥Á¥†ÂíåËá™ÁÑ∂ÁØÄÂ•è„ÄÇ',
                type: 'improve'
            });
            
            comprehensiveFeedback.push({
                aspect: 'Keep Improving',
                aspect_zh: 'ÊåÅÁ∫åÈÄ≤Ê≠•',
                message: 'Regular practice will help you improve your pronunciation and fluency over time.',
                message_zh: 'ÂÆöÊúüÁ∑¥ÁøíÂ∞áÂπ´Âä©ÊÇ®Èö®ÊôÇÈñìÊîπÂñÑÁôºÈü≥ÂíåÊµÅÂà©Â∫¶„ÄÇ',
                type: 'positive'
            });
            
            return comprehensiveFeedback;
        }
        
        // Print report
        function printReport() {
            window.print();
        }
        
        // Start new practice
        function startNewPractice() {
            // Stop and release any existing media stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // Reset all data
            studentInfo = {};
            sentences = [];
            currentSentenceIndex = 0;
            feedbackData = [];
            hasRequestedPermission = false;
            recordingFailed = false;
            
            // Clear form
            document.getElementById('class').value = '';
            document.getElementById('seat-no').value = '';
            document.getElementById('name').value = '';
            document.getElementById('sentences').value = '';
            
            // Reset to manual input
            document.querySelectorAll('.sentence-source-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.sentence-source-btn[data-source="manual"]').classList.add('active');
            sentenceSource = 'manual';
            manualInput.classList.remove('hidden');
            levelInput.classList.add('hidden');
            
            // Clear level selection
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            selectedLevel = null;
            
            // Switch to student info page
            reportPage.classList.add('hidden');
            studentInfoPage.classList.remove('hidden');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Shirley\'s AI Assistant in Speaking loaded');
        });
    </script>
</body>
</html>
