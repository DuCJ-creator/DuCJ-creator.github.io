<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿæˆç¸¾å¯è¦–åŒ–åˆ†æç³»çµ± - ç­ç´šå°æ¯”</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6572 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            border-bottom: 4px solid #3498db;
        }

        h1 {
            font-size: clamp(1.6rem, 4vw, 2.4rem);
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            opacity: 0.9;
            font-weight: 300;
        }

        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 25px;
        }

        .input-section {
            flex: 1;
            min-width: min(400px, 100%);
            padding: 25px;
            border-right: 1px solid #e9ecef;
            background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
        }

        .output-section {
            flex: 2;
            min-width: min(600px, 100%);
            padding: 25px;
            background-color: #ffffff;
        }

        .subject-input-group {
            border: 1px solid #3498db;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
        }

        .subject-input-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 600;
            font-size: clamp(1.1rem, 2.5vw, 1.3rem);
        }

        .class-input-group {
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            background-color: #fafbff;
            transition: all 0.3s ease;
        }

        .class-input-group:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .class-input-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 600;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-class-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .remove-class-btn:hover {
            background: #c0392b;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid #d1d9e6;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background-color: #f8f9ff;
        }

        textarea {
            height: 120px;
            resize: vertical;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.5;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .action-buttons button {
            flex: 1;
            padding: 16px 20px;
            border-radius: 10px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            border: none;
        }

        #addClassBtn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        #addClassBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.2);
            background: linear-gradient(135deg, #2980b9 0%, #1f6398 100%);
        }

        #generateReportBtn {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }

        #generateReportBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.2);
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }

        #printReportBtn {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
        }

        #printReportBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.2);
            background: linear-gradient(135deg, #219653 0%, #1e874b 100%);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        #noDataMessage {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px dashed #bdc3c7;
        }

        .input-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #3498db;
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #e3f2fd;
            border-radius: 6px;
        }

        .input-hint::before {
            content: "ğŸ’¡";
            font-size: 1.1rem;
        }

        .print-header {
            display: none;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #2c3e50;
        }

        .print-title {
            font-size: 28px !important;
            color: #2c3e50 !important;
            margin-bottom: 10px !important;
            font-weight: 700 !important;
        }

        .print-subtitle {
            font-size: 16px !important;
            color: #555 !important;
            margin-bottom: 5px !important;
        }

        .print-date {
            font-size: 14px !important;
            color: #777 !important;
            font-style: italic;
        }

        .print-footer {
            display: none;
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #777;
        }

        /* å ±å‘Šé é¢æ¨£å¼ - å°ˆæ¥­å­¸è¡“é¢¨æ ¼ */
        .report-body {
            background-color: white;
            color: #2c3e50;
            line-height: 1.6;
            padding: 0;
            margin: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
        }

        .report-container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            overflow: hidden;
        }

        .report-header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6572 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            border-bottom: 4px solid #3498db;
        }

        .report-content {
            padding: 30px;
        }

        .report-section {
            margin-bottom: 40px;
            padding: 25px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            page-break-inside: avoid;
        }

        .report-section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 12px;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: clamp(1.3rem, 3vw, 1.6rem);
        }

        .report-charts-row {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 35px;
        }

        .report-chart-container {
            flex: 1;
            min-width: min(300px, 100%);
            height: clamp(300px, 40vw, 350px);
            position: relative;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #fbfcff;
            padding: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        .stat-value {
            font-size: clamp(1.4rem, 3vw, 1.8rem);
            font-weight: 700;
            color: #2c3e50;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.95rem;
            color: #3498db;
            font-weight: 500;
        }

        .class-detail-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .analysis-item {
            margin: 15px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .recommendation {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .warning {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 5px solid #ff9800;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .critical {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 5px solid #f44336;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            font-size: clamp(0.9rem, 2vw, 1rem);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 12px 15px;
            text-align: center;
        }

        th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        /* å¹³æ¿è¨­å‚™æ¨£å¼ */
        @media (max-width: 1024px) {
            .content {
                flex-direction: column;
            }
            .input-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            .report-charts-row {
                flex-direction: column;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        /* æ‰‹æ©Ÿè¨­å‚™æ¨£å¼ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .content {
                padding: 15px;
            }
            
            .input-section {
                padding: 20px 15px;
            }
            
            .output-section {
                padding: 20px 15px;
            }
            
            header {
                padding: 25px 20px;
            }
            
            .report-chart-container {
                height: 280px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .analysis-item, .class-detail-section {
                padding: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            table {
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }

        /* åˆ—å°å°ˆç”¨æ¨£å¼ */
        @media print {
            body {
                background: white !important;
                color: #000 !important;
                font-size: 12pt !important;
                line-height: 1.4 !important;
                margin: 0 !important;
                padding: 15px !important;
                width: 100% !important;
            }
            
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                overflow: visible !important;
            }
            
            /* éš±è—ä¸éœ€è¦çš„å…ƒç´  */
            .input-section,
            .action-buttons,
            .remove-class-btn,
            .input-hint,
            button,
            header {
                display: none !important;
            }
            
            /* é¡¯ç¤ºåˆ—å°å°ˆç”¨å…ƒç´  */
            .print-header {
                display: block !important;
                page-break-before: always;
                margin-bottom: 25px;
                padding-bottom: 15px;
            }
            
            .print-footer {
                display: block !important;
                page-break-after: avoid;
            }
            
            /* èª¿æ•´ä½ˆå±€ */
            .content {
                display: block !important;
                padding: 0 !important;
            }
            
            .output-section {
                width: 100% !important;
                padding: 0 !important;
                border: none !important;
            }
            
            /* ç¢ºä¿åœ–è¡¨å¯åˆ—å° */
            .report-chart-container {
                height: 300px !important;
                margin: 20px 0 !important;
                page-break-inside: avoid;
                break-inside: avoid;
                border: 1px solid #ddd !important;
                background: white !important;
                box-shadow: none !important;
                padding: 15px !important;
            }
            
            canvas {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* åˆ†æå€åŸŸå„ªåŒ– */
            .report-section,
            .class-detail-section,
            .analysis-item {
                margin: 20px 0 !important;
                padding: 20px !important;
                page-break-inside: avoid;
                break-inside: avoid;
                border: 1px solid #ddd !important;
                background: white !important;
                box-shadow: none !important;
            }
            
            h2 {
                color: #2c3e50 !important;
                margin: 15px 0 10px !important;
                font-size: 16pt !important;
                border-bottom: 2px solid #2c3e50 !important;
                padding-bottom: 8px !important;
            }
            
            /* çµ±è¨ˆå¡ç‰‡åœ¨åˆ—å°æ™‚ç°¡åŒ– */
            .stats-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 15px !important;
                margin: 20px 0 !important;
            }
            
            .stat-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                padding: 15px !important;
                background: white !important;
                page-break-inside: avoid;
            }
            
            .stat-value {
                color: #2c3e50 !important;
                font-size: 16pt !important;
            }
            
            /* è¡¨æ ¼æ¨£å¼ */
            table {
                box-shadow: none !important;
                border: 1px solid #999 !important;
            }
            
            th {
                background: #f0f0f0 !important;
                color: #000 !important;
                border: 1px solid #999 !important;
            }
            
            td {
                border: 1px solid #999 !important;
                color: #000 !important;
            }
            
            /* ç¢ºä¿èƒŒæ™¯é¡è‰²åˆ—å° */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* é¿å…å…§å®¹è¢«åˆ‡æ–· */
            .report-chart-container,
            .report-section,
            .class-detail-section {
                page-break-inside: avoid !important;
            }
            
            /* æ·»åŠ é é‚Šè·æ§åˆ¶ */
            @page {
                margin: 1.5cm;
                size: A4;
            }
            
            @page :first {
                margin-top: 2cm;
            }
        }
        
        /* å±å¹•å°ˆç”¨æ¨£å¼ */
        @media screen {
            .print-header,
            .print-footer {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- åˆ—å°å°ˆç”¨æ¨™é ­ -->
        <div class="print-header">
            <h1 class="print-title">ç­ç´šæˆç¸¾å°æ¯”åˆ†æå ±å‘Š</h1>
            <div class="print-subtitle" id="printSubjectInfo">ç§‘ç›®ï¼šæœªè¼¸å…¥</div>
            <div class="print-subtitle" id="printClassCount">ç­ç´šæ•¸ï¼š0</div>
            <div class="print-date" id="printDate">å ±å‘Šæ—¥æœŸï¼šæœªç”Ÿæˆ</div>
        </div>
        
        <header>
            <h1>Shirley's å­¸ç”Ÿæˆç¸¾å¯è¦–åŒ–åˆ†æç³»çµ± - Multi Classes</h1>
            <p class="subtitle">å°ˆæ¥­å­¸è¡“ç‰ˆï½œå¤šç­ç´šæˆç¸¾å°æ¯”åˆ†æèˆ‡å¯è¦–åŒ–å ±å‘Š</p>
        </header>

        <div class="content">
            <div class="input-section">
                <form id="multiClassForm">
                    <!-- ç§‘ç›®è¼¸å…¥å€åŸŸ -->
                    <div class="subject-input-group">
                        <h3>ç§‘ç›®è³‡è¨Š</h3>
                        <div class="form-group">
                            <label for="subject">ç§‘ç›®åç¨±</label>
                            <input type="text" id="subject" placeholder="ä¾‹å¦‚ï¼šæ•¸å­¸ã€è‹±æ–‡ã€ç‰©ç†" required>
                        </div>
                        <div class="input-hint">è«‹å…ˆå¡«å¯«ç§‘ç›®åç¨±ï¼Œæ‰€æœ‰ç­ç´šå°‡ä½¿ç”¨ç›¸åŒç§‘ç›®</div>
                    </div>

                    <!-- ç­ç´šè¼¸å…¥å€åŸŸ -->
                    <div id="classInputs">
                        <!-- ç­ç´šè¼¸å…¥è¡¨å–®æœƒå‹•æ…‹æ·»åŠ è‡³æ­¤ -->
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" id="addClassBtn">å¢åŠ ç­ç´š (æœ€å¤š 5 å€‹)</button>
                        <button type="button" id="generateReportBtn">ç”Ÿæˆå°æ¯”å ±å‘Š</button>
                        <button type="button" id="printReportBtn" disabled>åˆ—å°å ±å‘Š</button>
                    </div>
                </form>
            </div>

            <div class="output-section">
                <div id="noDataMessage">
                    <h2>æ­¡è¿ä½¿ç”¨ç­ç´šæˆç¸¾å°æ¯”ç³»çµ±</h2>
                    <p>è«‹å…ˆå¡«å¯«ç§‘ç›®åç¨±ï¼Œç„¶å¾Œæ·»åŠ è‡³å°‘å…©å€‹ç­ç´šçš„å­¸ç”Ÿæ•¸æ“šã€‚</p>
                    <p style="margin-top: 15px; color: #3498db;">
                        <strong>æç¤ºï¼š</strong>å¯ä»¥ç›´æ¥å¾Excelæˆ–Google Sheetsè¤‡è£½å­¸ç”Ÿå§“åå’Œæˆç¸¾æ¬„ä½ï¼Œç³»çµ±æœƒè‡ªå‹•è§£æã€‚
                    </p>
                    <p style="margin-top: 10px; font-size: 0.9rem;">
                        æ”¯æ´æ ¼å¼ï¼šå§“åèˆ‡æˆç¸¾å¯ç”¨ç©ºæ ¼ã€Tabæˆ–é€—è™Ÿåˆ†éš”
                    </p>
                </div>
            </div>
        </div>
        
        <!-- åˆ—å°å°ˆç”¨é è…³ -->
        <div class="print-footer">
            <p>å ±å‘Šç”Ÿæˆæ™‚é–“: <span id="printTimestamp">æœªç”Ÿæˆ</span></p>
            <p>å­¸ç”Ÿæˆç¸¾åˆ†æç³»çµ± - ç­ç´šå°æ¯”ç‰ˆ Â© 2024 | ç¬¬ <span id="pageNumber">1</span> é </p>
        </div>
    </div>

    <script>
        let classData = [];
        let currentClassCount = 0;
        const MAX_CLASSES = 5;

        // é«˜ç´šå­¸è¡“é¢¨æ ¼é…è‰²æ–¹æ¡ˆï¼ˆèˆ‡å–®ç­ç´šç‰ˆæœ¬å€åˆ†ï¼‰
        const academicColors = [
            'rgba(44, 62, 80, 0.8)',    // æ·±ç°è—
            'rgba(52, 152, 219, 0.8)',  // è—è‰²
            'rgba(41, 128, 185, 0.8)',  // æ·±è—
            'rgba(39, 174, 96, 0.8)',   // ç¶ è‰²
            'rgba(142, 68, 173, 0.8)'   // ç´«è‰²
        ];

        const gradeColors = [
            'rgba(44, 62, 80, 0.8)',    // å„ªç§€
            'rgba(52, 152, 219, 0.8)',  // è‰¯å¥½
            'rgba(41, 128, 185, 0.8)',  // ä¸­ç­‰
            'rgba(39, 174, 96, 0.8)',   // åŠæ ¼
            'rgba(155, 89, 182, 0.8)'   // ä¸åŠæ ¼
        ];

        const gradeLabels = ['å„ªç§€(90-100)', 'è‰¯å¥½(80-89)', 'ä¸­ç­‰(70-79)', 'åŠæ ¼(60-69)', 'ä¸åŠæ ¼(<60)'];

        // è™•ç†å¾Excel/Sheetsè¤‡è£½çš„æ•¸æ“š
        function parseStudentData(input) {
            const students = [];
            const lines = input.trim().split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                // å˜—è©¦å¤šç¨®åˆ†éš”ç¬¦ï¼šé€—è™Ÿã€ç©ºæ ¼ã€Tab
                let parts;
                
                if (line.includes(',')) {
                    // é€—è™Ÿåˆ†éš”
                    parts = line.split(',').map(p => p.trim());
                } else if (line.includes('\t')) {
                    // Tabåˆ†éš”
                    parts = line.split('\t').map(p => p.trim());
                } else {
                    // ç©ºæ ¼åˆ†éš”ï¼ˆæ”¯æ´å¤šå€‹ç©ºæ ¼ï¼‰
                    parts = line.split(/\s+/).map(p => p.trim());
                }
                
                if (parts.length >= 2) {
                    const name = parts[0];
                    const score = parseFloat(parts[1]);
                    
                    if (name && !isNaN(score) && score >= 0 && score <= 100) {
                        students.push({ name, score });
                    }
                }
            }
            
            return students;
        }

        function addClassInput() {
            if (currentClassCount >= MAX_CLASSES) {
                alert(`æœ€å¤šåªèƒ½è¼¸å…¥ ${MAX_CLASSES} å€‹ç­ç´šã€‚`);
                return;
            }

            currentClassCount++;
            const classInputGroup = document.createElement('div');
            classInputGroup.className = 'class-input-group';
            classInputGroup.dataset.index = currentClassCount;

            classInputGroup.innerHTML = `
                <h3>ç­ç´š ${currentClassCount} è³‡è¨Š
                    ${currentClassCount > 2 ? `<button type="button" class="remove-class-btn" data-index="${currentClassCount}">ç§»é™¤</button>` : ''}
                </h3>
                <div class="form-group">
                    <label for="class-name-${currentClassCount}">ç­ç´šåç¨±</label>
                    <input type="text" id="class-name-${currentClassCount}" placeholder="ä¾‹å¦‚: é«˜ä¸€ä»ç­ã€ä¸‰å¹´ç”²ç­" required>
                </div>
                <div class="form-group">
                    <label for="student-info-${currentClassCount}">å­¸ç”Ÿè³‡è¨Š (å¯ç›´æ¥è²¼ä¸ŠExcelæ•¸æ“š)</label>
                    <textarea id="student-info-${currentClassCount}" placeholder="è«‹ç›´æ¥è²¼ä¸Šå¾Excel/Google Sheetsè¤‡è£½çš„æ•¸æ“šï¼š
å¼µä¸‰ 85
æå›› 92
ç‹äº” 78

æˆ–
å¼µä¸‰,85
æå››,92
ç‹äº”,78

æˆ–
å¼µä¸‰   85
æå››   92
ç‹äº”   78" required></textarea>
                    <div class="input-hint">æ”¯æ´æ ¼å¼ï¼šå§“åèˆ‡æˆç¸¾å¯ç”¨ç©ºæ ¼ã€Tabæˆ–é€—è™Ÿåˆ†éš”</div>
                </div>
            `;
            
            document.getElementById('classInputs').appendChild(classInputGroup);

            // æ·»åŠ ç§»é™¤æŒ‰éˆ•äº‹ä»¶ç›£è½
            const removeBtn = classInputGroup.querySelector('.remove-class-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    removeClassInput(index);
                });
            }

            if (currentClassCount >= MAX_CLASSES) {
                document.getElementById('addClassBtn').style.display = 'none';
            }

            // å•Ÿç”¨åˆ—å°æŒ‰éˆ•æª¢æŸ¥
            updatePrintButtonState();
        }

        function removeClassInput(index) {
            const element = document.querySelector(`.class-input-group[data-index="${index}"]`);
            if (element) {
                element.remove();
                currentClassCount--;
                
                // é‡æ–°ç·¨è™Ÿå‰©é¤˜çš„ç­ç´š
                const remainingGroups = document.querySelectorAll('.class-input-group');
                remainingGroups.forEach((group, i) => {
                    const newIndex = i + 1;
                    group.dataset.index = newIndex;
                    group.querySelector('h3').innerHTML = `ç­ç´š ${newIndex} è³‡è¨Š
                        ${newIndex > 2 ? `<button type="button" class="remove-class-btn" data-index="${newIndex}">ç§»é™¤</button>` : ''}`;
                    
                    // æ›´æ–°ç§»é™¤æŒ‰éˆ•çš„data-index
                    const removeBtn = group.querySelector('.remove-class-btn');
                    if (removeBtn) {
                        removeBtn.dataset.index = newIndex;
                    }
                    
                    // æ›´æ–°inputçš„id
                    const classNameInput = group.querySelector(`[id^="class-name-"]`);
                    const studentInfoInput = group.querySelector(`[id^="student-info-"]`);
                    
                    if (classNameInput) classNameInput.id = `class-name-${newIndex}`;
                    if (studentInfoInput) studentInfoInput.id = `student-info-${newIndex}`;
                });
                
                // é‡æ–°é¡¯ç¤ºå¢åŠ æŒ‰éˆ•
                document.getElementById('addClassBtn').style.display = 'block';
                
                // å•Ÿç”¨åˆ—å°æŒ‰éˆ•æª¢æŸ¥
                updatePrintButtonState();
            }
        }

        function parseClassData() {
            classData = [];
            const subject = document.getElementById('subject').value.trim();
            
            if (!subject) {
                alert('è«‹å…ˆå¡«å¯«ç§‘ç›®åç¨±ï¼');
                return null;
            }

            const inputGroups = document.querySelectorAll('.class-input-group');
            let allValid = true;

            if (inputGroups.length < 2) {
                alert('è«‹è¼¸å…¥è‡³å°‘å…©å€‹ç­ç´šçš„æ•¸æ“šï¼');
                return null;
            }

            inputGroups.forEach((group, i) => {
                const index = group.dataset.index;
                const className = document.getElementById(`class-name-${index}`).value.trim();
                const studentInfo = document.getElementById(`student-info-${index}`).value.trim();

                if (!className || !studentInfo) {
                    allValid = false;
                    alert(`è«‹å¡«å¯«ç­ç´š ${index} çš„æ‰€æœ‰ä¿¡æ¯`);
                    return;
                }

                const students = parseStudentData(studentInfo);
                
                if (students.length === 0) {
                    allValid = false;
                    alert(`ç­ç´š ${className} æ²’æœ‰æœ‰æ•ˆçš„å­¸ç”Ÿæ•¸æ“š`);
                    return;
                }

                if (allValid) {
                    classData.push({
                        className,
                        subject: subject,
                        students,
                        stats: calculateStats(students),
                        color: academicColors[i % academicColors.length]
                    });
                }
            });

            return allValid ? classData : null;
        }

        function calculateStats(students) {
            const scores = students.map(s => s.score);
            const total = scores.reduce((sum, score) => sum + score, 0);
            const average = scores.length > 0 ? total / scores.length : 0;
            const passCount = scores.filter(score => score >= 60).length;
            const passRate = scores.length > 0 ? (passCount / scores.length) * 100 : 0;
            
            const squaredDiffs = scores.map(score => Math.pow(score - average, 2));
            const avgSquaredDiff = scores.length > 0 ? squaredDiffs.reduce((sum, val) => sum + val, 0) / scores.length : 0;
            const stdDev = Math.sqrt(avgSquaredDiff);

            const gradeRanges = [
                { label: '90-100', min: 90, max: 100, count: 0, students: [] },
                { label: '80-89', min: 80, max: 89, count: 0, students: [] },
                { label: '70-79', min: 70, max: 79, count: 0, students: [] },
                { label: '60-69', min: 60, max: 69, count: 0, students: [] },
                { label: '0-59', min: 0, max: 59, count: 0, students: [] }
            ];
            
            students.forEach(student => {
                for (const range of gradeRanges) {
                    if (student.score >= range.min && student.score <= range.max) {
                        range.count++;
                        range.students.push(student);
                        break;
                    }
                }
            });

            const skewness = calculateSkewness(scores, average, stdDev);
            const kurtosis = calculateKurtosis(scores, average, stdDev);
            const normality = testNormality(scores, average, stdDev);

            // è¨ˆç®—ä¸­ä½æ•¸
            const sortedScores = [...scores].sort((a, b) => a - b);
            const median = sortedScores.length % 2 === 0 
                ? (sortedScores[sortedScores.length/2 - 1] + sortedScores[sortedScores.length/2]) / 2
                : sortedScores[Math.floor(sortedScores.length/2)];

            return {
                average: average.toFixed(1),
                median: median.toFixed(1),
                passRate: passRate.toFixed(1),
                stdDev: stdDev.toFixed(1),
                maxScore: students.length > 0 ? Math.max(...scores) : 0,
                minScore: students.length > 0 ? Math.min(...scores) : 0,
                totalStudents: students.length,
                gradeRanges: gradeRanges,
                skewness: skewness.toFixed(3),
                kurtosis: kurtosis.toFixed(3),
                normality: normality
            };
        }

        function calculateSkewness(scores, mean, stdDev) {
            if (scores.length === 0 || stdDev === 0) return 0;
            const n = scores.length;
            const sumCubedDeviations = scores.reduce((sum, score) => sum + Math.pow(score - mean, 3), 0);
            return (sumCubedDeviations / n) / Math.pow(stdDev, 3);
        }

        function calculateKurtosis(scores, mean, stdDev) {
            if (scores.length === 0 || stdDev === 0) return 0;
            const n = scores.length;
            const sumFourthDeviations = scores.reduce((sum, score) => sum + Math.pow(score - mean, 4), 0);
            return (sumFourthDeviations / n) / Math.pow(stdDev, 4) - 3;
        }

        function testNormality(scores, mean, stdDev) {
            if (scores.length < 10) return "æ•¸æ“šä¸è¶³ç„¡æ³•åˆ¤æ–·";
            const skewness = calculateSkewness(scores, mean, stdDev);
            const kurtosis = calculateKurtosis(scores, mean, stdDev);
            const isSkewnessNormal = Math.abs(skewness) < 0.5;
            const isKurtosisNormal = Math.abs(kurtosis) < 1;
            if (isSkewnessNormal && isKurtosisNormal) {
                return "æ¥è¿‘æ­£æ…‹åˆ†ä½ˆ";
            } else if (Math.abs(skewness) > 1) {
                return skewness > 0 ? "æ˜é¡¯å³å" : "æ˜é¡¯å·¦å";
            } else if (Math.abs(kurtosis) > 2) {
                return kurtosis > 0 ? "å°–å³°åˆ†ä½ˆ" : "å¹³å³°åˆ†ä½ˆ";
            } else {
                return "éæ­£æ…‹åˆ†ä½ˆ";
            }
        }

        function updatePrintButtonState() {
            const printBtn = document.getElementById('printReportBtn');
            const subject = document.getElementById('subject').value.trim();
            const classCount = document.querySelectorAll('.class-input-group').length;
            
            printBtn.disabled = !(subject && classCount >= 2);
        }

        function generateReport() {
            const data = parseClassData();
            if (!data || data.length < 2) {
                alert('è«‹è¼¸å…¥è‡³å°‘å…©å€‹ç­ç´šçš„å®Œæ•´å­¸ç”Ÿæˆç¸¾ä¿¡æ¯ï¼');
                return;
            }

            // éš±è—ç„¡æ•¸æ“šæ¶ˆæ¯ï¼Œé¡¯ç¤ºå ±å‘Šå…§å®¹
            const noDataMessage = document.getElementById('noDataMessage');
            const outputSection = document.querySelector('.output-section');
            
            noDataMessage.style.display = 'none';
            
            // ç”Ÿæˆå ±å‘Šå…§å®¹ - ä¿®å¾©IDä¸åŒ¹é…å•é¡Œ
            const overallAnalysisHTML = generateOverallAnalysis(data);
            const classComparisonHTML = generateClassComparison(data);
            const recommendationsHTML = generateRecommendations(data);
            
            const reportHTML = `
                <div class="report-section">
                    <h2>ä¸€ã€æ•´é«”åˆ†æ</h2>
                    ${overallAnalysisHTML}
                </div>
                <div class="report-section">
                    <h2>äºŒã€ç­ç´šæ©«å‘å°æ¯”</h2>
                    ${classComparisonHTML}
                </div>
                <div class="report-section">
                    <h2>ä¸‰ã€ç¶œåˆå»ºè­°</h2>
                    ${recommendationsHTML}
                </div>
            `;
            
            outputSection.innerHTML = reportHTML;
            
            // å•Ÿç”¨åˆ—å°æŒ‰éˆ•
            document.getElementById('printReportBtn').disabled = false;
            
            // æ›´æ–°åˆ—å°ä¿¡æ¯
            updatePrintInfo(data);
            
            // ç”Ÿæˆåœ–è¡¨ - ç­‰å¾…DOMæ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                generateCharts(data);
            }, 100);
        }

        function updatePrintInfo(data) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('printSubjectInfo').innerHTML = 
                `ç§‘ç›®ï¼š${data[0].subject}`;
            document.getElementById('printClassCount').innerHTML = 
                `ç­ç´šæ•¸ï¼š${data.length}å€‹`;
            document.getElementById('printDate').innerHTML = 
                `å ±å‘Šæ—¥æœŸï¼š${dateStr} ${timeStr}`;
            document.getElementById('printTimestamp').textContent = 
                `${dateStr} ${timeStr}`;
        }

        function generateCharts(data) {
            console.log('é–‹å§‹ç”Ÿæˆåœ–è¡¨ï¼Œç­ç´šæ•¸é‡:', data.length);
            
            // 1. å…¨éƒ¨å­¸ç”Ÿé¤…åœ–
            const allStudentsPieCtx = document.getElementById('allStudentsPieChart');
            if (allStudentsPieCtx) {
                console.log('ç”Ÿæˆå…¨éƒ¨å­¸ç”Ÿé¤…åœ–');
                const allStudents = data.flatMap(c => c.students);
                const gradeCounts = [0, 0, 0, 0, 0];
                allStudents.forEach(s => {
                    if (s.score >= 90) gradeCounts[0]++;
                    else if (s.score >= 80) gradeCounts[1]++;
                    else if (s.score >= 70) gradeCounts[2]++;
                    else if (s.score >= 60) gradeCounts[3]++;
                    else gradeCounts[4]++;
                });
                
                new Chart(allStudentsPieCtx, {
                    type: 'pie',
                    data: {
                        labels: gradeLabels,
                        datasets: [{
                            data: gradeCounts,
                            backgroundColor: gradeColors,
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'å…¨éƒ¨å­¸ç”Ÿæˆç¸¾ç­‰ç´šåˆ†ä½ˆ',
                                font: { size: 16, weight: '600' },
                                color: '#2c3e50'
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 12 },
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ° allStudentsPieChart canvas å…ƒç´ ');
            }

            // 2. å„ç­å¹³å‡åˆ†èˆ‡åŠæ ¼ç‡å°æ¯”åœ–
            const avgPassCtx = document.getElementById('avgPassChart');
            if (avgPassCtx) {
                console.log('ç”Ÿæˆå¹³å‡åˆ†èˆ‡åŠæ ¼ç‡å°æ¯”åœ–');
                const avgScores = data.map(c => parseFloat(c.stats.average));
                const passRates = data.map(c => parseFloat(c.stats.passRate));
                const classNames = data.map(c => c.className);
                
                new Chart(avgPassCtx, {
                    type: 'bar',
                    data: {
                        labels: classNames,
                        datasets: [
                            {
                                label: 'å¹³å‡åˆ†',
                                data: avgScores,
                                backgroundColor: data.map(c => c.color),
                                borderWidth: 1
                            },
                            {
                                label: 'åŠæ ¼ç‡ (%)',
                                data: passRates,
                                type: 'line',
                                borderColor: '#e74c3c',
                                backgroundColor: 'transparent',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'å„ç­å¹³å‡åˆ†èˆ‡åŠæ ¼ç‡å°æ¯”',
                                font: { size: 16, weight: '600' },
                                color: '#2c3e50'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'åˆ†æ•¸/ç™¾åˆ†æ¯”',
                                    color: '#2c3e50'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ° avgPassChart canvas å…ƒç´ ');
            }

            // 3. å„ç­åˆ†æ•¸æ®µå †ç–Šåœ– - ä¿®å¾©IDä¸åŒ¹é…
            const classComparisonCtx = document.getElementById('classComparisonChart');
            if (classComparisonCtx) {
                console.log('ç”Ÿæˆå„ç­åˆ†æ•¸æ®µå †ç–Šåœ–');
                const classLabels = data.map(c => c.className);
                const excellent = data.map(c => c.stats.gradeRanges[0].count);
                const good = data.map(c => c.stats.gradeRanges[1].count);
                const medium = data.map(c => c.stats.gradeRanges[2].count);
                const pass = data.map(c => c.stats.gradeRanges[3].count);
                const fail = data.map(c => c.stats.gradeRanges[4].count);

                new Chart(classComparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: classLabels,
                        datasets: [
                            { label: 'å„ªç§€(90-100)', data: excellent, backgroundColor: gradeColors[0] },
                            { label: 'è‰¯å¥½(80-89)', data: good, backgroundColor: gradeColors[1] },
                            { label: 'ä¸­ç­‰(70-79)', data: medium, backgroundColor: gradeColors[2] },
                            { label: 'åŠæ ¼(60-69)', data: pass, backgroundColor: gradeColors[3] },
                            { label: 'ä¸åŠæ ¼(<60)', data: fail, backgroundColor: gradeColors[4] }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'å„ç­åˆ†æ•¸æ®µäººæ•¸åˆ†ä½ˆ',
                                font: { size: 16, weight: '600' },
                                color: '#2c3e50'
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 12 },
                                    padding: 20
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'äººæ•¸',
                                    color: '#2c3e50'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ° classComparisonChart canvas å…ƒç´ ');
            }

            // 4. å„ç­æ¨™æº–å·®èˆ‡ååº¦å°æ¯”åœ– - ä¿®å¾©IDä¸åŒ¹é…
            const stdDevCtx = document.getElementById('stdDevChart');
            if (stdDevCtx) {
                console.log('ç”Ÿæˆæ¨™æº–å·®èˆ‡ååº¦å°æ¯”åœ–');
                const stdDevs = data.map(c => parseFloat(c.stats.stdDev));
                const skewness = data.map(c => parseFloat(c.stats.skewness));
                const classNames = data.map(c => c.className);
                
                new Chart(stdDevCtx, {
                    type: 'bar',
                    data: {
                        labels: classNames,
                        datasets: [
                            {
                                label: 'æ¨™æº–å·®',
                                data: stdDevs,
                                backgroundColor: data.map(c => c.color.replace('0.8', '0.6')),
                                borderColor: data.map(c => c.color),
                                borderWidth: 1
                            },
                            {
                                label: 'ååº¦',
                                data: skewness,
                                type: 'line',
                                borderColor: '#e67e22',
                                backgroundColor: 'transparent',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'å„ç­æˆç¸¾é›¢æ•£ç¨‹åº¦èˆ‡åˆ†ä½ˆå½¢æ…‹',
                                font: { size: 16, weight: '600' },
                                color: '#2c3e50'
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'æ•¸å€¼',
                                    color: '#2c3e50'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ° stdDevChart canvas å…ƒç´ ');
            }
        }

        function generateOverallAnalysis(data) {
            const allStudents = data.flatMap(c => c.students);
            const allScores = allStudents.map(s => s.score);
            const totalAverage = allScores.reduce((sum, score) => sum + score, 0) / allScores.length;
            const totalPassRate = (allScores.filter(score => score >= 60).length / allScores.length) * 100;
            
            const allStats = calculateStats(allStudents);
            
            let html = '<h3>1. æ•´é«”çµ±è¨ˆè¡¨</h3>';
            html += '<table>';
            html += '<tr><th>çµ±è¨ˆé …ç›®</th><th>æ•¸å€¼</th><th>èªªæ˜</th></tr>';
            html += `<tr><td>ç¸½å­¸ç”Ÿäººæ•¸</td><td>${allStudents.length}</td><td>æ‰€æœ‰ç­ç´šå­¸ç”Ÿç¸½æ•¸</td></tr>`;
            html += `<tr><td>æ•´é«”å¹³å‡åˆ†</td><td>${totalAverage.toFixed(1)}</td><td>æ‰€æœ‰å­¸ç”Ÿå¹³å‡æˆç¸¾</td></tr>`;
            html += `<tr><td>æ•´é«”åŠæ ¼ç‡</td><td>${totalPassRate.toFixed(1)}%</td><td>60åˆ†ä»¥ä¸Šå­¸ç”Ÿæ¯”ä¾‹</td></tr>`;
            html += `<tr><td>æ•´é«”æ¨™æº–å·®</td><td>${allStats.stdDev}</td><td>æˆç¸¾é›¢æ•£ç¨‹åº¦</td></tr>`;
            html += `<tr><td>æ•´é«”ååº¦</td><td>${allStats.skewness}</td><td>åˆ†ä½ˆå°ç¨±æ€§æŒ‡æ¨™</td></tr>`;
            html += `<tr><td>æ•´é«”å³°åº¦</td><td>${allStats.kurtosis}</td><td>åˆ†ä½ˆå°–éŠ³ç¨‹åº¦</td></tr>`;
            html += `<tr><td>åˆ†ä½ˆå½¢æ…‹</td><td>${allStats.normality}</td><td>æˆç¸¾åˆ†ä½ˆé¡å‹</td></tr>`;
            html += '</table>';
            
            html += '<h3 style="margin-top: 30px;">2. å„ç­ä¸»è¦æ•¸æ“šæ¦‚è¦½</h3>';
            html += '<table>';
            html += '<thead><tr><th>ç­ç´š</th><th>å¹³å‡åˆ†</th><th>ä¸­ä½æ•¸</th><th>åŠæ ¼ç‡(%)</th><th>æ¨™æº–å·®</th><th>äººæ•¸</th></tr></thead><tbody>';
            data.forEach(c => {
                html += `<tr><td>${c.className}</td><td>${c.stats.average}</td><td>${c.stats.median}</td><td>${c.stats.passRate}</td><td>${c.stats.stdDev}</td><td>${c.stats.totalStudents}</td></tr>`;
            });
            html += '</tbody></table>';
            
            html += '<h3 style="margin-top: 30px;">3. æ•´é«”è¡¨ç¾åœ–è¡¨</h3>';
            html += '<div class="report-charts-row">';
            html += '<div class="report-chart-container"><canvas id="allStudentsPieChart"></canvas></div>';
            html += '<div class="report-chart-container"><canvas id="avgPassChart"></canvas></div>';
            html += '</div>';
            html += '<div class="report-charts-row">';
            html += '<div class="report-chart-container"><canvas id="classComparisonChart"></canvas></div>';
            html += '<div class="report-chart-container"><canvas id="stdDevChart"></canvas></div>';
            html += '</div>';
            
            html += '<h3 style="margin-top: 30px;">4. æ•´é«”æˆç¸¾åˆ†æ</h3>';
            html += '<div class="analysis-item">';
            html += `<p>æ•´é«”å¹³å‡åˆ†ç‚º <strong>${totalAverage.toFixed(1)}</strong> åˆ†ï¼Œæ•´é«”åŠæ ¼ç‡ç‚º <strong>${totalPassRate.toFixed(1)}%</strong>ã€‚</p>`;
            
            if (totalAverage >= 85) {
                html += '<div class="recommendation">æ•´é«”æ•™å­¸æ•ˆæœå„ªç§€ï¼Œå­¸ç”ŸæŒæ¡ç¨‹åº¦è‰¯å¥½ã€‚</div>';
            } else if (totalAverage >= 75) {
                html += '<div class="recommendation">æ•´é«”æ•™å­¸æ•ˆæœè‰¯å¥½ï¼Œæœ‰é€²ä¸€æ­¥æå‡ç©ºé–“ã€‚</div>';
            } else if (totalAverage >= 65) {
                html += '<div class="warning">æ•´é«”æ•™å­¸æ•ˆæœä¸€èˆ¬ï¼Œéœ€è¦é—œæ³¨æ•™å­¸æ–¹æ³•çš„æ”¹é€²ã€‚</div>';
            } else {
                html += '<div class="critical">æ•´é«”æ•™å­¸æ•ˆæœä¸ä½³ï¼Œæ€¥éœ€å…¨é¢æª¢è¨æ•™å­¸ç­–ç•¥ã€‚</div>';
            }
            
            html += `<p>æˆç¸¾åˆ†ä½ˆå½¢æ…‹ï¼š${allStats.normality}ã€‚`;
            if (parseFloat(allStats.skewness) > 0.5) {
                html += 'åˆ†ä½ˆå³åï¼Œè¡¨ç¤ºé«˜åˆ†å­¸ç”Ÿè¼ƒå°‘ï¼Œå¤šæ•¸å­¸ç”Ÿé›†ä¸­åœ¨è¼ƒä½åˆ†æ•¸æ®µã€‚</p>';
            } else if (parseFloat(allStats.skewness) < -0.5) {
                html += 'åˆ†ä½ˆå·¦åï¼Œè¡¨ç¤ºä½åˆ†å­¸ç”Ÿè¼ƒå°‘ï¼Œå¤šæ•¸å­¸ç”Ÿé›†ä¸­åœ¨è¼ƒé«˜åˆ†æ•¸æ®µã€‚</p>';
            } else {
                html += 'åˆ†ä½ˆè¼ƒç‚ºå°ç¨±ï¼Œæˆç¸¾åˆ†ä½ˆç›¸å°å‡è¡¡ã€‚</p>';
            }
            html += '</div>';
            
            return html;
        }

        function generateClassComparison(data) {
            let html = '<h3>1. ç­ç´šå°æ¯”åœ–è¡¨</h3>';
            html += '<div class="report-charts-row">';
            html += '<div class="report-chart-container"><canvas id="avgPassChart"></canvas></div>';
            html += '<div class="report-chart-container"><canvas id="classComparisonChart"></canvas></div>';
            html += '</div>';
            html += '<div class="report-charts-row">';
            html += '<div class="report-chart-container"><canvas id="stdDevChart"></canvas></div>';
            html += '</div>';
            
            html += '<h3 style="margin-top: 30px;">2. å„ç­è©³ç´°åˆ†æ</h3>';
            data.forEach((classDetail, index) => {
                const { className, stats } = classDetail;
                html += `
                    <div class="class-detail-section">
                        <h4>${className} ${classDetail.subject} è©³ç´°åˆ†æ</h4>
                        <div class="stats-grid">
                            <div class="stat-card"><div class="stat-value">${stats.average}</div><div>å¹³å‡åˆ†</div></div>
                            <div class="stat-card"><div class="stat-value">${stats.median}</div><div>ä¸­ä½æ•¸</div></div>
                            <div class="stat-card"><div class="stat-value">${stats.maxScore}</div><div>æœ€é«˜åˆ†</div></div>
                            <div class="stat-card"><div class="stat-value">${stats.minScore}</div><div>æœ€ä½åˆ†</div></div>
                            <div class="stat-card"><div class="stat-value">${stats.stdDev}</div><div>æ¨™æº–å·®</div></div>
                            <div class="stat-card"><div class="stat-value">${stats.passRate}%</div><div>åŠæ ¼ç‡</div></div>
                        </div>
                        
                        <h5 style="margin-top: 20px;">åˆ†æ•¸æ®µåˆ†æ</h5>
                        <table>
                            <tr><th>åˆ†æ•¸æ®µ</th><th>äººæ•¸</th><th>æ¯”ä¾‹</th></tr>`;
                stats.gradeRanges.forEach(range => {
                    const percentage = ((range.count / stats.totalStudents) * 100).toFixed(1);
                    html += `<tr><td>${range.label}</td><td>${range.count}</td><td>${percentage}%</td></tr>`;
                });
                html += '</table>';
                
                html += '<h5 style="margin-top: 20px;">åˆ†ä½ˆå½¢æ…‹åˆ†æ</h5>';
                html += '<div class="analysis-item">';
                html += `<p><strong>ååº¦ï¼š</strong>${stats.skewness}ï¼ˆ${parseFloat(stats.skewness) > 0 ? 'å³å' : 'å·¦å'}ï¼‰</p>`;
                html += `<p><strong>å³°åº¦ï¼š</strong>${stats.kurtosis}ï¼ˆ${parseFloat(stats.kurtosis) > 0 ? 'å°–å³°' : 'å¹³å³°'}ï¼‰</p>`;
                html += `<p><strong>åˆ†ä½ˆå½¢æ…‹ï¼š</strong>${stats.normality}</p>`;
                
                if (parseFloat(stats.skewness) > 0.5) {
                    html += '<p class="warning">åˆ†ä½ˆæ˜é¡¯å³åï¼Œéœ€é—œæ³¨ä½åˆ†å­¸ç”Ÿç¾¤é«”ã€‚</p>';
                } else if (parseFloat(stats.skewness) < -0.5) {
                    html += '<p class="recommendation">åˆ†ä½ˆæ˜é¡¯å·¦åï¼Œå¤šæ•¸å­¸ç”Ÿè¡¨ç¾è‰¯å¥½ã€‚</p>';
                }
                
                if (parseFloat(stats.stdDev) > 15) {
                    html += '<p class="warning">æˆç¸¾é›¢æ•£ç¨‹åº¦è¼ƒå¤§ï¼Œå­¸ç”Ÿå€‹é«”å·®ç•°é¡¯è‘—ã€‚</p>';
                } else if (parseFloat(stats.stdDev) < 8) {
                    html += '<p class="recommendation">æˆç¸¾è¼ƒç‚ºé›†ä¸­ï¼Œå­¸ç”Ÿæ°´å¹³ç›¸å°å‡è¡¡ã€‚</p>';
                }
                html += '</div>';
            });
            
            html += '<h3 style="margin-top: 30px;">3. ç­ç´šé–“æ¯”è¼ƒåˆ†æ</h3>';
            html += '<div class="analysis-item">';
            const avgScores = data.map(c => parseFloat(c.stats.average));
            const maxAvg = Math.max(...avgScores);
            const minAvg = Math.min(...avgScores);
            const avgDiff = maxAvg - minAvg;
            
            html += `<p>å„ç­å¹³å‡åˆ†å·®è·ç‚º <strong>${avgDiff.toFixed(1)}</strong> åˆ†ã€‚</p>`;
            
            if (avgDiff > 10) {
                html += '<div class="critical">ç­ç´šé–“æ•™å­¸æ•ˆæœå·®ç•°é¡¯è‘—ï¼Œå»ºè­°æ·±å…¥åˆ†æåŸå› ä¸¦é€²è¡Œæ•™å­¸è³‡æºèª¿æ•´ã€‚</div>';
            } else if (avgDiff > 5) {
                html += '<div class="warning">ç­ç´šé–“å­˜åœ¨ä¸€å®šå·®è·ï¼Œå»ºè­°åŠ å¼·ç¶“é©—äº¤æµèˆ‡è³‡æºå…±äº«ã€‚</div>';
            } else {
                html += '<div class="recommendation">å„ç­æ•™å­¸æ•ˆæœè¼ƒç‚ºå‡è¡¡ï¼Œå€¼å¾—è‚¯å®šã€‚</div>';
            }
            
            // æ‰¾å‡ºæœ€é«˜å’Œæœ€ä½çš„ç­ç´š
            const highestClass = data.find(c => parseFloat(c.stats.average) === maxAvg);
            const lowestClass = data.find(c => parseFloat(c.stats.average) === minAvg);
            
            if (highestClass && lowestClass && highestClass !== lowestClass) {
                html += `<p>å¹³å‡åˆ†æœ€é«˜çš„ç­ç´šï¼š<strong>${highestClass.className}</strong> (${maxAvg.toFixed(1)}åˆ†)</p>`;
                html += `<p>å¹³å‡åˆ†æœ€ä½çš„ç­ç´šï¼š<strong>${lowestClass.className}</strong> (${minAvg.toFixed(1)}åˆ†)</p>`;
            }
            html += '</div>';
            
            return html;
        }

        function generateRecommendations(data) {
            const allStudents = data.flatMap(c => c.students);
            const allScores = allStudents.map(s => s.score);
            const totalAverage = allScores.reduce((sum, score) => sum + score, 0) / allScores.length;
            
            let html = '<h3>1. æ•´é«”æ•™å­¸å»ºè­°</h3>';
            
            html += '<h4>çµ¦æ•™å¸«çš„æ•™å­¸å»ºè­°</h4>';
            html += `<div class="analysis-item">`;
            if (totalAverage >= 85) {
                html += `<div class="recommendation">`;
                html += `<p><strong>æ•´é«”æ•™å­¸å“è³ªå„ªç§€</strong></p>`;
                html += `<ul>`;
                html += `<li>ä¿æŒç¾æœ‰æ•™å­¸æ–¹æ³•å’Œç¯€å¥ï¼Œæ³¨é‡çŸ¥è­˜æ·±åº¦èˆ‡å»£åº¦å¹³è¡¡</li>`;
                html += `<li>ç‚ºå„ªç§€å­¸ç”Ÿè¨­è¨ˆæ‹“å±•æ€§ä»»å‹™ï¼Œå¦‚å°ˆé¡Œç ”ç©¶ã€ç«¶è³½åŸ¹è¨“</li>`;
                html += `<li>ç¸½çµæˆåŠŸæ•™å­¸æ¡ˆä¾‹ï¼Œå½¢æˆå¯è¤‡è£½çš„æ•™å­¸æ¨¡å¼</li>`;
                html += `<li>çµ„ç¹”è·¨ç­ç´šæ•™å­¸è§€æ‘©æ´»å‹•ï¼Œåˆ†äº«å„ªç§€æ•™å­¸ç¶“é©—</li>`;
                html += `</ul>`;
                html += `</div>`;
            } else if (totalAverage >= 75) {
                html += `<div class="recommendation">`;
                html += `<p><strong>æ•´é«”æ•™å­¸å“è³ªè‰¯å¥½</strong></p>`;
                html += `<ul>`;
                html += `<li>é‡å°ä¸­ç­‰ç”Ÿè¨­è¨ˆåˆ†å±¤æ•™å­¸æ´»å‹•ï¼Œæå‡å­¸ç¿’å‹•æ©Ÿ</li>`;
                html += `<li>å»ºç«‹ä¸åŠæ ¼å­¸ç”Ÿè¿½è¹¤è¼”å°æ©Ÿåˆ¶ï¼Œæ¯é€±ä¸€æ¬¡å€‹åˆ¥åŒ–æŒ‡å°</li>`;
                html += `<li>çµ„ç¹”è·¨ç­ç´šæ•™ç ”æ´»å‹•ï¼Œå…±äº«å„ªè³ªæ•™å­¸è³‡æº</li>`;
                html += `<li>åŠ å¼·èª²å ‚äº’å‹•ï¼Œæå‡å­¸ç”Ÿåƒèˆ‡åº¦</li>`;
                html += `</ul>`;
                html += `</div>`;
            } else if (totalAverage >= 65) {
                html += `<div class="warning">`;
                html += `<p><strong>æ•´é«”æ•™å­¸å“è³ªéœ€è¦æ”¹é€²</strong></p>`;
                html += `<ul>`;
                html += `<li>é‡æ–°è©•ä¼°æ•™å­¸é€²åº¦èˆ‡é›£åº¦ï¼Œç¢ºä¿ç¬¦åˆå­¸ç”ŸèªçŸ¥æ°´å¹³</li>`;
                html += `<li>å¼·åŒ–åŸºç¤çŸ¥è­˜è¨“ç·´ï¼Œè¨­è¨ˆæ¯æ—¥åŸºç¤ç·´ç¿’</li>`;
                html += `<li>èˆ‡å®¶é•·å»ºç«‹å®šæœŸæºé€šæ©Ÿåˆ¶ï¼Œå½¢æˆå®¶æ ¡åˆåŠ›</li>`;
                html += `<li>å¢åŠ èª²å ‚ç·´ç¿’èˆ‡å³æ™‚åé¥‹ç’°ç¯€</li>`;
                html += `</ul>`;
                html += `</div>`;
            } else {
                html += `<div class="critical">`;
                html += `<p><strong>æ•´é«”æ•™å­¸å“è³ªæ€¥éœ€æå‡</strong></p>`;
                html += `<ul>`;
                html += `<li>å…¨é¢æª¢è¦–æ•™å­¸è¨ˆåŠƒèˆ‡æ–¹æ³•ï¼Œå¿…è¦æ™‚é‡æ–°è¨­è¨ˆèª²ç¨‹</li>`;
                html += `<li>å¯¦æ–½å°ç­åŒ–è¼”å°ï¼Œé‡å°åŸºç¤è–„å¼±å­¸ç”Ÿé‡é»è£œæ•‘</li>`;
                html += `<li>å»ºç«‹å­¸ç¿’å›°é›£å­¸ç”Ÿæª”æ¡ˆï¼Œåˆ¶å®šå€‹åˆ¥åŒ–å­¸ç¿’è¨ˆåŠƒ</li>`;
                html += `<li>åŠ å¼·æ•™å¸«åŸ¹è¨“ï¼Œæå‡æ•™å­¸èƒ½åŠ›èˆ‡ç­–ç•¥</li>`;
                html += `</ul>`;
                html += `</div>`;
            }
            html += `</div>`;

            html += '<h3 style="margin-top: 30px;">2. åˆ†ç­å…·é«”å»ºè­°</h3>';
            data.forEach(classDetail => {
                const avg = parseFloat(classDetail.stats.average);
                const passRate = parseFloat(classDetail.stats.passRate);
                const stdDev = parseFloat(classDetail.stats.stdDev);
                const skew = parseFloat(classDetail.stats.skewness);
                
                html += `<div class="class-detail-section">`;
                html += `<h4>${classDetail.className} å…·é«”å»ºè­°</h4>`;

                if (avg >= 85) {
                    html += `<div class="recommendation"><strong>æ•™å­¸å»ºè­°ï¼š</strong>æ•™å­¸æ•ˆæœå„ªç•°ï¼Œå»ºè­°ä¿æŒä¸¦åˆ†äº«ç¶“é©—ã€‚</div>`;
                } else if (avg >= 75) {
                    html += `<div class="recommendation"><strong>æ•™å­¸å»ºè­°ï¼š</strong>æ•™å­¸æ•ˆæœè‰¯å¥½ï¼Œå¯é‡å°è–„å¼±ç’°ç¯€å¾®èª¿ã€‚</div>`;
                } else if (avg >= 65) {
                    html += `<div class="warning"><strong>æ•™å­¸å»ºè­°ï¼š</strong>æ•™å­¸æ•ˆæœä¸€èˆ¬ï¼Œå»ºè­°åŠ å¼·åŸºç¤è¨“ç·´å’Œèª²å¾Œè¼”å°ã€‚</div>`;
                } else {
                    html += `<div class="critical"><strong>æ•™å­¸å»ºè­°ï¼š</strong>æ•™å­¸æ•ˆæœä¸ä½³ï¼Œæ€¥éœ€åˆ†æåŸå› ä¸¦æ¡å–å¹²é æªæ–½ã€‚</div>`;
                }

                html += `<div class="analysis-item"><strong>å­¸ç¿’ç­–ç•¥å»ºè­°ï¼š</strong>`;
                if (avg >= 85) {
                    html += '<ul><li>æŒ‘æˆ°æ›´é«˜é›£åº¦é¡Œå‹ï¼Œç™¼å±•é«˜éšæ€ç¶­</li>';
                    html += '<li>åƒèˆ‡å­¸ç§‘ç«¶è³½ï¼Œæ‹“å±•å­¸ç¿’è¦–é‡</li>';
                    html += '<li>å˜—è©¦è‡ªä¸»ç ”ç©¶èª²é¡Œï¼ŒåŸ¹é¤Šå‰µæ–°èƒ½åŠ›</li>';
                    html += '<li>æ“”ä»»å­¸ç¿’å°çµ„çµ„é•·ï¼Œå¹«åŠ©åŒå­¸æå‡</li></ul>';
                } else if (avg >= 75) {
                    html += '<ul><li>å¼·åŒ–è–„å¼±å–®å…ƒè¤‡ç¿’ï¼Œå»ºç«‹çŸ¥è­˜é«”ç³»</li>';
                    html += '<li>å»ºç«‹å€‹äººéŒ¯é¡Œæœ¬ï¼Œå®šæœŸå›é¡§åæ€</li>';
                    html += '<li>æ¯é€±å®Œæˆä¸€æ¬¡æ¨¡æ“¬æ¸¬é©—ï¼Œç†Ÿæ‚‰è€ƒè©¦ç¯€å¥</li>';
                    html += '<li>ä¸»å‹•å‘è€å¸«è«‹æ•™ç–‘é›£å•é¡Œ</li></ul>';
                } else if (avg >= 65) {
                    html += '<ul><li>æ¯å¤©è¤‡ç¿’ç•¶æ—¥èª²å ‚å…§å®¹ï¼ŒåŠæ™‚æ¶ˆåŒ–</li>';
                    html += '<li>ä¸»å‹•å‘è€å¸«æå•ï¼Œè§£æ±ºå­¸ç¿’å›°é›£</li>';
                    html += '<li>èˆ‡åŒå­¸çµ„æˆå­¸ç¿’å°çµ„ï¼Œäº’ç›¸å¹«åŠ©</li>';
                    html += '<li>è¨­å®šéšæ®µæ€§å­¸ç¿’ç›®æ¨™ï¼Œé€æ­¥æå‡</li></ul>';
                } else {
                    html += '<ul><li>å¾æœ€åŸºç¤æ¦‚å¿µé–‹å§‹è£œå¼·ï¼Œæ‰“å¥½æ ¹åŸº</li>';
                    html += '<li>æ¯å¤©å®ŒæˆåŸºç¤ç·´ç¿’ï¼Œå»ºç«‹å­¸ç¿’ç¿’æ…£</li>';
                    html += '<li>å°‹æ±‚è€å¸«æˆ–å®¶é•·å”åŠ©åˆ¶å®šå­¸ç¿’è¨ˆåŠƒ</li>';
                    html += '<li>åƒåŠ èª²å¾Œè¼”å°ç­ï¼Œç³»çµ±è¤‡ç¿’</li></ul>';
                }
                
                if (stdDev > 15) {
                    html += '<p class="warning">ç­å…§æˆç¸¾å·®ç•°å¤§ï¼Œå»ºè­°å¯¦æ–½åˆ†å±¤æ•™å­¸ç­–ç•¥ã€‚</p>';
                }
                if (skew > 0.5) {
                    html += '<p class="warning">ç­ç´šæ•´é«”åå¼±ï¼Œéœ€åŠ å¼·åŸºç¤æ•™å­¸èˆ‡å€‹åˆ¥è¼”å°ã€‚</p>';
                } else if (skew < -0.5) {
                    html += '<p class="recommendation">ç­ç´šæ•´é«”å„ªç§€ï¼Œå¯å˜—è©¦å‰µæ–°æ•™å­¸æ–¹æ³•ã€‚</p>';
                }
                
                if (passRate < 70) {
                    html += '<p class="critical">åŠæ ¼ç‡åä½ï¼Œéœ€é‡é»é—œæ³¨ä¸åŠæ ¼å­¸ç”Ÿç¾¤é«”ã€‚</p>';
                }
                
                html += '</div>';
                html += `</div>`;
            });

            html += '<h3 style="margin-top: 30px;">3. å¾ŒçºŒè¿½è¹¤å»ºè­°</h3>';
            html += '<div class="analysis-item">';
            html += '<ul>';
            html += '<li><strong>å®šæœŸè©•ä¼°ï¼š</strong>å»ºè­°æ¯å­¸æœŸè‡³å°‘é€²è¡Œå…©æ¬¡å…¨é¢æˆç¸¾åˆ†æ</li>';
            html += '<li><strong>æ•¸æ“šè¿½è¹¤ï¼š</strong>å»ºç«‹å­¸ç”Ÿå­¸ç¿’æˆé•·æª”æ¡ˆï¼Œè¿½è¹¤é€²æ­¥æƒ…æ³</li>';
            html += '<li><strong>æ•™å­¸æ”¹é€²ï¼š</strong>æ ¹æ“šåˆ†æçµæœï¼Œé©æ™‚èª¿æ•´æ•™å­¸ç­–ç•¥</li>';
            html += '<li><strong>è³‡æºå…±äº«ï¼š</strong>å»ºç«‹ç­éš›æ•™å­¸è³‡æºå…±äº«å¹³å°</li>';
            html += '<li><strong>æ•™å¸«åŸ¹è¨“ï¼š</strong>é‡å°è–„å¼±ç’°ç¯€é–‹å±•å°ˆé¡Œæ•™å¸«åŸ¹è¨“</li>';
            html += '</ul>';
            html += '</div>';

            return html;
        }

        function initPage() {
            // åˆå§‹æ·»åŠ å…©å€‹ç­ç´šè¼¸å…¥è¡¨å–®
            addClassInput();
            addClassInput();
            
            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            document.getElementById('addClassBtn').addEventListener('click', addClassInput);
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            document.getElementById('printReportBtn').addEventListener('click', () => window.print());
            
            // ç›£è½ç§‘ç›®è¼¸å…¥è®ŠåŒ–
            document.getElementById('subject').addEventListener('input', updatePrintButtonState);
            
            // ç›£è½ç­ç´šåç¨±å’Œå­¸ç”Ÿä¿¡æ¯è¼¸å…¥è®ŠåŒ–
            document.addEventListener('input', function(e) {
                if (e.target.id.startsWith('class-name-') || e.target.id.startsWith('student-info-')) {
                    updatePrintButtonState();
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPage);
        } else {
            initPage();
        }
    </script>
</body>
</html>
